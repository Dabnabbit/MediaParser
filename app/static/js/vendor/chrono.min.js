/**
 * Simple Date Parser (chrono-like)
 *
 * A lightweight natural language date parser for browser use.
 * Handles common date formats without requiring chrono-node.
 *
 * Supported formats:
 * - ISO: 2020-01-15, 2020/01/15
 * - Partial: Jan 2020, January 2020, 2020
 * - Natural: "yesterday", "today", "tomorrow"
 * - Relative: "last week", "next month"
 * - Month-Day-Year: 01/15/2020, 01-15-2020
 * - Day-Month-Year: 15 Jan 2020, 15/01/2020
 */
(function(global) {
    'use strict';

    const MONTHS = {
        'jan': 0, 'january': 0,
        'feb': 1, 'february': 1,
        'mar': 2, 'march': 2,
        'apr': 3, 'april': 3,
        'may': 4,
        'jun': 5, 'june': 5,
        'jul': 6, 'july': 6,
        'aug': 7, 'august': 7,
        'sep': 8, 'sept': 8, 'september': 8,
        'oct': 9, 'october': 9,
        'nov': 10, 'november': 10,
        'dec': 11, 'december': 11
    };

    function parseDate(text, refDate) {
        if (!text || typeof text !== 'string') return null;

        const input = text.trim().toLowerCase();
        const ref = refDate || new Date();

        // Try various patterns
        let result = null;

        // Pattern: Just a 4-digit year (e.g., "2020")
        if (/^\d{4}$/.test(input)) {
            result = new Date(parseInt(input), 5, 15, 12, 0, 0); // Mid-year, noon
            return result;
        }

        // Pattern: Month Year (e.g., "Jan 2020", "January 2020")
        const monthYearMatch = input.match(/^([a-z]+)\s*(\d{4})$/);
        if (monthYearMatch) {
            const month = MONTHS[monthYearMatch[1]];
            const year = parseInt(monthYearMatch[2]);
            if (month !== undefined && year >= 1900 && year <= 2100) {
                result = new Date(year, month, 15, 12, 0, 0); // Mid-month, noon
                return result;
            }
        }

        // Pattern: Year Month (e.g., "2020 Jan", "2020 January")
        const yearMonthMatch = input.match(/^(\d{4})\s*([a-z]+)$/);
        if (yearMonthMatch) {
            const year = parseInt(yearMonthMatch[1]);
            const month = MONTHS[yearMonthMatch[2]];
            if (month !== undefined && year >= 1900 && year <= 2100) {
                result = new Date(year, month, 15, 12, 0, 0);
                return result;
            }
        }

        // Pattern: Month Day Year (e.g., "Jan 15 2020", "January 15, 2020")
        const monthDayYearMatch = input.match(/^([a-z]+)\s+(\d{1,2}),?\s*(\d{4})$/);
        if (monthDayYearMatch) {
            const month = MONTHS[monthDayYearMatch[1]];
            const day = parseInt(monthDayYearMatch[2]);
            const year = parseInt(monthDayYearMatch[3]);
            if (month !== undefined && day >= 1 && day <= 31 && year >= 1900) {
                result = new Date(year, month, day, 12, 0, 0);
                return result;
            }
        }

        // Pattern: Day Month Year (e.g., "15 Jan 2020", "15 January 2020")
        const dayMonthYearMatch = input.match(/^(\d{1,2})\s+([a-z]+)\s+(\d{4})$/);
        if (dayMonthYearMatch) {
            const day = parseInt(dayMonthYearMatch[1]);
            const month = MONTHS[dayMonthYearMatch[2]];
            const year = parseInt(dayMonthYearMatch[3]);
            if (month !== undefined && day >= 1 && day <= 31 && year >= 1900) {
                result = new Date(year, month, day, 12, 0, 0);
                return result;
            }
        }

        // Pattern: ISO date (YYYY-MM-DD or YYYY/MM/DD)
        const isoMatch = input.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
        if (isoMatch) {
            const year = parseInt(isoMatch[1]);
            const month = parseInt(isoMatch[2]) - 1;
            const day = parseInt(isoMatch[3]);
            if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                result = new Date(year, month, day, 12, 0, 0);
                return result;
            }
        }

        // Pattern: MM/DD/YYYY or MM-DD-YYYY (US format)
        const usDateMatch = input.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/);
        if (usDateMatch) {
            const month = parseInt(usDateMatch[1]) - 1;
            const day = parseInt(usDateMatch[2]);
            const year = parseInt(usDateMatch[3]);
            if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                result = new Date(year, month, day, 12, 0, 0);
                return result;
            }
        }

        // Pattern: Natural language relative dates
        switch (input) {
            case 'today':
                result = new Date(ref);
                result.setHours(12, 0, 0, 0);
                return result;
            case 'yesterday':
                result = new Date(ref);
                result.setDate(result.getDate() - 1);
                result.setHours(12, 0, 0, 0);
                return result;
            case 'tomorrow':
                result = new Date(ref);
                result.setDate(result.getDate() + 1);
                result.setHours(12, 0, 0, 0);
                return result;
        }

        // Pattern: "last month", "last year"
        if (input === 'last month') {
            result = new Date(ref);
            result.setMonth(result.getMonth() - 1);
            result.setHours(12, 0, 0, 0);
            return result;
        }
        if (input === 'last year') {
            result = new Date(ref);
            result.setFullYear(result.getFullYear() - 1);
            result.setHours(12, 0, 0, 0);
            return result;
        }

        // Pattern: "X years ago"
        const yearsAgoMatch = input.match(/^(\d+)\s+years?\s+ago$/);
        if (yearsAgoMatch) {
            result = new Date(ref);
            result.setFullYear(result.getFullYear() - parseInt(yearsAgoMatch[1]));
            result.setHours(12, 0, 0, 0);
            return result;
        }

        // Fallback: Try native Date parsing
        const nativeDate = new Date(text);
        if (!isNaN(nativeDate.getTime())) {
            return nativeDate;
        }

        return null;
    }

    // Export as global chrono object (matching chrono-node API)
    global.chrono = {
        parseDate: parseDate,
        parse: function(text, refDate) {
            const date = parseDate(text, refDate);
            if (!date) return [];
            return [{
                start: { date: function() { return date; } },
                text: text
            }];
        }
    };

})(typeof window !== 'undefined' ? window : this);
