{% extends "base.html" %}

{% block title %}MediaParser - Home{% endblock %}

{% block content %}
<!-- Hidden file inputs (global) -->
<input type="file" id="file-input" multiple accept="image/*,video/*" style="display: none;">
<input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">

<!-- Main Processing Tile (unified: upload → processing → results) -->
<section id="job-section" class="section" data-section="job" data-state="idle">
    <!-- Job Header (breadcrumb left, controls right) -->
    <div class="job-header" id="job-header">
        <div class="job-header-left">
            <div class="workflow-phases" id="workflow-phases">
                <span class="phase active" data-phase="upload">Upload</span>
                <span class="phase-sep">&mdash;</span>
                <span class="phase" data-phase="process">Process</span>
                <span class="phase-sep">&mdash;</span>
                <span class="phase" data-phase="review">Review</span>
            </div>
        </div>
        <div class="job-header-right">
            <div class="job-controls" id="job-controls" style="display: none;">
                <button type="button" class="btn btn-secondary btn-sm" id="pause-btn" data-action="pause">Pause</button>
                <button type="button" class="btn btn-danger btn-sm" id="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Upload Area (visible in idle state) -->
    <div class="upload-area" id="upload-area">
        <div class="upload-box" id="upload-box" data-upload-box>
            <div class="upload-box-content">
                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p class="upload-text">Drop files or folders here</p>
                <div class="upload-buttons">
                    <button type="button" class="btn btn-primary" id="select-files-btn">Select Files</button>
                    <button type="button" class="btn btn-secondary" id="select-folder-btn">Select Folder</button>
                </div>
            </div>
        </div>

        <!-- Server path import -->
        <div class="server-import">
            <div class="input-group">
                <input type="text" id="server-path" class="form-input" placeholder="Or enter server path: /nas/photos/2024">
                <button type="button" class="btn btn-secondary" id="import-path-btn">Import</button>
            </div>
        </div>
    </div>

    <!-- Stats area (above bar) - metrics during processing, summary after completion -->
    <div class="stats-area" id="stats-area" style="display: none;">
    <div class="metrics-row" id="metrics-row" style="display: none;">
        <div class="metric">
            <span class="metric-label">Time:</span>
            <span class="metric-value" id="elapsed-time">0:00</span>
        </div>
        <div class="metric">
            <span class="metric-label">ETA:</span>
            <span class="metric-value" id="eta">-</span>
        </div>
        <div class="metric">
            <span class="metric-label">Files:</span>
            <span class="metric-value" id="files-processed">0 / 0</span>
        </div>
        <div class="metric">
            <span class="metric-label">Current:</span>
            <span class="metric-value metric-value-truncate" id="current-filename">-</span>
        </div>
        <div class="metric error-metric" id="error-metric" style="display: none;">
            <span class="metric-label">Errors:</span>
            <span class="metric-value metric-error" id="error-count">0</span>
        </div>
    </div>
    <!-- Job Summary (centered above bar, shown on completion) -->
    <div class="job-summary" id="job-summary" style="display: none;">
        <span class="summary-pill" id="summary-time-pill"><strong id="summary-time">0:00</strong></span>
        <span class="summary-pill"><strong id="summary-total">0</strong> files</span>
        <span class="summary-pill summary-pill-ok"><strong id="summary-success">0</strong> ok</span>
        <button class="filter-chip summary-chip summary-chip-failed" id="indicator-failed" data-mode="failed" style="display: none;" title="View failed files">
            <span class="chip-zone chip-zone-icon">
                <svg class="chip-icon-svg" viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                    <circle cx="8" cy="8" r="6"/>
                    <path d="M6 6l4 4M10 6l-4 4"/>
                </svg>
            </span>
            <span class="chip-zone chip-zone-info">
                <span class="chip-count" data-count="failed">0</span>
                <span class="chip-label">failed</span>
            </span>
        </button>
        <button class="filter-chip summary-chip summary-chip-discarded" id="indicator-discarded" data-mode="discarded" style="display: none;" title="View discarded files">
            <span class="chip-zone chip-zone-icon">
                <svg class="chip-icon-svg" viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 4h12"/>
                    <path d="M5.5 4V2.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5V4"/>
                    <path d="M3 4l1 10h8l1-10"/>
                </svg>
            </span>
            <span class="chip-zone chip-zone-info">
                <span class="chip-count" data-count="discards">0</span>
                <span class="chip-label">discarded</span>
            </span>
            <span class="chip-zone chip-zone-menu">
                <span class="chip-chevron">&#9662;</span>
            </span>
        </button>
    </div>
    </div><!-- /.stats-area -->

    <!-- Workflow Bar (progress → mode segments) -->
    <div class="job-progress" id="job-progress">
        <div class="progress-row">
            <div class="progress-bar progress-bar-lg" id="workflow-track">
                <!-- Layer 1: Upload fill (purple) -->
                <div class="progress-fill upload-fill" id="upload-fill"></div>
                <!-- Layer 2: Processing fill (blue, overlays upload) -->
                <div class="progress-fill processing-fill" id="processing-fill"></div>
                <!-- Layer 3: Mode segments (review phase) -->
                <div class="mode-segments" id="mode-segments">
                    <button class="mode-segment" data-mode="duplicates" title="Duplicate groups">
                        <span class="seg-icon">&#x29C9;</span>
                        <span class="seg-label">Dupes</span>
                        <span class="seg-count" data-count="duplicates">0</span>
                        <span class="seg-chevron">&#9662;</span>
                    </button>
                    <button class="mode-segment" data-mode="similar" title="Perceptually similar">
                        <span class="seg-icon">&#x2248;</span>
                        <span class="seg-label">Similar</span>
                        <span class="seg-count" data-count="similar">0</span>
                        <span class="seg-chevron">&#9662;</span>
                    </button>
                    <button class="mode-segment" data-mode="unreviewed" title="Files needing review">
                        <span class="seg-icon">&#x25CB;</span>
                        <span class="seg-label">Unreviewed</span>
                        <span class="seg-count" data-count="unreviewed">0</span>
                        <span class="seg-chevron">&#9662;</span>
                    </button>
                    <button class="mode-segment export-segment collapsed" data-mode="export" title="Export &amp; Finalize">
                        <span class="seg-icon">&#x2913;</span>
                        <span class="seg-label">Export</span>
                    </button>
                    <div class="seg-lock-overlay" id="seg-lock-overlay"></div>
                </div>
                <!-- Layer 4: Reviewed overlay (grows from left over segments) -->
                <button class="reviewed-overlay seg-empty" id="reviewed-overlay" data-mode="reviewed" title="Reviewed files">
                    <span class="seg-icon">&#x2713;</span>
                    <span class="seg-label">Reviewed</span>
                    <span class="seg-count" data-count="reviewed">0</span>
                    <span class="seg-chevron">&#9662;</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Finalize Complete Card -->
    <div class="finalize-complete" id="finalize-complete" style="display: none;">
        <div class="finalize-icon">&#x2713;</div>
        <h3>Export Complete</h3>
        <p class="finalize-stats" id="finalize-stats"></p>
        <p class="finalize-path">Output directory:<br><code id="finalize-output-path"></code></p>
        <button class="btn btn-primary" id="finalize-new-btn">New Import</button>
    </div>

    <!-- Results: Unified Grid with Filter Bar -->
    <div class="results-container" id="results-container" style="display: none;">
        <!-- Action Bar (always visible, mode-aware) -->
        <div class="action-bar" id="action-bar">
            <div class="action-bar-left">
                <div class="action-selection" id="action-selection">
                    <button class="filter-chip chip-enabled" id="ab-selection-btn">
                        <span class="chip-zone chip-zone-eye">
                            <svg class="chip-checkbox" viewBox="0 0 16 16" width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="1" width="14" height="14" rx="2"/>
                                <path class="check-mark" d="M4 8l3 3 5-6" stroke-width="2"/>
                            </svg>
                        </span>
                        <span class="chip-zone chip-zone-info">
                            <span class="chip-count" id="ab-selection-count">0 total</span>
                        </span>
                        <span class="chip-zone chip-zone-menu">
                            <span class="chip-chevron">&#9662;</span>
                        </span>
                    </button>
                    <div class="split-dropdown" id="ab-actions-dropdown">
                        <!-- Duplicates actions -->
                        <div class="action-mode-section" data-action-mode="duplicates">
                            <button class="split-dropdown-item" data-action="keep-selected">Keep Selected</button>
                            <button class="split-dropdown-item" data-action="discard-selected">Discard Selected</button>
                            <button class="split-dropdown-item" data-action="not-duplicate">Not Duplicate</button>
                            <button class="split-dropdown-item" data-action="select-group">Select Group</button>
                        </div>
                        <!-- Similar actions -->
                        <div class="action-mode-section" data-action-mode="similar">
                            <button class="split-dropdown-item" data-action="keep-selected">Keep Selected</button>
                            <button class="split-dropdown-item" data-action="discard-selected">Discard Selected</button>
                            <button class="split-dropdown-item" data-action="not-similar">Not Similar</button>
                            <button class="split-dropdown-item" data-action="select-group">Select Group</button>
                        </div>
                        <!-- Unreviewed actions -->
                        <div class="action-mode-section" data-action-mode="unreviewed">
                            <button class="split-dropdown-item" data-action="accept-review">Accept &amp; Review</button>
                            <button class="split-dropdown-item" data-action="mark-reviewed">Mark Reviewed</button>
                            <button class="split-dropdown-item" data-action="discard-selected">Discard</button>
                        </div>
                        <!-- Reviewed actions -->
                        <div class="action-mode-section" data-action-mode="reviewed">
                            <button class="split-dropdown-item" data-action="clear-review">Clear Review</button>
                            <button class="split-dropdown-item" data-action="discard-selected">Discard</button>
                        </div>
                        <!-- Discarded actions -->
                        <div class="action-mode-section" data-action-mode="discarded">
                            <button class="split-dropdown-item" data-action="restore-selected">Restore Selected</button>
                            <button class="split-dropdown-item" data-action="restore-all">Restore All</button>
                        </div>
                        <!-- Failed — no actions -->
                    </div>
                </div>
                <div class="confidence-filters" id="confidence-filters">
                    <button class="filter-chip chip-empty" data-filter="high">
                        <span class="chip-zone chip-zone-eye">
                            <svg class="chip-eye" viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z"/>
                                <circle cx="8" cy="8" r="2" fill="currentColor" stroke="none"/>
                                <line class="eye-slash" x1="2" y1="14" x2="14" y2="2"/>
                            </svg>
                        </span>
                        <span class="chip-zone chip-zone-info">
                            <span class="chip-badge confidence-high">H</span>
                            <span class="chip-count" data-count="high">0</span>
                        </span>
                        <span class="chip-zone chip-zone-menu">
                            <span class="chip-chevron">&#9662;</span>
                        </span>
                    </button>
                    <button class="filter-chip chip-empty" data-filter="medium">
                        <span class="chip-zone chip-zone-eye">
                            <svg class="chip-eye" viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z"/>
                                <circle cx="8" cy="8" r="2" fill="currentColor" stroke="none"/>
                                <line class="eye-slash" x1="2" y1="14" x2="14" y2="2"/>
                            </svg>
                        </span>
                        <span class="chip-zone chip-zone-info">
                            <span class="chip-badge confidence-medium">M</span>
                            <span class="chip-count" data-count="medium">0</span>
                        </span>
                        <span class="chip-zone chip-zone-menu">
                            <span class="chip-chevron">&#9662;</span>
                        </span>
                    </button>
                    <button class="filter-chip chip-empty" data-filter="low">
                        <span class="chip-zone chip-zone-eye">
                            <svg class="chip-eye" viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z"/>
                                <circle cx="8" cy="8" r="2" fill="currentColor" stroke="none"/>
                                <line class="eye-slash" x1="2" y1="14" x2="14" y2="2"/>
                            </svg>
                        </span>
                        <span class="chip-zone chip-zone-info">
                            <span class="chip-badge confidence-low">L</span>
                            <span class="chip-count" data-count="low">0</span>
                        </span>
                        <span class="chip-zone chip-zone-menu">
                            <span class="chip-chevron">&#9662;</span>
                        </span>
                    </button>
                </div>
            </div>
            <div class="action-bar-center">
            </div>
            <div class="action-bar-right">
                <input type="text" id="quick-tag-input" class="inline-tag-input" placeholder="Tag...">
                <button class="btn-pill btn-pill-subtle btn-pill-xs" id="add-quick-tag" title="Tag selected files">Tag</button>
                <input type="range" id="tile-size-slider" class="tile-size-slider" min="80" max="240" value="150" title="Tile size">
            </div>
        </div>

        <!-- Grid with Position Slider -->
        <div class="grid-with-slider">
            <!-- Unified Thumbnail Grid -->
            <div class="thumbnail-grid" id="unified-grid"></div>

            <!-- Position Slider (Window Scrubber) -->
            <div class="position-slider" id="position-slider" style="display: none;">
                <div class="slider-track" id="slider-track">
                    <div class="slider-thumb" id="slider-thumb"></div>
                </div>
                <div class="slider-label">
                    <span class="slider-total">of 0</span>
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div class="grid-loading" id="grid-loading" style="display: none;">
            <span class="spinner"></span> Loading files...
        </div>

        <!-- Pagination (legacy, hidden when slider active) -->
        <div class="grid-pagination" id="grid-pagination" style="display: none;"></div>
    </div>
</section>

{% endblock %}
