{% extends "base.html" %}

{% block title %}MediaParser - Home{% endblock %}

{% block content %}
<!-- Hidden file inputs (global) -->
<input type="file" id="file-input" multiple accept="image/*,video/*" style="display: none;">
<input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">

<!-- Main Processing Tile (unified: upload → processing → results) -->
<section id="job-section" class="section" data-section="job" data-state="idle">
    <!-- Job Header -->
    <div class="job-header">
        <div class="job-header-left">
            <h2 class="section-title">
                <span id="job-title">Import Media</span>
                <span class="status-badge status-badge-sm" id="job-status-badge" data-status="IDLE" style="display: none;">
                    <span id="job-status-text">IDLE</span>
                </span>
            </h2>
        </div>
        <div class="job-header-right">
            <div class="job-controls" id="job-controls" style="display: none;">
                <button type="button" class="btn btn-secondary btn-sm" id="pause-btn" data-action="pause">Pause</button>
                <button type="button" class="btn btn-danger btn-sm" id="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Upload Area (visible in idle state) -->
    <div class="upload-area" id="upload-area">
        <div class="upload-box" id="upload-box" data-upload-box>
            <div class="upload-box-content">
                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p class="upload-text">Drop files or folders here</p>
                <div class="upload-buttons">
                    <button type="button" class="btn btn-primary" id="select-files-btn">Select Files</button>
                    <button type="button" class="btn btn-secondary" id="select-folder-btn">Select Folder</button>
                </div>
            </div>
        </div>

        <!-- Server path import -->
        <div class="server-import">
            <div class="input-group">
                <input type="text" id="server-path" class="form-input" placeholder="Or enter server path: /nas/photos/2024">
                <button type="button" class="btn btn-secondary" id="import-path-btn">Import</button>
            </div>
        </div>
    </div>

    <!-- Stats area (above bar) - metrics during processing, summary after completion -->
    <div class="metrics-row" id="metrics-row" style="display: none;">
        <div class="metric">
            <span class="metric-label">Time:</span>
            <span class="metric-value" id="elapsed-time">0:00</span>
        </div>
        <div class="metric">
            <span class="metric-label">ETA:</span>
            <span class="metric-value" id="eta">-</span>
        </div>
        <div class="metric">
            <span class="metric-label">Files:</span>
            <span class="metric-value" id="files-processed">0 / 0</span>
        </div>
        <div class="metric">
            <span class="metric-label">Current:</span>
            <span class="metric-value metric-value-truncate" id="current-filename">-</span>
        </div>
        <div class="metric error-metric" id="error-metric" style="display: none;">
            <span class="metric-label">Errors:</span>
            <span class="metric-value metric-error" id="error-count">0</span>
        </div>
    </div>
    <div class="job-summary" id="job-summary" style="display: none;">
        <div class="summary-row">
            <span class="summary-item"><strong id="summary-time">0:00</strong> elapsed</span>
            <span class="summary-divider">&bull;</span>
            <span class="summary-item"><strong id="summary-total">0</strong> files</span>
            <span class="summary-divider">&bull;</span>
            <span class="summary-item summary-success"><strong id="summary-success">0</strong> successful</span>
            <!-- Side-channel indicators (clickable to filter) -->
            <span class="summary-divider summary-divider-failed" id="divider-failed" style="display: none;">&bull;</span>
            <button class="summary-item summary-indicator summary-indicator-failed" id="indicator-failed" data-mode="failed" style="display: none;" title="View failed files">
                <strong data-count="failed">0</strong> failed
            </button>
            <span class="summary-divider summary-divider-discarded" id="divider-discarded" style="display: none;">&bull;</span>
            <button class="summary-item summary-indicator summary-indicator-discarded" id="indicator-discarded" data-mode="discarded" style="display: none;" title="View discarded files">
                <strong data-count="discards">0</strong> discarded
            </button>
        </div>
    </div>

    <!-- Workflow Bar (progress → mode segments) -->
    <div class="job-progress" id="job-progress">
        <div class="progress-row">
            <div class="progress-bar progress-bar-lg" id="workflow-track">
                <!-- Layer 1: Upload fill (purple) -->
                <div class="progress-fill upload-fill" id="upload-fill"></div>
                <!-- Layer 2: Processing fill (blue, overlays upload) -->
                <div class="progress-fill processing-fill" id="processing-fill"></div>
                <!-- Layer 3: Mode segments (review phase) -->
                <div class="mode-segments" id="mode-segments">
                    <button class="mode-segment" data-mode="duplicates" title="Duplicate groups">
                        <span class="seg-icon">&#x29C9;</span>
                        <span class="seg-label">Dupes</span>
                        <span class="seg-count" data-count="duplicates">0</span>
                        <span class="seg-chevron">&#9662;</span>
                    </button>
                    <button class="mode-segment" data-mode="similar" title="Perceptually similar">
                        <span class="seg-icon">&#x2248;</span>
                        <span class="seg-label">Similar</span>
                        <span class="seg-count" data-count="similar">0</span>
                        <span class="seg-chevron">&#9662;</span>
                    </button>
                    <button class="mode-segment" data-mode="unreviewed" title="Files needing review">
                        <span class="seg-icon">&#x25CB;</span>
                        <span class="seg-label">Unreviewed</span>
                        <span class="seg-count" data-count="unreviewed">0</span>
                        <span class="seg-chevron">&#9662;</span>
                    </button>
                    <button class="mode-segment export-segment collapsed" data-mode="export" title="Export &amp; Finalize">
                        <span class="seg-icon">&#x2913;</span>
                        <span class="seg-label">Export</span>
                    </button>
                    <div class="seg-lock-overlay" id="seg-lock-overlay"></div>
                </div>
                <!-- Layer 4: Reviewed overlay (grows from left over segments) -->
                <button class="reviewed-overlay seg-empty" id="reviewed-overlay" data-mode="reviewed" title="Reviewed files">
                    <span class="seg-icon">&#x2713;</span>
                    <span class="seg-label">Reviewed</span>
                    <span class="seg-count" data-count="reviewed">0</span>
                </button>
            </div>
            <span class="progress-text" id="job-progress-text">0%</span>
        </div>

        <!-- Phase breadcrumb -->
        <div class="workflow-phases" id="workflow-phases">
            <span class="phase active" data-phase="upload">Upload</span>
            <span class="phase-sep">&mdash;</span>
            <span class="phase" data-phase="process">Process</span>
            <span class="phase-sep">&mdash;</span>
            <span class="phase" data-phase="review">Review</span>
        </div>
    </div>

    <!-- Finalize Complete Card -->
    <div class="finalize-complete" id="finalize-complete" style="display: none;">
        <div class="finalize-icon">&#x2713;</div>
        <h3>Export Complete</h3>
        <p class="finalize-stats" id="finalize-stats"></p>
        <p class="finalize-path">Output directory:<br><code id="finalize-output-path"></code></p>
        <button class="btn btn-primary" id="finalize-new-btn">New Import</button>
    </div>

    <!-- Results: Unified Grid with Filter Bar -->
    <div class="results-container" id="results-container" style="display: none;">
        <!-- Action Bar (always visible, mode-aware) -->
        <div class="action-bar" id="action-bar">
            <div class="action-bar-left">
                <span class="action-bar-count" id="selection-count">0 selected</span>
            </div>
            <div class="action-bar-center">
                <!-- Duplicates mode actions -->
                <div class="action-group" data-action-mode="duplicates" style="display: none;">
                    <div class="split-btn">
                        <button class="btn-pill btn-pill-primary" id="ab-keep-selected" disabled title="Keep selected, discard others in group">Keep Selected</button>
                        <button class="btn-pill btn-pill-primary split-caret" id="ab-keep-caret" disabled title="More actions">&#9662;</button>
                        <div class="split-dropdown" id="ab-keep-dropdown">
                            <button class="split-dropdown-item" data-action="discard-selected">Discard Selected</button>
                            <button class="split-dropdown-item" data-action="not-duplicate">Not Duplicate</button>
                            <button class="split-dropdown-item" data-action="select-group">Select Group</button>
                        </div>
                    </div>
                </div>
                <!-- Similar mode actions -->
                <div class="action-group" data-action-mode="similar" style="display: none;">
                    <div class="split-btn">
                        <button class="btn-pill btn-pill-primary" id="ab-similar-keep" disabled title="Keep selected, discard others in group">Keep Selected</button>
                        <button class="btn-pill btn-pill-primary split-caret" id="ab-similar-caret" disabled title="More actions">&#9662;</button>
                        <div class="split-dropdown" id="ab-similar-dropdown">
                            <button class="split-dropdown-item" data-action="discard-selected">Discard Selected</button>
                            <button class="split-dropdown-item" data-action="not-similar">Not Similar</button>
                            <button class="split-dropdown-item" data-action="select-group">Select Group</button>
                        </div>
                    </div>
                </div>
                <!-- Unreviewed mode actions -->
                <div class="action-group" data-action-mode="unreviewed" style="display: none;">
                    <div class="split-btn">
                        <button class="btn-pill btn-pill-success" id="ab-accept-review" disabled title="Accept detected timestamp and mark as reviewed">Accept &amp; Review</button>
                        <button class="btn-pill btn-pill-success split-caret" id="ab-accept-caret" disabled title="More actions">&#9662;</button>
                        <div class="split-dropdown" id="ab-accept-dropdown">
                            <button class="split-dropdown-item" data-action="mark-reviewed">Mark Reviewed</button>
                            <button class="split-dropdown-item" data-action="discard-selected">Discard</button>
                        </div>
                    </div>
                </div>
                <!-- Reviewed mode actions -->
                <div class="action-group" data-action-mode="reviewed" style="display: none;">
                    <button class="btn-pill btn-pill-secondary" id="ab-clear-review" disabled title="Clear review status">Clear Review</button>
                    <button class="btn-pill btn-pill-danger" id="ab-reviewed-discard" disabled title="Discard selected files">Discard</button>
                </div>
                <!-- Discarded mode actions -->
                <div class="action-group" data-action-mode="discarded" style="display: none;">
                    <button class="btn-pill btn-pill-success" id="ab-restore" disabled title="Restore selected files">Restore</button>
                </div>
            </div>
            <div class="action-bar-right">
                <button class="btn-pill btn-pill-subtle action-overflow-trigger" id="action-overflow-trigger" title="More actions">&#8943;</button>
                <div class="action-overflow-menu" id="action-overflow-menu">
                    <button class="action-overflow-item" data-action="select-all">Select All</button>
                    <button class="action-overflow-item" data-action="examine">
                        <span id="examine-btn-label">Examine</span>
                    </button>
                    <div class="action-overflow-divider"></div>
                    <div class="action-overflow-tag">
                        <input type="text" id="quick-tag-input" class="action-overflow-tag-input" placeholder="Add tag...">
                        <button class="btn-pill btn-pill-subtle btn-pill-xs" id="add-quick-tag">Tag</button>
                    </div>
                    <div class="action-overflow-divider"></div>
                    <button class="action-overflow-item" data-action="clear-selection">Clear Selection</button>
                </div>
            </div>
        </div>

        <!-- Filter Bar (single row: confidence chips, tile size) -->
        <div class="filter-bar" id="filter-bar">
            <div class="filter-chips">
                <div class="confidence-filters" id="confidence-filters">
                    <button class="filter-chip active" data-filter="high">
                        <span class="chip-badge confidence-high">H</span>
                        <span class="chip-count" data-count="high">0</span>
                    </button>
                    <button class="filter-chip active" data-filter="medium">
                        <span class="chip-badge confidence-medium">M</span>
                        <span class="chip-count" data-count="medium">0</span>
                    </button>
                    <button class="filter-chip active" data-filter="low">
                        <span class="chip-badge confidence-low">L</span>
                        <span class="chip-count" data-count="low">0</span>
                    </button>
                </div>
            </div>
            <div class="filter-actions">
                <input type="range" id="tile-size-slider" class="tile-size-slider" min="80" max="240" value="150" title="Tile size">
            </div>
        </div>

        <!-- Grid with Position Slider -->
        <div class="grid-with-slider">
            <!-- Unified Thumbnail Grid -->
            <div class="thumbnail-grid" id="unified-grid"></div>

            <!-- Position Slider (Window Scrubber) -->
            <div class="position-slider" id="position-slider" style="display: none;">
                <div class="slider-track" id="slider-track">
                    <div class="slider-thumb" id="slider-thumb"></div>
                </div>
                <div class="slider-label">
                    <span class="slider-total">of 0</span>
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div class="grid-loading" id="grid-loading" style="display: none;">
            <span class="spinner"></span> Loading files...
        </div>

        <!-- Pagination (legacy, hidden when slider active) -->
        <div class="grid-pagination" id="grid-pagination" style="display: none;"></div>
    </div>
</section>

{% endblock %}
