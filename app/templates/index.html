{% extends "base.html" %}

{% block title %}MediaParser - Home{% endblock %}

{% block content %}
<!-- Hidden file inputs (global) -->
<input type="file" id="file-input" multiple accept="image/*,video/*" style="display: none;">
<input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">

<!-- Settings Section (compact, above main tile) -->
<section id="settings-section" class="section section-compact settings-section" data-section="settings">
    <div class="settings-header" id="settings-header">
        <div class="settings-title">
            <svg class="settings-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <h2 class="section-title-sm">Settings</h2>
        </div>
        <button type="button" class="settings-toggle" id="settings-toggle" aria-expanded="false">
            <span class="settings-toggle-icon">▼</span>
        </button>
    </div>

    <div class="settings-panel" id="settings-panel" style="display: none;">
        <div class="settings-form">
            <div class="settings-row">
                <div class="form-group form-group-sm">
                    <label for="theme-select" class="form-label">Theme</label>
                    <select id="theme-select" class="form-input form-select-sm">
                        <option value="system">System</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="form-group form-group-sm form-group-grow">
                    <label for="output-directory" class="form-label">Output Directory</label>
                    <div class="input-group input-group-sm">
                        <input type="text" id="output-directory" class="form-input" placeholder="/path/to/output">
                        <button type="button" class="btn btn-secondary btn-sm" id="reset-output-dir-btn" title="Reset">↺</button>
                    </div>
                </div>
            </div>
            <div class="form-actions-inline">
                <button type="button" class="btn btn-primary btn-sm" id="save-settings-btn">Save</button>
                <span class="settings-status" id="settings-status"></span>
            </div>
            <div class="settings-error" id="settings-error" style="display: none;">
                <span id="settings-error-text"></span>
            </div>
        </div>

        <!-- Debug Section (only shown in debug mode) -->
        <div class="debug-section" id="debug-section" style="display: none;">
            <div class="debug-header">
                <span class="debug-title">Debug Tools</span>
                <span class="debug-warning">Development Only</span>
            </div>
            <div class="debug-info">
                <div class="debug-stat">
                    <span class="debug-label">Database:</span>
                    <span class="debug-value" id="db-size">-</span>
                </div>
                <div class="debug-stat">
                    <span class="debug-label">Tables:</span>
                    <span class="debug-value" id="db-tables">-</span>
                </div>
                <div class="debug-stat">
                    <span class="debug-label">Storage:</span>
                    <span class="debug-value" id="storage-size">-</span>
                </div>
            </div>
            <div class="debug-toggles">
                <label class="debug-toggle-label">
                    <input type="checkbox" id="strict-workflow-toggle">
                    <span>Strict workflow progression</span>
                    <span class="debug-toggle-hint">Lock stages until prior ones are resolved</span>
                </label>
            </div>
            <div class="debug-actions">
                <button type="button" class="btn btn-secondary btn-sm" id="clear-db-btn">Clear Database</button>
                <button type="button" class="btn btn-secondary btn-sm" id="clear-storage-btn">Clear Storage</button>
                <button type="button" class="btn btn-danger btn-sm" id="clear-all-btn">Clear All</button>
            </div>
        </div>
    </div>
</section>

<!-- Main Processing Tile (unified: upload → processing → results) -->
<section id="job-section" class="section" data-section="job" data-state="idle">
    <!-- Job Header -->
    <div class="job-header">
        <div class="job-header-left">
            <h2 class="section-title">
                <span id="job-title">Import Media</span>
                <span class="status-badge status-badge-sm" id="job-status-badge" data-status="IDLE" style="display: none;">
                    <span id="job-status-text">IDLE</span>
                </span>
            </h2>
        </div>
        <div class="job-header-right">
            <div class="job-controls" id="job-controls" style="display: none;">
                <button type="button" class="btn btn-secondary btn-sm" id="pause-btn" data-action="pause">Pause</button>
                <button type="button" class="btn btn-danger btn-sm" id="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Upload Area (visible in idle state) -->
    <div class="upload-area" id="upload-area">
        <div class="upload-box" id="upload-box" data-upload-box>
            <div class="upload-box-content">
                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p class="upload-text">Drop files or folders here</p>
                <div class="upload-buttons">
                    <button type="button" class="btn btn-primary" id="select-files-btn">Select Files</button>
                    <button type="button" class="btn btn-secondary" id="select-folder-btn">Select Folder</button>
                </div>
            </div>
        </div>

        <!-- Server path import -->
        <div class="server-import">
            <div class="input-group">
                <input type="text" id="server-path" class="form-input" placeholder="Or enter server path: /nas/photos/2024">
                <button type="button" class="btn btn-secondary" id="import-path-btn">Import</button>
            </div>
        </div>
    </div>

    <!-- Stats area (above bar) - metrics during processing, summary after completion -->
    <div class="metrics-row" id="metrics-row" style="display: none;">
        <div class="metric">
            <span class="metric-label">Files:</span>
            <span class="metric-value" id="files-processed">0 / 0</span>
        </div>
        <div class="metric">
            <span class="metric-label">Current:</span>
            <span class="metric-value metric-value-truncate" id="current-filename">-</span>
        </div>
        <div class="metric">
            <span class="metric-label">Time:</span>
            <span class="metric-value" id="elapsed-time">0:00</span>
        </div>
        <div class="metric">
            <span class="metric-label">ETA:</span>
            <span class="metric-value" id="eta">-</span>
        </div>
        <div class="metric error-metric" id="error-metric" style="display: none;">
            <span class="metric-label">Errors:</span>
            <span class="metric-value metric-error" id="error-count">0</span>
        </div>
    </div>
    <div class="job-summary" id="job-summary" style="display: none;">
        <div class="summary-row">
            <span class="summary-item"><strong id="summary-total">0</strong> files</span>
            <span class="summary-divider">•</span>
            <span class="summary-item summary-success"><strong id="summary-success">0</strong> successful</span>
            <span class="summary-divider">•</span>
            <span class="summary-item"><strong id="summary-time">0:00</strong> elapsed</span>
            <!-- Side-channel indicators (not workflow stages) -->
            <button class="summary-indicator summary-indicator-discarded" id="indicator-discarded" data-mode="discarded" style="display: none;" title="View discarded files">
                <span class="seg-icon">&#x2715;</span> <strong data-count="discards">0</strong> discarded
            </button>
            <button class="summary-indicator summary-indicator-failed" id="indicator-failed" data-mode="failed" style="display: none;" title="View failed files">
                <span class="seg-icon">!</span> <strong data-count="failed">0</strong> failed
            </button>
        </div>
    </div>

    <!-- Workflow Bar (progress → mode segments) -->
    <div class="job-progress" id="job-progress">
        <div class="progress-row">
            <div class="progress-bar progress-bar-lg" id="workflow-track">
                <!-- Layer 1: Upload fill (purple) -->
                <div class="progress-fill upload-fill" id="upload-fill"></div>
                <!-- Layer 2: Processing fill (blue, overlays upload) -->
                <div class="progress-fill processing-fill" id="processing-fill"></div>
                <!-- Layer 3: Mode segments (review phase) -->
                <div class="mode-segments" id="mode-segments">
                    <button class="mode-segment" data-mode="duplicates" title="Duplicate groups">
                        <span class="seg-icon">&#x29C9;</span>
                        <span class="seg-label">Dupes</span>
                        <span class="seg-count" data-count="duplicates">0</span>
                    </button>
                    <button class="mode-segment" data-mode="similar" title="Perceptually similar">
                        <span class="seg-icon">&#x2248;</span>
                        <span class="seg-label">Similar</span>
                        <span class="seg-count" data-count="similar">0</span>
                    </button>
                    <button class="mode-segment" data-mode="unreviewed" title="Files needing review">
                        <span class="seg-icon">&#x25CB;</span>
                        <span class="seg-label">Unreviewed</span>
                        <span class="seg-count" data-count="unreviewed">0</span>
                    </button>
                    <button class="mode-segment export-segment collapsed" data-mode="export" title="Export &amp; Finalize">
                        <span class="seg-icon">&#x2913;</span>
                        <span class="seg-label">Export</span>
                    </button>
                </div>
                <!-- Layer 4: Reviewed overlay (grows from left over segments) -->
                <button class="reviewed-overlay seg-empty" id="reviewed-overlay" data-mode="reviewed" title="Reviewed files">
                    <span class="seg-icon">&#x2713;</span>
                    <span class="seg-label">Reviewed</span>
                    <span class="seg-count" data-count="reviewed">0</span>
                </button>
            </div>
            <span class="progress-text" id="job-progress-text">0%</span>
        </div>

        <!-- Phase breadcrumb -->
        <div class="workflow-phases" id="workflow-phases">
            <span class="phase active" data-phase="upload">Upload</span>
            <span class="phase-sep">&mdash;</span>
            <span class="phase" data-phase="process">Process</span>
            <span class="phase-sep">&mdash;</span>
            <span class="phase" data-phase="review">Review</span>
        </div>
    </div>

    <!-- Finalize Complete Card -->
    <div class="finalize-complete" id="finalize-complete" style="display: none;">
        <div class="finalize-icon">&#x2713;</div>
        <h3>Export Complete</h3>
        <p class="finalize-stats" id="finalize-stats"></p>
        <p class="finalize-path">Output directory:<br><code id="finalize-output-path"></code></p>
        <button class="btn btn-primary" id="finalize-new-btn">New Import</button>
    </div>

    <!-- Results: Unified Grid with Filter Bar -->
    <div class="results-container" id="results-container" style="display: none;">
        <!-- Selection Toolbar (appears when files selected) -->
        <div class="selection-toolbar" id="selection-toolbar" style="display: none;">
            <div class="selection-info">
                <span id="selection-count">0 files selected</span>
            </div>
            <div class="selection-actions">
                <!-- Review actions -->
                <button class="btn btn-success btn-sm" id="accept-review-selected" title="Accept detected timestamp and mark as reviewed">
                    Accept & Review
                </button>
                <button class="btn btn-secondary btn-sm" id="mark-reviewed-selected" title="Mark as reviewed without changing timestamp">
                    Mark Reviewed
                </button>
                <div class="selection-divider"></div>
                <!-- Examine/Compare button -->
                <button class="btn btn-primary btn-sm" id="examine-selected" title="Open examination view (Enter)">
                    <span id="examine-btn-label">Examine</span>
                </button>
                <div class="selection-divider"></div>
                <!-- Tag quick-add -->
                <div class="tag-quick-add">
                    <input type="text" id="quick-tag-input" class="form-input form-input-sm" placeholder="Add tag...">
                    <button class="btn btn-primary btn-sm" id="add-quick-tag">Tag</button>
                </div>
                <!-- Duplicate group actions (shown only when duplicates selected) -->
                <button class="btn btn-secondary btn-sm" id="select-group" style="display: none;" title="Select all files in this duplicate group">
                    Select Group
                </button>
                <button class="btn btn-secondary btn-sm" id="not-duplicate" style="display: none;" title="Remove from duplicate group">
                    Not Duplicate
                </button>
                <button class="btn btn-success btn-sm" id="select-best" style="display: none;" title="Keep selected, discard others in group">
                    Keep Selected
                </button>
                <button class="btn btn-danger btn-sm" id="discard-selected" title="Discard selected files from output">
                    Discard
                </button>
                <button class="btn btn-secondary btn-sm" id="clear-selection">
                    Clear
                </button>
            </div>
        </div>

        <!-- Filter Bar (single row: confidence chips, bulk actions, tile size) -->
        <div class="filter-bar" id="filter-bar">
            <div class="filter-chips">
                <div class="confidence-filters" id="confidence-filters">
                    <button class="filter-chip active" data-filter="high">
                        <span class="chip-badge confidence-high">H</span>
                        <span class="chip-count" data-count="high">0</span>
                    </button>
                    <button class="filter-chip active" data-filter="medium">
                        <span class="chip-badge confidence-medium">M</span>
                        <span class="chip-count" data-count="medium">0</span>
                    </button>
                    <button class="filter-chip active" data-filter="low">
                        <span class="chip-badge confidence-low">L</span>
                        <span class="chip-count" data-count="low">0</span>
                    </button>
                </div>
            </div>
            <div class="filter-actions">
                <div class="bulk-actions-dropdown" id="bulk-actions-dropdown">
                    <button class="btn btn-secondary btn-sm bulk-actions-trigger" id="bulk-actions-trigger">
                        Bulk Actions ▾
                    </button>
                    <div class="bulk-actions-menu" id="bulk-actions-menu">
                        <div class="bulk-menu-section">
                            <div class="bulk-menu-header">Current Filter (<span id="bulk-filtered-count">0</span> files)</div>
                            <button class="bulk-menu-item" data-action="accept_review" data-scope="filtered">
                                <span class="bulk-item-icon">✓</span> Accept & Review All
                            </button>
                            <button class="bulk-menu-item" data-action="mark_reviewed" data-scope="filtered">
                                <span class="bulk-item-icon">☑</span> Mark All Reviewed
                            </button>
                            <button class="bulk-menu-item" data-action="clear_review" data-scope="filtered">
                                <span class="bulk-item-icon">↺</span> Clear All Reviews
                            </button>
                        </div>
                        <div class="bulk-menu-divider"></div>
                        <div class="bulk-menu-section">
                            <div class="bulk-menu-header">By Confidence</div>
                            <button class="bulk-menu-item" data-action="accept_review" data-scope="confidence" data-level="high">
                                <span class="chip-badge confidence-high">H</span> Accept All HIGH (<span data-bulk-count="high">0</span>)
                            </button>
                            <button class="bulk-menu-item" data-action="accept_review" data-scope="confidence" data-level="medium">
                                <span class="chip-badge confidence-medium">M</span> Accept All MEDIUM (<span data-bulk-count="medium">0</span>)
                            </button>
                            <button class="bulk-menu-item" data-action="accept_review" data-scope="confidence" data-level="low">
                                <span class="chip-badge confidence-low">L</span> Accept All LOW (<span data-bulk-count="low">0</span>)
                            </button>
                            <button class="bulk-menu-item" data-action="mark_reviewed" data-scope="confidence" data-level="none">
                                <span class="chip-badge confidence-none">-</span> Mark All NONE Reviewed (<span data-bulk-count="none">0</span>)
                            </button>
                        </div>
                    </div>
                </div>
                <span class="filter-divider"></span>
                <input type="range" id="tile-size-slider" class="tile-size-slider" min="80" max="240" value="150" title="Tile size">
            </div>
        </div>

        <!-- Grid with Position Slider -->
        <div class="grid-with-slider">
            <!-- Unified Thumbnail Grid -->
            <div class="thumbnail-grid" id="unified-grid"></div>

            <!-- Position Slider (Window Scrubber) -->
            <div class="position-slider" id="position-slider" style="display: none;">
                <div class="slider-track" id="slider-track">
                    <div class="slider-thumb" id="slider-thumb"></div>
                </div>
                <div class="slider-label">
                    <span class="slider-total">of 0</span>
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div class="grid-loading" id="grid-loading" style="display: none;">
            <span class="spinner"></span> Loading files...
        </div>

        <!-- Pagination (legacy, hidden when slider active) -->
        <div class="grid-pagination" id="grid-pagination" style="display: none;"></div>
    </div>
</section>

{% endblock %}
