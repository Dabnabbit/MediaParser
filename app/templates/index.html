{% extends "base.html" %}

{% block title %}MediaParser - Home{% endblock %}

{% block content %}
<!-- Hidden file inputs (global) -->
<input type="file" id="file-input" multiple accept="image/*,video/*" style="display: none;">
<input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">

<!-- Settings Section (compact, above main tile) -->
<section id="settings-section" class="section section-compact settings-section" data-section="settings">
    <div class="settings-header" id="settings-header">
        <div class="settings-title">
            <svg class="settings-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <h2 class="section-title-sm">Settings</h2>
        </div>
        <button type="button" class="settings-toggle" id="settings-toggle" aria-expanded="false">
            <span class="settings-toggle-icon">▼</span>
        </button>
    </div>

    <div class="settings-panel" id="settings-panel" style="display: none;">
        <div class="settings-form">
            <div class="form-group form-group-sm">
                <label for="output-directory" class="form-label">Output Directory</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="output-directory" class="form-input" placeholder="/path/to/output">
                    <button type="button" class="btn btn-secondary btn-sm" id="reset-output-dir-btn" title="Reset">↺</button>
                </div>
            </div>
            <div class="form-actions-inline">
                <button type="button" class="btn btn-primary btn-sm" id="save-settings-btn">Save</button>
                <span class="settings-status" id="settings-status"></span>
            </div>
            <div class="settings-error" id="settings-error" style="display: none;">
                <span id="settings-error-text"></span>
            </div>
        </div>
    </div>
</section>

<!-- Main Processing Tile (unified: upload → processing → results) -->
<section id="job-section" class="section" data-section="job" data-state="idle">
    <!-- Job Header -->
    <div class="job-header">
        <div class="job-header-left">
            <h2 class="section-title">
                <span id="job-title">Import Media</span>
                <span class="status-badge status-badge-sm" id="job-status-badge" data-status="IDLE" style="display: none;">
                    <span id="job-status-text">IDLE</span>
                </span>
            </h2>
        </div>
        <div class="job-header-right">
            <div class="job-controls" id="job-controls" style="display: none;">
                <button type="button" class="btn btn-secondary btn-sm" id="pause-btn" data-action="pause">Pause</button>
                <button type="button" class="btn btn-danger btn-sm" id="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Upload Area (visible in idle state) -->
    <div class="upload-area" id="upload-area">
        <div class="upload-box" id="upload-box" data-upload-box>
            <div class="upload-box-content">
                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p class="upload-text">Drop files or folders here</p>
                <div class="upload-buttons">
                    <button type="button" class="btn btn-primary" id="select-files-btn">Select Files</button>
                    <button type="button" class="btn btn-secondary" id="select-folder-btn">Select Folder</button>
                </div>
            </div>
        </div>

        <!-- Server path import -->
        <div class="server-import">
            <div class="input-group">
                <input type="text" id="server-path" class="form-input" placeholder="Or enter server path: /nas/photos/2024">
                <button type="button" class="btn btn-secondary" id="import-path-btn">Import</button>
            </div>
        </div>
    </div>

    <!-- Progress Area (visible while processing, collapses when done) -->
    <div class="job-progress" id="job-progress">
        <div class="progress-row">
            <div class="progress-bar progress-bar-lg">
                <div class="progress-bar-fill" id="job-progress-fill" style="width: 0%;"></div>
            </div>
            <span class="progress-text" id="job-progress-text">0%</span>
        </div>

        <div class="metrics-row" id="metrics-row">
            <div class="metric">
                <span class="metric-label">Files:</span>
                <span class="metric-value" id="files-processed">0 / 0</span>
            </div>
            <div class="metric">
                <span class="metric-label">Current:</span>
                <span class="metric-value metric-value-truncate" id="current-filename">-</span>
            </div>
            <div class="metric">
                <span class="metric-label">Time:</span>
                <span class="metric-value" id="elapsed-time">0:00</span>
            </div>
            <div class="metric">
                <span class="metric-label">ETA:</span>
                <span class="metric-value" id="eta">-</span>
            </div>
            <div class="metric error-metric" id="error-metric" style="display: none;">
                <span class="metric-label">Errors:</span>
                <span class="metric-value metric-error" id="error-count">0</span>
            </div>
        </div>
    </div>

    <!-- Summary Row (shown when complete, replaces detailed progress) -->
    <div class="job-summary" id="job-summary" style="display: none;">
        <div class="summary-row">
            <span class="summary-item"><strong id="summary-total">0</strong> files</span>
            <span class="summary-divider">•</span>
            <span class="summary-item summary-success"><strong id="summary-success">0</strong> successful</span>
            <span class="summary-divider">•</span>
            <span class="summary-item summary-error"><strong id="summary-errors">0</strong> errors</span>
            <span class="summary-divider">•</span>
            <span class="summary-item"><strong id="summary-time">0:00</strong> elapsed</span>
        </div>
    </div>

    <!-- Results: Unified Grid with Filter Bar -->
    <div class="results-container" id="results-container" style="display: none;">
        <!-- Filter Bar -->
        <div class="filter-bar" id="filter-bar">
            <div class="filter-chips">
                <button class="filter-chip" data-filter="high">
                    <span class="chip-badge confidence-high">H</span>
                    <span class="chip-count" data-count="high">0</span>
                </button>
                <button class="filter-chip" data-filter="medium">
                    <span class="chip-badge confidence-medium">M</span>
                    <span class="chip-count" data-count="medium">0</span>
                </button>
                <button class="filter-chip" data-filter="low">
                    <span class="chip-badge confidence-low">L</span>
                    <span class="chip-count" data-count="low">0</span>
                </button>
                <span class="filter-divider"></span>
                <button class="filter-chip" data-filter="reviewed">
                    <span class="chip-icon">&#10003;</span>
                    <span class="chip-label">Reviewed</span>
                    <span class="chip-count" data-count="reviewed">0</span>
                </button>
                <button class="filter-chip" data-filter="duplicates">
                    <span class="chip-icon">&#x29C9;</span>
                    <span class="chip-label">Duplicates</span>
                    <span class="chip-count" data-count="duplicates">0</span>
                </button>
                <button class="filter-chip" data-filter="failed">
                    <span class="chip-icon">&#x2717;</span>
                    <span class="chip-label">Failed</span>
                    <span class="chip-count" data-count="failed">0</span>
                </button>
            </div>
            <button class="btn btn-link btn-sm" id="clear-filters" style="display: none;">Clear filters</button>
        </div>

        <!-- Sort and Size Controls -->
        <div class="grid-controls">
            <div class="sort-control">
                <label for="sort-select">Sort:</label>
                <select id="sort-select" class="form-select form-select-sm">
                    <option value="detected_timestamp" selected>Date (detected)</option>
                    <option value="original_timestamp">Date (file system)</option>
                    <option value="filename">Filename</option>
                    <option value="file_size">File size</option>
                </select>
                <button class="btn btn-xs" id="sort-order" data-order="asc" title="Sort ascending">&#x2191;</button>
            </div>
            <div class="thumb-size-toggle" id="thumb-size-toggle">
                <button type="button" class="btn btn-xs" data-size="compact">S</button>
                <button type="button" class="btn btn-xs active" data-size="medium">M</button>
                <button type="button" class="btn btn-xs" data-size="large">L</button>
            </div>
        </div>

        <!-- Unified Thumbnail Grid -->
        <div class="thumbnail-grid thumb-medium" id="unified-grid"></div>

        <!-- Loading indicator -->
        <div class="grid-loading" id="grid-loading" style="display: none;">
            <span class="spinner"></span> Loading files...
        </div>

        <!-- Pagination -->
        <div class="grid-pagination" id="grid-pagination" style="display: none;"></div>
    </div>
</section>
{% endblock %}
