---
phase: 04-review-queues-timestamps
plan: 05
type: execute
wave: 3
depends_on: ["04-02", "04-04"]
files_modified:
  - app/static/js/examination.js
  - app/static/css/examination.css
  - app/templates/index.html
autonomous: true

must_haves:
  truths:
    - "User can view a file's full preview in examination view"
    - "User can navigate between files with arrow keys/buttons"
    - "User can close examination view with Escape or X button"
    - "File metadata is displayed (filename, size, confidence)"
    - "Examination view is accessible (focus management, keyboard nav)"
  artifacts:
    - path: "app/static/js/examination.js"
      provides: "Modal examination view with navigation"
      contains: "class ExaminationHandler"
    - path: "app/static/css/examination.css"
      provides: "Examination modal styles"
      contains: "#examination-dialog"
    - path: "app/templates/index.html"
      provides: "Dialog element for examination view"
      contains: "<dialog id=\"examination-dialog\""
  key_links:
    - from: "app/static/js/examination.js"
      to: "index.html"
      via: "dialog.showModal()"
      pattern: "showModal"
    - from: "app/static/js/examination.js"
      to: "/api/files/*"
      via: "fetch file details"
      pattern: "fetch.*api/files"
---

<objective>
Implement examination view using native HTML dialog element (modal overlay approach).

Purpose: Enable detailed file review with timestamp sources and navigation as specified in CONTEXT.md. The modal approach using native <dialog> provides accessibility (focus trapping, Escape handling) and is the primary implementation.

Note: CONTEXT.md mentioned "prototype both approaches: split layout and overlay" - we implement the modal overlay first as it provides better accessibility out of the box. Split layout can be explored as enhancement if modal proves limiting during actual use.

Output: examination.js module, examination.css styles, dialog HTML structure.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-review-queues-timestamps/04-CONTEXT.md
@.planning/phases/04-review-queues-timestamps/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add examination dialog HTML structure</name>
  <files>app/templates/index.html</files>
  <action>
Add the dialog element at the end of the content block, before the closing script tags:

```html
<!-- Examination Dialog (Modal) -->
<dialog id="examination-dialog" class="examination-dialog">
    <div class="examination-layout">
        <!-- Header -->
        <header class="examination-header">
            <h2 class="examination-title" id="exam-filename">filename.jpg</h2>
            <div class="examination-nav">
                <span class="nav-position" id="exam-position">1 of 10</span>
                <button class="btn btn-icon" id="exam-prev" title="Previous (Left Arrow)">
                    &#9664;
                </button>
                <button class="btn btn-icon" id="exam-next" title="Next (Right Arrow)">
                    &#9654;
                </button>
            </div>
            <button class="btn btn-icon close-btn" id="exam-close" title="Close (Escape)" autofocus>
                &#10005;
            </button>
        </header>

        <!-- Main Content -->
        <div class="examination-content">
            <!-- Preview Area -->
            <div class="examination-preview">
                <img id="exam-image" src="" alt="File preview">
                <div class="preview-loading" id="exam-loading" style="display: none;">
                    <span class="spinner"></span>
                </div>
            </div>

            <!-- Details Panel -->
            <aside class="examination-details">
                <!-- File Info -->
                <section class="detail-section">
                    <h3>File Info</h3>
                    <dl class="detail-list">
                        <dt>Size</dt>
                        <dd id="exam-filesize">-</dd>
                        <dt>Type</dt>
                        <dd id="exam-mimetype">-</dd>
                        <dt>Dimensions</dt>
                        <dd id="exam-dimensions">-</dd>
                        <dt>Confidence</dt>
                        <dd id="exam-confidence">-</dd>
                    </dl>
                </section>

                <!-- Timestamp Sources (placeholder for 04-06) -->
                <section class="detail-section" id="timestamp-section">
                    <h3>Timestamp Sources</h3>
                    <div id="timestamp-sources-container">
                        <!-- Populated by timestamp.js -->
                        <p class="placeholder">Loading timestamp sources...</p>
                    </div>
                </section>

                <!-- Tags (placeholder for 04-08) -->
                <section class="detail-section" id="tags-section">
                    <h3>Tags</h3>
                    <div id="tags-container">
                        <!-- Populated by tags.js -->
                        <p class="placeholder">No tags</p>
                    </div>
                </section>

                <!-- Actions -->
                <section class="detail-section actions-section">
                    <button class="btn btn-primary" id="exam-confirm" style="display: none;">
                        Confirm & Next
                    </button>
                    <button class="btn btn-secondary" id="exam-unreview" style="display: none;">
                        Unreview
                    </button>
                </section>
            </aside>
        </div>
    </div>
</dialog>
```
  </action>
  <verify>
```bash
grep -c "examination-dialog" /home/dab/Projects/MediaParser/app/templates/index.html
```
Should return > 0.
  </verify>
  <done>Dialog element added with header (title, navigation, close), preview area, details panel with file info/timestamp/tags sections, and action buttons.</done>
</task>

<task type="auto">
  <name>Task 2: Create examination.js for modal handling</name>
  <files>app/static/js/examination.js</files>
  <action>
Create new JavaScript module app/static/js/examination.js:

```javascript
/**
 * Examination Handler
 *
 * Manages the file examination modal using native <dialog>.
 * Features:
 * - Single file detailed view
 * - Prev/Next navigation within selection or all files
 * - Keyboard shortcuts (arrows, escape)
 * - Loads full file details from API
 */

class ExaminationHandler {
    constructor() {
        this.dialog = document.getElementById('examination-dialog');
        this.files = [];           // Files to navigate through
        this.currentIndex = 0;
        this.currentFile = null;

        // Cache DOM elements
        this.elements = {
            image: document.getElementById('exam-image'),
            loading: document.getElementById('exam-loading'),
            filename: document.getElementById('exam-filename'),
            position: document.getElementById('exam-position'),
            prevBtn: document.getElementById('exam-prev'),
            nextBtn: document.getElementById('exam-next'),
            closeBtn: document.getElementById('exam-close'),
            filesize: document.getElementById('exam-filesize'),
            mimetype: document.getElementById('exam-mimetype'),
            dimensions: document.getElementById('exam-dimensions'),
            confidence: document.getElementById('exam-confidence'),
            timestampContainer: document.getElementById('timestamp-sources-container'),
            tagsContainer: document.getElementById('tags-container'),
            confirmBtn: document.getElementById('exam-confirm'),
            unreviewBtn: document.getElementById('exam-unreview')
        };

        this.initEventListeners();
    }

    initEventListeners() {
        // Listen for file examination requests
        window.addEventListener('fileExamine', (e) => {
            const { fileId, selectedIds, files } = e.detail;
            this.open(files, fileId, selectedIds);
        });

        // Navigation buttons
        this.elements.prevBtn?.addEventListener('click', () => this.previous());
        this.elements.nextBtn?.addEventListener('click', () => this.next());
        this.elements.closeBtn?.addEventListener('click', () => this.close());

        // Dialog keyboard handling (native dialog handles Escape)
        this.dialog?.addEventListener('keydown', (e) => {
            if (e.defaultPrevented) return;

            switch (e.key) {
                case 'ArrowLeft':
                    this.previous();
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    this.next();
                    e.preventDefault();
                    break;
            }
        });

        // Click outside to close (on backdrop)
        this.dialog?.addEventListener('click', (e) => {
            if (e.target === this.dialog) {
                this.close();
            }
        });

        // Dialog close event (handles Escape automatically)
        this.dialog?.addEventListener('close', () => {
            this.onClose();
        });

        // Action buttons
        this.elements.confirmBtn?.addEventListener('click', () => this.confirmAndNext());
        this.elements.unreviewBtn?.addEventListener('click', () => this.unreviewFile());
    }

    open(files, targetFileId, selectedIds = []) {
        // Determine which files to navigate
        if (selectedIds && selectedIds.length > 1) {
            // Multiple selection - navigate through selected files
            this.files = files.filter(f => selectedIds.includes(f.id));
        } else {
            // Single or no selection - navigate all files
            this.files = files;
        }

        // Find index of target file
        this.currentIndex = this.files.findIndex(f => f.id === targetFileId);
        if (this.currentIndex === -1) this.currentIndex = 0;

        // Show dialog
        this.dialog?.showModal();

        // Load current file
        this.loadCurrentFile();
    }

    close() {
        this.dialog?.close();
    }

    onClose() {
        // Cleanup when dialog closes
        this.currentFile = null;
        if (this.elements.image) {
            this.elements.image.src = '';
        }
    }

    previous() {
        if (this.currentIndex > 0) {
            this.currentIndex--;
            this.loadCurrentFile();
        }
    }

    next() {
        if (this.currentIndex < this.files.length - 1) {
            this.currentIndex++;
            this.loadCurrentFile();
        }
    }

    async loadCurrentFile() {
        const file = this.files[this.currentIndex];
        if (!file) return;

        // Update navigation state
        this.updateNavigation();

        // Show loading
        this.showLoading(true);

        try {
            // Fetch full file details from API
            const response = await fetch(`/api/files/${file.id}`);
            if (!response.ok) throw new Error('Failed to load file');

            this.currentFile = await response.json();
            this.render();

            // Notify timestamp handler if available
            if (window.timestampHandler) {
                window.timestampHandler.loadForFile(this.currentFile);
            }

            // Notify tags handler if available
            if (window.tagsHandler) {
                window.tagsHandler.loadForFile(this.currentFile);
            }

        } catch (error) {
            console.error('Error loading file:', error);
            this.showError('Failed to load file details');
        } finally {
            this.showLoading(false);
        }
    }

    render() {
        const file = this.currentFile;
        if (!file) return;

        // Preview image
        const imgSrc = file.thumbnail_path
            ? `/${file.thumbnail_path}`
            : '/static/img/placeholder.svg';
        this.elements.image.src = imgSrc;
        this.elements.image.alt = file.original_filename;

        // Filename
        this.elements.filename.textContent = file.original_filename;
        this.elements.filename.title = file.original_filename;

        // File info
        this.elements.filesize.textContent = this.formatFileSize(file.file_size_bytes);
        this.elements.mimetype.textContent = file.mime_type || 'Unknown';
        this.elements.dimensions.textContent = this.formatDimensions(file);
        this.elements.confidence.textContent = file.confidence?.toUpperCase() || 'Unknown';
        this.elements.confidence.className = `confidence-badge confidence-${file.confidence}`;

        // Action buttons based on reviewed state
        const isReviewed = !!file.reviewed_at;
        if (this.elements.confirmBtn) {
            this.elements.confirmBtn.style.display = isReviewed ? 'none' : '';
        }
        if (this.elements.unreviewBtn) {
            this.elements.unreviewBtn.style.display = isReviewed ? '' : 'none';
        }
    }

    updateNavigation() {
        const total = this.files.length;
        const current = this.currentIndex + 1;

        this.elements.position.textContent = `${current} of ${total}`;

        // Enable/disable nav buttons
        this.elements.prevBtn.disabled = this.currentIndex === 0;
        this.elements.nextBtn.disabled = this.currentIndex === total - 1;
    }

    showLoading(show) {
        if (this.elements.loading) {
            this.elements.loading.style.display = show ? 'flex' : 'none';
        }
    }

    showError(message) {
        // Simple error display
        this.elements.filename.textContent = 'Error';
        this.elements.timestampContainer.innerHTML = `<p class="error">${message}</p>`;
    }

    async confirmAndNext() {
        if (!this.currentFile) return;

        // Get selected timestamp from timestamp handler
        const selectedTimestamp = window.timestampHandler?.getSelectedTimestamp();

        if (!selectedTimestamp) {
            alert('Please select a timestamp first');
            return;
        }

        try {
            // Submit review decision
            const response = await fetch(`/api/files/${this.currentFile.id}/review`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    final_timestamp: selectedTimestamp.value,
                    source: selectedTimestamp.source
                })
            });

            if (!response.ok) throw new Error('Failed to save review');

            // Mark as reviewed in local data
            this.currentFile.reviewed_at = new Date().toISOString();

            // Update grid item if visible
            this.updateGridItem(this.currentFile.id, { reviewed_at: this.currentFile.reviewed_at });

            // Move to next file
            if (this.currentIndex < this.files.length - 1) {
                this.next();
            } else {
                // No more files - close or show completion message
                alert('All files in selection reviewed!');
                this.close();
            }

        } catch (error) {
            console.error('Error saving review:', error);
            alert('Failed to save review. Please try again.');
        }
    }

    async unreviewFile() {
        if (!this.currentFile) return;

        try {
            const response = await fetch(`/api/files/${this.currentFile.id}/review`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Failed to unreview');

            // Clear reviewed state
            this.currentFile.reviewed_at = null;
            this.currentFile.final_timestamp = null;

            // Update UI
            this.render();

            // Update grid item
            this.updateGridItem(this.currentFile.id, { reviewed_at: null });

        } catch (error) {
            console.error('Error unreviewing:', error);
            alert('Failed to unreview. Please try again.');
        }
    }

    updateGridItem(fileId, updates) {
        // Update the file in resultsHandler's data
        if (window.resultsHandler) {
            const file = window.resultsHandler.allFiles.find(f => f.id === fileId);
            if (file) {
                Object.assign(file, updates);
            }
        }

        // Update visual in grid
        const thumb = document.querySelector(`.thumbnail[data-file-id="${fileId}"]`);
        if (thumb && updates.reviewed_at) {
            // Add reviewed badge
            let badgeRight = thumb.querySelector('.badge-right');
            if (badgeRight && !badgeRight.querySelector('.reviewed')) {
                badgeRight.innerHTML = '<span class="thumb-badge reviewed">&#10003;</span>' + badgeRight.innerHTML;
            }
        } else if (thumb && updates.reviewed_at === null) {
            // Remove reviewed badge
            thumb.querySelector('.thumb-badge.reviewed')?.remove();
        }
    }

    formatFileSize(bytes) {
        if (!bytes) return 'Unknown';
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        return `${size.toFixed(1)} ${units[unitIndex]}`;
    }

    formatDimensions(file) {
        // Dimensions may come from EXIF data or stored separately
        if (file.width && file.height) {
            return `${file.width} x ${file.height}`;
        }
        return 'Unknown';
    }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        window.examinationHandler = new ExaminationHandler();
    });
} else {
    window.examinationHandler = new ExaminationHandler();
}
```
  </action>
  <verify>
```bash
ls -la /home/dab/Projects/MediaParser/app/static/js/examination.js && grep -c "showModal" /home/dab/Projects/MediaParser/app/static/js/examination.js
```
  </verify>
  <done>examination.js created with ExaminationHandler class supporting native dialog, prev/next navigation, keyboard shortcuts, file detail loading, and confirm/unreview actions.</done>
</task>

<task type="auto">
  <name>Task 3: Create examination.css styles</name>
  <files>app/static/css/examination.css, app/templates/index.html</files>
  <action>
1. Create new CSS file app/static/css/examination.css:

```css
/**
 * Examination Modal Styles
 *
 * Uses native <dialog> element for accessibility.
 * Responsive layout: preview left, details right on wide screens.
 */

/* ============================================
   DIALOG BASE
   ============================================ */

.examination-dialog {
    border: none;
    border-radius: var(--border-radius-lg, 12px);
    padding: 0;
    max-width: 95vw;
    max-height: 95vh;
    width: 1200px;
    background: var(--bg-primary);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.examination-dialog::backdrop {
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
}

/* ============================================
   LAYOUT
   ============================================ */

.examination-layout {
    display: flex;
    flex-direction: column;
    height: 90vh;
    max-height: 90vh;
}

.examination-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-secondary);
}

.examination-title {
    font-size: 1.1rem;
    font-weight: 500;
    margin: 0;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: var(--spacing-md);
}

.examination-nav {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.nav-position {
    font-size: 0.9rem;
    color: var(--text-secondary);
    min-width: 80px;
    text-align: center;
}

.examination-content {
    display: flex;
    flex: 1;
    min-height: 0; /* Allow flex shrinking */
    overflow: hidden;
}

/* ============================================
   PREVIEW AREA
   ============================================ */

.examination-preview {
    flex: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-md);
    background: var(--bg-tertiary, #1a1a1a);
    position: relative;
    min-width: 0;
}

.examination-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: var(--border-radius);
}

.preview-loading {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.5);
}

/* ============================================
   DETAILS PANEL
   ============================================ */

.examination-details {
    flex: 1;
    min-width: 300px;
    max-width: 400px;
    padding: var(--spacing-md);
    overflow-y: auto;
    border-left: 1px solid var(--border-color);
    background: var(--bg-primary);
}

.detail-section {
    margin-bottom: var(--spacing-lg);
}

.detail-section h3 {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    margin: 0 0 var(--spacing-sm) 0;
    padding-bottom: var(--spacing-xs);
    border-bottom: 1px solid var(--border-color);
}

.detail-list {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--spacing-xs) var(--spacing-sm);
    margin: 0;
}

.detail-list dt {
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.detail-list dd {
    margin: 0;
    font-size: 0.9rem;
}

.placeholder {
    color: var(--text-secondary);
    font-style: italic;
    font-size: 0.9rem;
}

/* ============================================
   BUTTONS
   ============================================ */

.btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    padding: 0;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--bg-secondary);
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.15s ease;
}

.btn-icon:hover:not(:disabled) {
    background: var(--bg-hover);
    border-color: var(--accent-color);
}

.btn-icon:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.close-btn {
    margin-left: var(--spacing-md);
}

.close-btn:hover {
    background: var(--error-color);
    border-color: var(--error-color);
    color: white;
}

.actions-section {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border-color);
    margin-top: auto;
}

.actions-section .btn {
    width: 100%;
}

/* ============================================
   RESPONSIVE
   ============================================ */

@media (max-width: 768px) {
    .examination-dialog {
        width: 100vw;
        max-width: 100vw;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }

    .examination-layout {
        height: 100vh;
    }

    .examination-content {
        flex-direction: column;
    }

    .examination-preview {
        flex: 1;
        min-height: 200px;
    }

    .examination-details {
        max-width: none;
        border-left: none;
        border-top: 1px solid var(--border-color);
        max-height: 40vh;
    }
}

/* ============================================
   CONFIDENCE BADGES IN DETAILS
   ============================================ */

.confidence-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: bold;
}

.confidence-badge.confidence-high {
    background: var(--success-color);
    color: white;
}

.confidence-badge.confidence-medium {
    background: var(--warning-color);
    color: #000;
}

.confidence-badge.confidence-low,
.confidence-badge.confidence-none {
    background: var(--error-color);
    color: white;
}
```

2. Add link to examination.css in base.html or index.html:
```html
<link rel="stylesheet" href="{{ url_for('static', filename='css/examination.css') }}">
```

3. Add script tag for examination.js after selection.js:
```html
<script src="{{ url_for('static', filename='js/examination.js') }}"></script>
```
  </action>
  <verify>
```bash
ls -la /home/dab/Projects/MediaParser/app/static/css/examination.css && grep -c "examination-dialog" /home/dab/Projects/MediaParser/app/static/css/examination.css
```
  </verify>
  <done>examination.css created with dialog styling, responsive layout (preview + details panel), header with navigation, and mobile-first responsive breakpoints.</done>
</task>

</tasks>

<verification>
1. Click on thumbnail opens modal dialog
2. Modal shows file preview image
3. File info section displays size, type, confidence
4. Arrow keys navigate between files
5. Prev/Next buttons work and disable at boundaries
6. Escape key or X button closes modal
7. Click on backdrop closes modal
8. Position indicator updates (e.g., "3 of 10")
</verification>

<success_criteria>
- Native dialog element used (.showModal())
- File preview displays in modal
- Prev/Next navigation functional
- Keyboard shortcuts work (arrows, escape)
- File metadata displayed correctly
- Responsive layout on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/04-review-queues-timestamps/04-05-SUMMARY.md`
</output>
