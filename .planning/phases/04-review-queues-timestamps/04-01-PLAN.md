---
phase: 04-review-queues-timestamps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/models.py
  - app/routes/review.py
  - app/routes/__init__.py
autonomous: true

must_haves:
  truths:
    - "File model has reviewed_at and final_timestamp fields"
    - "Tag model exists with many-to-many relation to File"
    - "API returns timestamp_candidates for source comparison"
    - "API supports updating file's final_timestamp"
    - "API supports adding/removing tags from files"
  artifacts:
    - path: "app/models.py"
      provides: "Tag model and File model extensions"
      contains: "class Tag"
    - path: "app/routes/review.py"
      provides: "Review and tagging API endpoints"
      exports: ["review_bp"]
  key_links:
    - from: "app/routes/review.py"
      to: "app/models.py"
      via: "imports File, Tag, UserDecision"
      pattern: "from app.models import"
---

<objective>
Add database models and API endpoints for the review workflow.

Purpose: Enable backend support for timestamp review decisions, file tagging, and reviewed state tracking.
Output: Extended File model, new Tag model, and review API endpoints.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-review-queues-timestamps/04-CONTEXT.md
@app/models.py
@app/routes/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend File model and add Tag model</name>
  <files>app/models.py</files>
  <action>
Extend the File model with review tracking fields:
- `reviewed_at: Mapped[Optional[datetime]]` - When user confirmed timestamp decision
- `final_timestamp: Mapped[Optional[datetime]]` - User-confirmed timestamp (may differ from detected_timestamp)

Add Tag model for flat tag system:
- `id: Mapped[int]` - Primary key
- `name: Mapped[str]` - Tag name, unique, case-insensitive (stored lowercase)
- `created_at: Mapped[datetime]` - When tag was created
- `usage_count: Mapped[int]` - Cached count for autocomplete sorting (default 0)

Add file_tags association table:
- `file_id` -> files.id
- `tag_id` -> tags.id

Add relationship from File to Tag:
- `tags: Mapped[List["Tag"]]` - Many-to-many relationship

Add index on Tag.name for fast lookup.

Note: Do NOT use SQLAlchemy func.lower() in unique constraint - store normalized (lowercase) and enforce in application code.
  </action>
  <verify>
Run Python import check:
```bash
cd /home/dab/Projects/MediaParser && .venv/bin/python -c "from app.models import File, Tag, file_tags; print('Models import OK')"
```
  </verify>
  <done>File model has reviewed_at and final_timestamp fields, Tag model exists with name, usage_count, and many-to-many relation to File via file_tags table.</done>
</task>

<task type="auto">
  <name>Task 2: Create review API endpoints</name>
  <files>app/routes/review.py, app/routes/__init__.py</files>
  <action>
Create new blueprint `review_bp` in app/routes/review.py with endpoints:

1. `GET /api/files/<file_id>` - Get single file with full details including timestamp_candidates
   - Returns: id, original_filename, detected_timestamp, final_timestamp, timestamp_source, confidence, reviewed_at, timestamp_candidates (parsed JSON), tags, file_size_bytes, mime_type, thumbnail_path

2. `POST /api/files/<file_id>/review` - Submit review decision for a file
   - Request body: { final_timestamp: ISO string, source: string (optional) }
   - Sets final_timestamp and reviewed_at to now
   - Creates UserDecision record with decision_type='timestamp_override'
   - Returns updated file object

3. `DELETE /api/files/<file_id>/review` - Unreview a file (return to original state)
   - Clears reviewed_at and final_timestamp
   - Returns updated file object

4. `GET /api/tags` - Get all tags sorted by usage_count desc
   - Query param: limit (default 20)
   - Returns: [{id, name, usage_count}]

5. `GET /api/tags/recent` - Get recently used tags
   - Returns top 10 tags by most recent usage

6. `POST /api/files/<file_id>/tags` - Add tag(s) to file
   - Request body: { tags: ["tag1", "tag2"] }
   - Creates new Tag records if names don't exist (normalized to lowercase)
   - Increments usage_count for each tag
   - Returns file's current tags

7. `DELETE /api/files/<file_id>/tags/<tag_name>` - Remove tag from file
   - Decrements usage_count
   - Returns file's current tags

8. `POST /api/files/bulk/tags` - Bulk add tags to multiple files
   - Request body: { file_ids: [1,2,3], tags: ["tag1"] }
   - Returns success count

Register blueprint in app/routes/__init__.py.
  </action>
  <verify>
```bash
cd /home/dab/Projects/MediaParser && .venv/bin/python -c "
from app import create_app
app = create_app()
with app.app_context():
    client = app.test_client()
    # Test tags endpoint exists
    resp = client.get('/api/tags')
    print(f'GET /api/tags: {resp.status_code}')
"
```
  </verify>
  <done>Review blueprint registered, all 8 endpoints return appropriate responses (200/404/400 as expected), file review updates reviewed_at, tag operations work correctly.</done>
</task>

<task type="auto">
  <name>Task 3: Extend jobs.py files endpoint for unified grid</name>
  <files>app/routes/jobs.py</files>
  <action>
Update `GET /api/jobs/<job_id>/files` endpoint to support unified grid requirements:

1. Add query parameters:
   - `reviewed`: Filter by review status (true/false/any)
   - `has_duplicates`: Filter files that are part of duplicate groups (true/false)
   - `sort`: Sort field (detected_timestamp, original_timestamp, filename, file_size)
   - `order`: Sort order (asc, desc) - default asc

2. Extend response to include additional fields per file:
   - `file_size_bytes`
   - `mime_type`
   - `reviewed_at` (ISO string or null)
   - `final_timestamp` (ISO string or null)
   - `is_duplicate` (boolean - true if file shares hash with another file in job)

3. Add summary counts endpoint `GET /api/jobs/<job_id>/summary`:
   - Returns counts for filter chips: { high: N, medium: N, low: N, none: N, reviewed: N, duplicates: N, failed: N, total: N }

4. Support multiple confidence values in single request:
   - `confidence=high,medium` returns both HIGH and MEDIUM files
  </action>
  <verify>
```bash
cd /home/dab/Projects/MediaParser && .venv/bin/python -c "
from app import create_app
app = create_app()
with app.app_context():
    client = app.test_client()
    # Test summary endpoint exists (will 404 since no job, but route exists)
    resp = client.get('/api/jobs/999/summary')
    print(f'GET /api/jobs/999/summary: {resp.status_code} (404 expected)')
"
```
  </verify>
  <done>Jobs files endpoint supports reviewed filter, sort options, and returns extended file data. Summary endpoint returns accurate counts for all filter categories.</done>
</task>

</tasks>

<verification>
1. Models import without errors
2. Database migrations would succeed (check with db.create_all() in test context)
3. All new API endpoints respond appropriately
4. Review workflow: POST review sets reviewed_at, DELETE review clears it
5. Tag operations: create, add, remove all work correctly
</verification>

<success_criteria>
- File model extended with reviewed_at, final_timestamp fields
- Tag model exists with name, usage_count, many-to-many to File
- 8 review API endpoints functional
- Jobs files endpoint extended with filters and sorts
- Summary endpoint returns filter chip counts
</success_criteria>

<output>
After completion, create `.planning/phases/04-review-queues-timestamps/04-01-SUMMARY.md`
</output>
