---
phase: 04-review-queues-timestamps
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/templates/index.html
  - app/static/js/filters.js
  - app/static/css/main.css
autonomous: true

must_haves:
  truths:
    - "Accordion buckets replaced with unified grid container"
    - "Filter chips displayed above grid with counts"
    - "Filter chips toggle active/inactive state on click"
    - "Thumbnail size selector preserved and functional"
    - "Grid layout uses CSS Grid with responsive columns"
  artifacts:
    - path: "app/templates/index.html"
      provides: "Unified grid HTML structure with filter bar"
      contains: "filter-bar"
    - path: "app/static/js/filters.js"
      provides: "Filter state management class"
      contains: "class FilterHandler"
    - path: "app/static/css/main.css"
      provides: "Filter chip and unified grid styles"
      contains: ".filter-chip"
  key_links:
    - from: "app/static/js/filters.js"
      to: "index.html"
      via: "DOM queries for filter chips"
      pattern: "querySelectorAll.*filter-chip"
---

<objective>
Replace accordion bucket UI with unified grid and filter chips.

Purpose: Enable flexible filtering workflow as specified in CONTEXT.md - single grid filtered by toggle chips instead of accordion buckets.
Output: New HTML structure, filter handling JavaScript, and CSS styles.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-review-queues-timestamps/04-CONTEXT.md
@.planning/phases/04-review-queues-timestamps/04-RESEARCH.md
@app/templates/index.html
@app/static/css/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace accordion HTML with unified grid structure</name>
  <files>app/templates/index.html</files>
  <action>
Replace the buckets-container section (lines ~138-218) with new unified grid structure:

1. Replace "Files by Confidence" accordion buckets with:
```html
<!-- Results: Unified Grid with Filter Bar -->
<div class="results-container" id="results-container" style="display: none;">
    <!-- Filter Bar -->
    <div class="filter-bar" id="filter-bar">
        <div class="filter-chips">
            <button class="filter-chip" data-filter="high">
                <span class="chip-badge confidence-high">H</span>
                <span class="chip-count" data-count="high">0</span>
            </button>
            <button class="filter-chip" data-filter="medium">
                <span class="chip-badge confidence-medium">M</span>
                <span class="chip-count" data-count="medium">0</span>
            </button>
            <button class="filter-chip" data-filter="low">
                <span class="chip-badge confidence-low">L</span>
                <span class="chip-count" data-count="low">0</span>
            </button>
            <span class="filter-divider"></span>
            <button class="filter-chip" data-filter="reviewed">
                <span class="chip-icon">&#10003;</span>
                <span class="chip-label">Reviewed</span>
                <span class="chip-count" data-count="reviewed">0</span>
            </button>
            <button class="filter-chip" data-filter="duplicates">
                <span class="chip-icon">&#x29C9;</span>
                <span class="chip-label">Duplicates</span>
                <span class="chip-count" data-count="duplicates">0</span>
            </button>
            <button class="filter-chip" data-filter="failed">
                <span class="chip-icon">&#x2717;</span>
                <span class="chip-label">Failed</span>
                <span class="chip-count" data-count="failed">0</span>
            </button>
        </div>
        <button class="btn btn-link btn-sm" id="clear-filters" style="display: none;">Clear filters</button>
    </div>

    <!-- Sort and Size Controls -->
    <div class="grid-controls">
        <div class="sort-control">
            <label for="sort-select">Sort:</label>
            <select id="sort-select" class="form-select form-select-sm">
                <option value="detected_timestamp" selected>Date (detected)</option>
                <option value="original_timestamp">Date (file system)</option>
                <option value="filename">Filename</option>
                <option value="file_size">File size</option>
            </select>
            <button class="btn btn-xs" id="sort-order" data-order="asc" title="Sort ascending">&#x2191;</button>
        </div>
        <div class="thumb-size-toggle" id="thumb-size-toggle">
            <button type="button" class="btn btn-xs" data-size="compact">S</button>
            <button type="button" class="btn btn-xs active" data-size="medium">M</button>
            <button type="button" class="btn btn-xs" data-size="large">L</button>
        </div>
    </div>

    <!-- Unified Thumbnail Grid -->
    <div class="thumbnail-grid thumb-medium" id="unified-grid"></div>

    <!-- Loading indicator -->
    <div class="grid-loading" id="grid-loading" style="display: none;">
        <span class="spinner"></span> Loading files...
    </div>

    <!-- Pagination -->
    <div class="grid-pagination" id="grid-pagination" style="display: none;"></div>
</div>
```

2. Keep the job-progress and job-summary sections unchanged.

3. Remove the old bucket divs (high, medium, low, duplicates, failed buckets).
  </action>
  <verify>
Open app/templates/index.html and verify:
- No "data-bucket" attributes remain
- New "filter-bar" and "unified-grid" elements exist
- Sort controls and filter chips are present
  </verify>
  <done>Accordion bucket HTML replaced with unified grid structure containing filter bar, sort controls, and single thumbnail grid container.</done>
</task>

<task type="auto">
  <name>Task 2: Create filters.js for filter state management</name>
  <files>app/static/js/filters.js</files>
  <action>
Create new JavaScript module app/static/js/filters.js:

```javascript
/**
 * Filter Handler
 *
 * Manages filter chip state for the unified grid.
 * Filter chips are additive - selecting HIGH and MEDIUM shows both.
 * Empty selection shows all files (no filtering).
 */

class FilterHandler {
    constructor() {
        this.activeFilters = new Set();
        this.counts = {
            high: 0,
            medium: 0,
            low: 0,
            reviewed: 0,
            duplicates: 0,
            failed: 0,
            total: 0
        };

        // Cache DOM elements
        this.filterBar = document.getElementById('filter-bar');
        this.clearButton = document.getElementById('clear-filters');
        this.chips = document.querySelectorAll('.filter-chip');

        // Sort state
        this.sortField = 'detected_timestamp';
        this.sortOrder = 'asc';

        this.initEventListeners();
        this.loadState();
    }

    initEventListeners() {
        // Filter chip clicks
        this.chips.forEach(chip => {
            chip.addEventListener('click', (e) => {
                const filter = chip.dataset.filter;
                this.toggleFilter(filter);
            });
        });

        // Clear filters button
        if (this.clearButton) {
            this.clearButton.addEventListener('click', () => {
                this.clearFilters();
            });
        }

        // Sort select
        const sortSelect = document.getElementById('sort-select');
        if (sortSelect) {
            sortSelect.addEventListener('change', (e) => {
                this.sortField = e.target.value;
                this.saveState();
                this.emitChange();
            });
        }

        // Sort order button
        const sortOrder = document.getElementById('sort-order');
        if (sortOrder) {
            sortOrder.addEventListener('click', () => {
                this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                sortOrder.dataset.order = this.sortOrder;
                sortOrder.innerHTML = this.sortOrder === 'asc' ? '&#x2191;' : '&#x2193;';
                sortOrder.title = this.sortOrder === 'asc' ? 'Sort ascending' : 'Sort descending';
                this.saveState();
                this.emitChange();
            });
        }
    }

    toggleFilter(filterName) {
        if (this.activeFilters.has(filterName)) {
            this.activeFilters.delete(filterName);
        } else {
            this.activeFilters.add(filterName);
        }
        this.updateChipStyles();
        this.updateClearButton();
        this.saveState();
        this.emitChange();
    }

    clearFilters() {
        this.activeFilters.clear();
        this.updateChipStyles();
        this.updateClearButton();
        this.saveState();
        this.emitChange();
    }

    updateChipStyles() {
        this.chips.forEach(chip => {
            const filter = chip.dataset.filter;
            const isActive = this.activeFilters.has(filter);
            chip.classList.toggle('active', isActive);
        });
    }

    updateClearButton() {
        if (this.clearButton) {
            this.clearButton.style.display = this.activeFilters.size > 0 ? '' : 'none';
        }
    }

    updateCounts(newCounts) {
        this.counts = { ...this.counts, ...newCounts };

        // Update count displays
        Object.keys(this.counts).forEach(key => {
            const countEl = document.querySelector(`[data-count="${key}"]`);
            if (countEl) {
                countEl.textContent = this.counts[key];
            }
        });

        // Hide chips with zero count
        this.chips.forEach(chip => {
            const filter = chip.dataset.filter;
            const count = this.counts[filter] || 0;
            chip.style.display = count > 0 ? '' : 'none';
        });
    }

    getActiveFilters() {
        return Array.from(this.activeFilters);
    }

    getQueryParams() {
        const params = new URLSearchParams();

        // Confidence filters (high, medium, low)
        const confidenceFilters = this.getActiveFilters().filter(
            f => ['high', 'medium', 'low'].includes(f)
        );
        if (confidenceFilters.length > 0) {
            params.set('confidence', confidenceFilters.join(','));
        }

        // Reviewed filter
        if (this.activeFilters.has('reviewed')) {
            params.set('reviewed', 'true');
        }

        // Duplicates filter
        if (this.activeFilters.has('duplicates')) {
            params.set('has_duplicates', 'true');
        }

        // Failed filter - handled separately (different endpoint or param)
        if (this.activeFilters.has('failed')) {
            params.set('failed', 'true');
        }

        // Sort
        params.set('sort', this.sortField);
        params.set('order', this.sortOrder);

        return params;
    }

    saveState() {
        const state = {
            filters: this.getActiveFilters(),
            sortField: this.sortField,
            sortOrder: this.sortOrder
        };
        try {
            localStorage.setItem('filterState', JSON.stringify(state));
        } catch (e) {
            console.warn('Failed to save filter state:', e);
        }
    }

    loadState() {
        try {
            const saved = localStorage.getItem('filterState');
            if (saved) {
                const state = JSON.parse(saved);
                state.filters?.forEach(f => this.activeFilters.add(f));
                this.sortField = state.sortField || 'detected_timestamp';
                this.sortOrder = state.sortOrder || 'asc';

                // Update UI to match loaded state
                this.updateChipStyles();
                this.updateClearButton();

                const sortSelect = document.getElementById('sort-select');
                if (sortSelect) sortSelect.value = this.sortField;

                const sortOrderBtn = document.getElementById('sort-order');
                if (sortOrderBtn) {
                    sortOrderBtn.dataset.order = this.sortOrder;
                    sortOrderBtn.innerHTML = this.sortOrder === 'asc' ? '&#x2191;' : '&#x2193;';
                }
            }
        } catch (e) {
            console.warn('Failed to load filter state:', e);
        }
    }

    emitChange() {
        // Dispatch custom event for results handler to listen to
        window.dispatchEvent(new CustomEvent('filterChange', {
            detail: {
                filters: this.getActiveFilters(),
                queryParams: this.getQueryParams(),
                sortField: this.sortField,
                sortOrder: this.sortOrder
            }
        }));
    }

    reset() {
        this.activeFilters.clear();
        this.counts = { high: 0, medium: 0, low: 0, reviewed: 0, duplicates: 0, failed: 0, total: 0 };
        this.updateChipStyles();
        this.updateClearButton();
        this.chips.forEach(chip => chip.style.display = '');
    }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        window.filterHandler = new FilterHandler();
    });
} else {
    window.filterHandler = new FilterHandler();
}
```

Add script tag to index.html base template or before results.js.
  </action>
  <verify>
```bash
ls -la /home/dab/Projects/MediaParser/app/static/js/filters.js && head -20 /home/dab/Projects/MediaParser/app/static/js/filters.js
```
  </verify>
  <done>filters.js created with FilterHandler class that manages active filters, counts, sort state, localStorage persistence, and emits filterChange events.</done>
</task>

<task type="auto">
  <name>Task 3: Add filter chip and unified grid CSS styles</name>
  <files>app/static/css/main.css</files>
  <action>
Add new CSS styles to main.css for the unified grid and filter chips:

```css
/* ============================================
   FILTER BAR
   ============================================ */

.filter-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) 0;
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--border-color);
}

.filter-chips {
    display: flex;
    gap: var(--spacing-xs);
    align-items: center;
    flex-wrap: wrap;
}

.filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border: 1px solid var(--border-color);
    border-radius: 16px;
    background: var(--bg-secondary);
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.15s ease;
}

.filter-chip:hover {
    border-color: var(--accent-color);
    background: var(--bg-hover);
}

.filter-chip.active {
    background: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
}

.filter-chip.active .chip-badge {
    background: rgba(255, 255, 255, 0.3);
}

.chip-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: bold;
}

.chip-icon {
    font-size: 0.9rem;
}

.chip-label {
    font-weight: 500;
}

.chip-count {
    font-size: 0.75rem;
    opacity: 0.8;
}

.filter-divider {
    width: 1px;
    height: 20px;
    background: var(--border-color);
    margin: 0 var(--spacing-xs);
}

/* ============================================
   GRID CONTROLS
   ============================================ */

.grid-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-xs) 0;
    margin-bottom: var(--spacing-sm);
}

.sort-control {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}

.sort-control label {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.form-select-sm {
    padding: 4px 8px;
    font-size: 0.85rem;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--bg-primary);
}

/* ============================================
   UNIFIED GRID
   ============================================ */

.results-container {
    margin-top: var(--spacing-md);
}

#unified-grid {
    display: grid;
    gap: var(--spacing-sm);
}

/* Grid responsive columns based on thumbnail size */
.thumbnail-grid.thumb-compact {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
}

.thumbnail-grid.thumb-medium {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
}

.thumbnail-grid.thumb-large {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
}

/* ============================================
   THUMBNAIL BADGES
   ============================================ */

.thumbnail {
    position: relative;
    border: 2px solid transparent;
    border-radius: var(--border-radius);
    overflow: hidden;
    background: var(--bg-secondary);
    transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    cursor: pointer;
}

.thumbnail:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.thumbnail.selected {
    transform: scale(1.03);
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
    border-color: var(--accent-color);
}

.thumbnail.duplicate-group {
    border-color: var(--warning-color);
}

/* Badge positioning */
.thumbnail-badges {
    position: absolute;
    top: 4px;
    left: 4px;
    right: 4px;
    display: flex;
    justify-content: space-between;
    pointer-events: none;
    z-index: 5;
}

.badge-left, .badge-right {
    display: flex;
    gap: 2px;
}

.thumb-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 4px;
    border-radius: 3px;
    font-size: 0.65rem;
    font-weight: bold;
    background: rgba(0, 0, 0, 0.7);
    color: white;
}

.thumb-badge.confidence-high { background: var(--success-color); }
.thumb-badge.confidence-medium { background: var(--warning-color); color: #000; }
.thumb-badge.confidence-low { background: var(--error-color); }

.thumb-badge.media-video {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 50%;
    width: 20px;
    padding: 0;
}

.thumb-badge.reviewed {
    background: var(--success-color);
    border-radius: 50%;
    width: 20px;
    padding: 0;
}

.thumb-badge.warning {
    background: var(--warning-color);
    color: #000;
    border-radius: 50%;
    width: 20px;
    padding: 0;
}

.thumb-badge.failed {
    background: var(--error-color);
    border-radius: 50%;
    width: 20px;
    padding: 0;
}

/* Thumbnail date display */
.thumbnail-date {
    padding: 4px;
    font-size: 0.75rem;
    text-align: center;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border-top: 1px solid var(--border-color);
}

/* ============================================
   LOADING AND PAGINATION
   ============================================ */

.grid-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-xl);
    color: var(--text-secondary);
}

.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-color);
    border-top-color: var(--accent-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: var(--spacing-xs);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.grid-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md) 0;
    margin-top: var(--spacing-md);
    border-top: 1px solid var(--border-color);
}
```

Also update the script tags in base.html or index.html to include filters.js before results.js.
  </action>
  <verify>
```bash
grep -c "filter-chip" /home/dab/Projects/MediaParser/app/static/css/main.css && grep -c "unified-grid" /home/dab/Projects/MediaParser/app/static/css/main.css
```
Both should return > 0.
  </verify>
  <done>CSS styles added for filter chips (active/inactive states, badges), grid controls, unified grid layout (responsive columns), thumbnail badges, and loading/pagination elements.</done>
</task>

</tasks>

<verification>
1. index.html contains unified grid structure (no accordion buckets)
2. filters.js loads without errors
3. Filter chips visible in browser when page loads
4. CSS styles render correctly (chips have borders, hover states work)
5. Thumbnail size toggle preserved and functional
</verification>

<success_criteria>
- Accordion bucket HTML completely replaced with unified grid
- Filter bar with 6 chips (HIGH, MEDIUM, LOW, Reviewed, Duplicates, Failed)
- Sort controls with 4 options and order toggle
- filters.js manages state with localStorage persistence
- CSS provides visual distinction for active/inactive chips
</success_criteria>

<output>
After completion, create `.planning/phases/04-review-queues-timestamps/04-02-SUMMARY.md`
</output>
