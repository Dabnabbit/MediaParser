---
phase: 04-review-queues-timestamps
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - app/static/js/results.js
  - app/templates/index.html
autonomous: true

must_haves:
  truths:
    - "Results display uses unified grid instead of accordion buckets"
    - "Filter chip changes trigger grid reload with filtered data"
    - "Thumbnails lazy load via Intersection Observer"
    - "Grid shows badges for confidence, media type, reviewed status"
    - "Grid dispatches events for examination (handled by selection.js)"
  artifacts:
    - path: "app/static/js/results.js"
      provides: "Unified grid rendering with lazy loading"
      contains: "IntersectionObserver"
    - path: "app/templates/index.html"
      provides: "Script tag order includes filters.js"
      contains: "filters.js"
  key_links:
    - from: "app/static/js/results.js"
      to: "filterHandler"
      via: "window.filterHandler and filterChange event"
      pattern: "addEventListener.*filterChange"
    - from: "app/static/js/results.js"
      to: "/api/jobs/*/files"
      via: "fetch with filter params"
      pattern: "fetch.*api/jobs.*files"
---

<objective>
Refactor results.js to render unified grid with filter integration and lazy loading.

Purpose: Connect the filter UI (Plan 02) to the API (Plan 01) and render files in the new unified grid layout.
Output: Refactored results.js that works with unified grid instead of accordion buckets.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-review-queues-timestamps/04-CONTEXT.md
@.planning/phases/04-review-queues-timestamps/04-RESEARCH.md
@app/static/js/results.js
@app/static/js/filters.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor ResultsHandler for unified grid</name>
  <files>app/static/js/results.js</files>
  <action>
Rewrite results.js to work with unified grid instead of accordion buckets:

1. Remove all accordion/bucket-related code:
   - Remove bucketPages, bucketTotals, expandedBucket state
   - Remove toggleBucket, toggleBucketVisibility, clearBucketContent methods
   - Remove loadBucketPage method
   - Remove bucket header click listeners

2. Add new unified grid state:
```javascript
constructor() {
    this.jobId = null;
    this.summary = null;
    this.selectedFiles = new Set();
    this.lastSelectedIndex = null;
    this.thumbnailSize = 'medium';
    this.allFiles = [];       // All loaded files
    this.currentPage = 1;
    this.totalPages = 1;
    this.PAGE_SIZE = 100;     // Increased for grid view
    this.lazyLoader = null;

    // Cache DOM elements - update for unified grid
    this.resultsContainer = document.getElementById('results-container');
    this.unifiedGrid = document.getElementById('unified-grid');
    this.gridLoading = document.getElementById('grid-loading');
    this.gridPagination = document.getElementById('grid-pagination');

    this.initEventListeners();
    this.initLazyLoader();
}
```

3. Add Intersection Observer for lazy loading:
```javascript
initLazyLoader() {
    this.lazyLoader = new IntersectionObserver(
        (entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        img.addEventListener('load', () => img.classList.add('loaded'));
                        img.addEventListener('error', () => {
                            img.src = '/static/img/placeholder.svg';
                        });
                    }
                    this.lazyLoader.unobserve(img);
                }
            });
        },
        { rootMargin: '100px' }
    );
}
```

4. Update initEventListeners to listen for filter changes ONLY (NO grid click handling here):
```javascript
initEventListeners() {
    // Listen for filter changes from FilterHandler
    window.addEventListener('filterChange', (e) => {
        this.currentPage = 1;
        this.loadFiles();
    });

    // Thumbnail size toggle (keep existing)
    const sizeToggle = document.getElementById('thumb-size-toggle');
    if (sizeToggle) {
        sizeToggle.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.setThumbnailSize(e.target.dataset.size);
            });
        });
    }

    // NOTE: Grid click handling is DELEGATED to SelectionHandler (04-04)
    // results.js does NOT handle thumbnail clicks directly
    // This avoids conflicts between results.js and selection.js
}
```

5. Add loadFiles method that uses filterHandler state:
```javascript
async loadFiles() {
    if (!this.jobId) return;

    this.showLoading(true);

    try {
        // Build URL with filter params
        const filterParams = window.filterHandler?.getQueryParams() || new URLSearchParams();
        filterParams.set('page', this.currentPage);
        filterParams.set('per_page', this.PAGE_SIZE);

        const response = await fetch(`/api/jobs/${this.jobId}/files?${filterParams}`);
        if (!response.ok) throw new Error('Failed to load files');

        const data = await response.json();

        this.allFiles = data.files || [];
        this.totalPages = data.pages || 1;

        this.renderGrid();
        this.renderPagination(data);
    } catch (error) {
        console.error('Error loading files:', error);
        this.unifiedGrid.innerHTML = '<div class="error">Failed to load files</div>';
    } finally {
        this.showLoading(false);
    }
}
```

6. Update showResults to load summary and trigger initial load:
```javascript
showResults(jobId, data) {
    this.jobId = jobId;
    this.resultsContainer.style.display = 'block';

    // Update filter counts from summary
    if (data.summary && window.filterHandler) {
        window.filterHandler.updateCounts({
            high: data.summary.confidence_counts?.high || 0,
            medium: data.summary.confidence_counts?.medium || 0,
            low: (data.summary.confidence_counts?.low || 0) + (data.summary.confidence_counts?.none || 0),
            reviewed: 0, // Will be fetched from summary endpoint
            duplicates: data.summary.duplicate_groups || 0,
            failed: data.summary.failed_count || 0,
            total: data.progress_total || 0
        });
    }

    // Load initial files
    this.loadFiles();

    // Load full summary for accurate counts
    this.loadSummary();
}

async loadSummary() {
    try {
        const response = await fetch(`/api/jobs/${this.jobId}/summary`);
        if (response.ok) {
            const summary = await response.json();
            if (window.filterHandler) {
                window.filterHandler.updateCounts(summary);
            }
        }
    } catch (error) {
        console.warn('Failed to load summary:', error);
    }
}
```

7. Update renderGrid (renamed from renderThumbnails):
```javascript
renderGrid() {
    if (!this.unifiedGrid) return;

    this.unifiedGrid.innerHTML = '';
    this.unifiedGrid.className = `thumbnail-grid thumb-${this.thumbnailSize}`;

    if (this.allFiles.length === 0) {
        this.unifiedGrid.innerHTML = '<div class="empty">No files match the current filters</div>';
        return;
    }

    this.allFiles.forEach((file, index) => {
        const thumb = this.createThumbnailElement(file, index);
        this.unifiedGrid.appendChild(thumb);

        // Observe image for lazy loading
        const img = thumb.querySelector('img');
        if (img && this.lazyLoader) {
            this.lazyLoader.observe(img);
        }
    });

    // After rendering, refresh selection UI if selectionHandler exists
    if (window.selectionHandler) {
        window.selectionHandler.refreshUI();
    }
}
```

8. Add createThumbnailElement with badges (NO click handler - selection.js handles clicks):
```javascript
createThumbnailElement(file, index) {
    const thumb = document.createElement('div');
    thumb.className = 'thumbnail';
    thumb.dataset.fileId = file.id;
    thumb.dataset.index = index;

    if (this.selectedFiles.has(file.id)) {
        thumb.classList.add('selected');
    }
    if (file.is_duplicate) {
        thumb.classList.add('duplicate-group');
    }

    const imgSrc = file.thumbnail_path ? `/${file.thumbnail_path}` : '/static/img/placeholder.svg';
    const confidenceClass = `confidence-${file.confidence}`;
    const confidenceLabel = file.confidence?.charAt(0).toUpperCase() || '?';
    const isVideo = file.mime_type?.startsWith('video/');
    const isReviewed = !!file.reviewed_at;
    const isFailed = !!file.processing_error;

    const timestamp = file.final_timestamp || file.detected_timestamp;
    const dateStr = timestamp ? new Date(timestamp).toISOString().split('T')[0] : 'Unknown';

    thumb.innerHTML = `
        <div class="thumbnail-badges">
            <div class="badge-left">
                <span class="thumb-badge ${confidenceClass}">${confidenceLabel}</span>
                ${isVideo ? '<span class="thumb-badge media-video">&#9658;</span>' : ''}
            </div>
            <div class="badge-right">
                ${isReviewed ? '<span class="thumb-badge reviewed">&#10003;</span>' : ''}
                ${isFailed ? '<span class="thumb-badge failed">&#10007;</span>' : ''}
            </div>
        </div>
        <img data-src="${imgSrc}"
             src="/static/img/placeholder.svg"
             alt="${file.original_filename}"
             title="${file.original_filename}&#10;${file.file_size_bytes ? this.formatFileSize(file.file_size_bytes) : ''}">
        <div class="thumbnail-date">${dateStr}</div>
    `;

    return thumb;
}
```

9. REMOVE any handleThumbnailClick method - selection.js owns all grid click handling.

10. Update reset method for unified grid.
  </action>
  <verify>
```bash
cd /home/dab/Projects/MediaParser && grep -c "IntersectionObserver" app/static/js/results.js && grep -c "filterChange" app/static/js/results.js
```
Both should return > 0.
  </verify>
  <done>results.js refactored to use unified grid with lazy loading via Intersection Observer, listens to filterChange events, renders thumbnails with badges, NO grid click handling (delegated to selection.js).</done>
</task>

<task type="auto">
  <name>Task 2: Update script loading order and fix integration</name>
  <files>app/templates/index.html, app/templates/base.html</files>
  <action>
1. Update script tags in base.html or index.html to ensure correct loading order:
```html
<!-- Scripts -->
<script src="{{ url_for('static', filename='js/upload.js') }}"></script>
<script src="{{ url_for('static', filename='js/progress.js') }}"></script>
<script src="{{ url_for('static', filename='js/filters.js') }}"></script>
<script src="{{ url_for('static', filename='js/results.js') }}"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
```

2. Update progress.js to call resultsHandler.showResults correctly:
   - When job completes, show results container
   - Pass job data to resultsHandler.showResults()

3. Ensure the results-container is hidden initially and shown when job completes:
   - Add `style="display: none;"` to results-container if not present

4. Verify progressHandler integration:
   - On COMPLETED status: show results-container, call resultsHandler.showResults(jobId, data)
   - On new job: call resultsHandler.reset(), hide results-container
  </action>
  <verify>
```bash
grep -n "filters.js" /home/dab/Projects/MediaParser/app/templates/*.html
```
Should show filters.js included before results.js.
  </verify>
  <done>Script loading order correct (filters.js before results.js), progress handler shows results container on completion, integration verified.</done>
</task>

<task type="auto">
  <name>Task 3: Add pagination controls to unified grid</name>
  <files>app/static/js/results.js</files>
  <action>
Add pagination rendering and controls to results.js:

```javascript
renderPagination(data) {
    if (!this.gridPagination) return;

    // Hide pagination if only one page
    if (data.pages <= 1) {
        this.gridPagination.style.display = 'none';
        return;
    }

    this.gridPagination.style.display = 'flex';

    const prevDisabled = data.page <= 1;
    const nextDisabled = data.page >= data.pages;

    this.gridPagination.innerHTML = `
        <button class="btn btn-secondary btn-sm" id="page-prev" ${prevDisabled ? 'disabled' : ''}>
            &larr; Previous
        </button>
        <span class="pagination-info">
            Page ${data.page} of ${data.pages} &bull; ${data.total} files
        </span>
        <button class="btn btn-secondary btn-sm" id="page-next" ${nextDisabled ? 'disabled' : ''}>
            Next &rarr;
        </button>
    `;

    // Attach event listeners
    document.getElementById('page-prev')?.addEventListener('click', () => {
        if (this.currentPage > 1) {
            this.currentPage--;
            this.loadFiles();
            this.scrollToTop();
        }
    });

    document.getElementById('page-next')?.addEventListener('click', () => {
        if (this.currentPage < this.totalPages) {
            this.currentPage++;
            this.loadFiles();
            this.scrollToTop();
        }
    });
}

scrollToTop() {
    this.resultsContainer?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

showLoading(show) {
    if (this.gridLoading) {
        this.gridLoading.style.display = show ? 'flex' : 'none';
    }
    if (this.unifiedGrid && show) {
        this.unifiedGrid.innerHTML = '';
    }
}
```

Also update the empty state and error state styling to be centered in the grid area.
  </action>
  <verify>
```bash
grep -c "renderPagination" /home/dab/Projects/MediaParser/app/static/js/results.js
```
Should return > 0.
  </verify>
  <done>Pagination renders with prev/next buttons, page info, handles disabled states, scrolls to top on page change.</done>
</task>

</tasks>

<verification>
1. Page loads without JavaScript errors
2. Filter chips show correct counts when job completes
3. Clicking filter chip reloads grid with filtered results
4. Thumbnails lazy load as user scrolls (check Network tab)
5. Badges display correctly for confidence, video, reviewed status
6. Pagination appears for large file sets
7. Grid click handling works (via selection.js in 04-04)
</verification>

<success_criteria>
- Unified grid displays all files from completed job
- Filter chip clicks trigger API reload with params
- Lazy loading works (images load on scroll, not all at once)
- Thumbnails show confidence badge, media type badge, reviewed badge
- Pagination functional for jobs with >100 files
- NO click handlers on grid (delegated to selection.js)
</success_criteria>

<output>
After completion, create `.planning/phases/04-review-queues-timestamps/04-03-SUMMARY.md`
</output>
