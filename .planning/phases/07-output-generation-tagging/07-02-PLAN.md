---
phase: 07-output-generation-tagging
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/lib/metadata.py
autonomous: true

must_haves:
  truths:
    - "Corrected timestamps are written to EXIF DateTimeOriginal and CreateDate on output files"
    - "Tags are written to both IPTC:Keywords and XMP:Subject on output files"
    - "PNG files get timestamps written as XMP metadata"
    - "Original source files are never modified (writes only target output copies)"
    - "-overwrite_original prevents backup file clutter"
  artifacts:
    - path: "app/lib/metadata.py"
      provides: "EXIF write-back functions for timestamps and tags"
      contains: "write_timestamps"
    - path: "app/lib/metadata.py"
      provides: "Tag write function for IPTC/XMP keywords"
      contains: "write_tags_to_file"
  key_links:
    - from: "app/lib/metadata.py"
      to: "exiftool"
      via: "ExifToolHelper.set_tags() with -overwrite_original"
      pattern: "et\\.set_tags"
---

<objective>
Add EXIF metadata write-back functions to the existing metadata library for writing corrected timestamps and tags to output files.

Purpose: Exported files need corrected EXIF timestamps (from user review decisions) and tags embedded in the file metadata for compatibility with photo management tools (Google Photos, Apple Photos, etc.).

Output: Two new functions in `app/lib/metadata.py`: `write_timestamps()` and `write_tags_to_file()`
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/lib/metadata.py — Existing EXIF read functions, ExifToolHelper usage pattern, EXIFTOOL_PATH
@.planning/phases/07-output-generation-tagging/07-RESEARCH.md — PyExifTool write patterns, PNG caveat, IPTC/XMP for tags
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add write_timestamps function to metadata.py</name>
  <files>app/lib/metadata.py</files>
  <action>
Add `write_timestamps(file_path: Path | str, timestamp: datetime) -> bool` to `app/lib/metadata.py`:

**Logic:**
1. Convert datetime to ExifTool format string: `YYYY:MM:DD HH:MM:SS` (note colons in date, not hyphens)
   - If timezone-aware, ExifTool handles TZ automatically
   - Format: `timestamp.strftime('%Y:%m:%d %H:%M:%S')`
2. Build tag dict:
```python
tags = {
    'EXIF:DateTimeOriginal': formatted_ts,
    'EXIF:CreateDate': formatted_ts,
}
```
3. Write using ExifToolHelper:
```python
with exiftool.ExifToolHelper(executable=EXIFTOOL_PATH) as et:
    et.set_tags(path_str, tags, params=['-overwrite_original'])
```
4. Return True on success, False on error (log the error, don't raise)

**Important:**
- Use `-overwrite_original` to prevent `.jpg_original` backup files in output directory
- This function writes to OUTPUT files only (never called on source files)
- PNG files: ExifTool will write as XMP automatically (no special handling needed)
- Video files (mp4, mov): Write `QuickTime:CreateDate` and `QuickTime:ModifyDate` as well. Check extension to determine which tags to write.

Add video-specific tags when extension is in {'.mp4', '.mov', '.avi', '.mkv'}:
```python
if ext in {'.mp4', '.mov', '.avi', '.mkv'}:
    tags['QuickTime:CreateDate'] = formatted_ts
    tags['QuickTime:ModifyDate'] = formatted_ts
```
  </action>
  <verify>
Run: `cd /home/dab/Projects/MediaParser && .venv/bin/python -c "from app.lib.metadata import write_timestamps; print('write_timestamps imported OK')"`
  </verify>
  <done>write_timestamps function writes corrected DateTimeOriginal and CreateDate to output files using PyExifTool, with QuickTime tags for video files and -overwrite_original flag.</done>
</task>

<task type="auto">
  <name>Task 2: Add write_tags_to_file function to metadata.py</name>
  <files>app/lib/metadata.py</files>
  <action>
Add `write_tags_to_file(file_path: Path | str, tag_names: list[str]) -> bool` to `app/lib/metadata.py`:

**Logic:**
1. If `tag_names` is empty, return True (nothing to write)
2. Build tag dict with both IPTC and XMP for broadest compatibility:
```python
tags = {
    'IPTC:Keywords': tag_names,
    'XMP:Subject': tag_names,
}
```
3. Write using ExifToolHelper:
```python
with exiftool.ExifToolHelper(executable=EXIFTOOL_PATH) as et:
    et.set_tags(path_str, tags, params=['-overwrite_original'])
```
4. Return True on success, False on error (log the error, don't raise)

**Note:** IPTC:Keywords and XMP:Subject both accept lists. ExifTool handles the encoding for each format correctly (IPTC uses repeated fields, XMP uses bag/seq).

Also add a convenience function `write_metadata(file_path, timestamp=None, tag_names=None) -> bool`:
- Calls write_timestamps if timestamp is not None
- Calls write_tags_to_file if tag_names is not None and non-empty
- Returns True if all writes succeed, False if any fail
- Uses a SINGLE ExifToolHelper context to batch both operations for efficiency:
```python
def write_metadata(file_path: Path | str, timestamp: datetime = None, tag_names: list[str] = None) -> bool:
    path_str = str(file_path) if isinstance(file_path, Path) else file_path
    tags = {}

    if timestamp:
        formatted_ts = timestamp.strftime('%Y:%m:%d %H:%M:%S')
        tags['EXIF:DateTimeOriginal'] = formatted_ts
        tags['EXIF:CreateDate'] = formatted_ts
        ext = Path(path_str).suffix.lower()
        if ext in {'.mp4', '.mov', '.avi', '.mkv'}:
            tags['QuickTime:CreateDate'] = formatted_ts
            tags['QuickTime:ModifyDate'] = formatted_ts

    if tag_names:
        tags['IPTC:Keywords'] = tag_names
        tags['XMP:Subject'] = tag_names

    if not tags:
        return True

    try:
        with exiftool.ExifToolHelper(executable=EXIFTOOL_PATH) as et:
            et.set_tags(path_str, tags, params=['-overwrite_original'])
        return True
    except Exception as e:
        logger.error(f"Failed to write metadata to {path_str}: {e}")
        return False
```

Add `import logging` and `logger = logging.getLogger(__name__)` at the top of the file if not already present.
  </action>
  <verify>
Run: `cd /home/dab/Projects/MediaParser && .venv/bin/python -c "from app.lib.metadata import write_timestamps, write_tags_to_file, write_metadata; print('All metadata write functions imported OK')"`
  </verify>
  <done>Three metadata write functions exist: write_timestamps (EXIF dates), write_tags_to_file (IPTC/XMP keywords), write_metadata (combined convenience function using single ExifTool context). All use -overwrite_original and handle errors gracefully.</done>
</task>

</tasks>

<verification>
1. `write_timestamps()` writes EXIF:DateTimeOriginal and EXIF:CreateDate
2. `write_timestamps()` also writes QuickTime tags for video files
3. `write_tags_to_file()` writes to both IPTC:Keywords and XMP:Subject
4. `write_metadata()` batches timestamp and tag writes in a single ExifTool context
5. All functions use `-overwrite_original` to prevent backup files
6. All functions return bool and log errors without raising
7. Existing read functions in metadata.py are not modified
</verification>

<success_criteria>
- Corrected timestamps written to EXIF DateTimeOriginal and CreateDate
- Tags written to both IPTC:Keywords and XMP:Subject
- Video files get QuickTime timestamp tags
- Combined write_metadata function batches all writes efficiently
- Error handling returns False and logs, never raises
</success_criteria>

<output>
After completion, create `.planning/phases/07-output-generation-tagging/07-02-SUMMARY.md`
</output>
