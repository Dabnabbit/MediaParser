---
phase: 07-output-generation-tagging
plan: 05
type: execute
wave: 3
depends_on: ["07-04"]
files_modified:
  - tests/test_export.py
  - tests/test_tagging.py
autonomous: true

must_haves:
  truths:
    - "Export produces files in correct year-based directory structure"
    - "Output filenames follow YYYYMMDD_HHMMSS.ext format"
    - "Same-timestamp files get counter suffixes (_001, _002)"
    - "Files without timestamps go to unknown/ folder"
    - "Tag auto-generation correctly parses filename syntax and folder paths"
    - "EXIF timestamps are written correctly to output files"
    - "Existing upload, review, and duplicate flows still work"
  artifacts:
    - path: "tests/test_export.py"
      provides: "Export pipeline tests"
      contains: "test_generate_output_filename"
    - path: "tests/test_tagging.py"
      provides: "Tag auto-generation tests"
      contains: "test_extract_filename_tags"
  key_links:
    - from: "tests/test_export.py"
      to: "app/lib/export.py"
      via: "Direct function testing"
      pattern: "from app\\.lib\\.export import"
    - from: "tests/test_tagging.py"
      to: "app/lib/tagging.py"
      via: "Direct function testing"
      pattern: "from app\\.lib\\.tagging import"
---

<objective>
Write integration tests for the export pipeline and tag auto-generation, then verify existing functionality hasn't regressed.

Purpose: Validate the complete Phase 7 output generation pipeline with automated tests covering filename generation, collision handling, tag parsing, and EXIF write-back. Ensure Phases 1-6 functionality remains intact.

Output: `tests/test_export.py` (export pipeline tests), `tests/test_tagging.py` (tagging tests)
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-output-generation-tagging/07-01-SUMMARY.md
@.planning/phases/07-output-generation-tagging/07-02-SUMMARY.md
@.planning/phases/07-output-generation-tagging/07-03-SUMMARY.md
@.planning/phases/07-output-generation-tagging/07-04-SUMMARY.md
@app/lib/export.py — Export functions to test
@app/lib/tagging.py — Tagging functions to test
@app/lib/metadata.py — Metadata write functions to test
@tests/ — Existing test patterns (pytest, fixtures, temp_dir)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write export pipeline tests</name>
  <files>tests/test_export.py</files>
  <action>
Create `tests/test_export.py` with pytest tests following existing test patterns (see tests/ directory for fixture patterns).

**Test class: TestOutputFilenameGeneration**

1. `test_filename_from_final_timestamp`:
   - Create mock File with final_timestamp = 2024-01-15 12:00:00
   - Call generate_output_filename(file, output_base)
   - Assert path is `output_base/2024/20240115_120000.jpg`

2. `test_filename_from_detected_timestamp_fallback`:
   - File with final_timestamp=None, detected_timestamp=2023-06-15 14:30:22
   - Assert path is `output_base/2023/20230615_143022.jpg`

3. `test_filename_no_timestamp`:
   - File with both timestamps None, original_filename="photo.jpg"
   - Assert path is `output_base/unknown/photo.jpg`

4. `test_year_subfolder_creation`:
   - Multiple files from different years
   - Assert different year directories in output

5. `test_extension_preserved_lowercase`:
   - File with original_filename="PHOTO.JPG"
   - Assert output has `.jpg` (lowercase)

**Test class: TestCollisionHandling**

1. `test_no_collision`:
   - Call resolve_collision on non-existing path
   - Assert returns same path

2. `test_single_collision`:
   - Create a file at the target path
   - Call resolve_collision
   - Assert returns path with `_001` suffix

3. `test_multiple_collisions`:
   - Create files with _001, _002 suffixes
   - Assert next collision gets `_003`

4. `test_collision_preserves_extension`:
   - Verify `20240115_120000_001.jpg` not `20240115_120000.jpg_001`

**Test class: TestFileCopy**

1. `test_copy_file_basic`:
   - Create temp source file with known content
   - Call copy_file_to_output
   - Assert output file exists with same content and size

2. `test_copy_creates_parent_dirs`:
   - Target path with non-existing parent directory
   - Assert parent dir created and file copied

3. `test_copy_with_collision`:
   - Create existing file at target
   - Copy should produce _001 suffixed file
   - Both files should exist

Use pytest's `tmp_path` fixture for all temporary directories. Create minimal File-like objects using SimpleNamespace or dataclass for testing generate_output_filename without database.
  </action>
  <verify>
Run: `cd /home/dab/Projects/MediaParser && .venv/bin/python -m pytest tests/test_export.py -v`
  </verify>
  <done>All export pipeline tests pass: filename generation from timestamps, collision handling with counter suffixes, file copy with directory creation, unknown/ folder fallback.</done>
</task>

<task type="auto">
  <name>Task 2: Write tagging tests and run regression suite</name>
  <files>tests/test_tagging.py</files>
  <action>
Create `tests/test_tagging.py` with pytest tests:

**Test class: TestFilenameTagExtraction**

1. `test_single_tag`:
   - `extract_filename_tags('{Korea}20240115.jpg')` -> `['korea']`

2. `test_multiple_tags`:
   - `extract_filename_tags('{Korea,Seoul}20240115.jpg')` -> `['korea', 'seoul']`

3. `test_no_tags`:
   - `extract_filename_tags('photo.jpg')` -> `[]`

4. `test_empty_braces`:
   - `extract_filename_tags('{}photo.jpg')` -> `[]`

5. `test_whitespace_handling`:
   - `extract_filename_tags('{ Korea , Seoul }photo.jpg')` -> `['korea', 'seoul']`

6. `test_tags_in_middle`:
   - `extract_filename_tags('vacation_{family,beach}_2024.jpg')` -> `['family', 'beach']`

**Test class: TestFolderTagExtraction**

1. `test_single_subfolder`:
   - `extract_folder_tags('/photos/Korea/photo.jpg', '/photos')` -> `['korea']`

2. `test_nested_subfolders`:
   - `extract_folder_tags('/photos/Korea/Seoul/photo.jpg', '/photos')` -> `['korea', 'seoul']`

3. `test_no_subfolders`:
   - `extract_folder_tags('/photos/photo.jpg', '/photos')` -> `[]`

4. `test_path_not_under_root`:
   - `extract_folder_tags('/other/photo.jpg', '/photos')` -> `[]`

5. `test_filters_generic_dirs`:
   - `extract_folder_tags('/photos/DCIM/Camera/photo.jpg', '/photos')` -> `[]` (DCIM and Camera are generic)

6. `test_none_import_root`:
   - `extract_folder_tags('/photos/Korea/photo.jpg', None)` -> `[]`

**Regression: Run existing test suite**

After writing new tests, run the full test suite to verify no regressions:
```bash
cd /home/dab/Projects/MediaParser && .venv/bin/python -m pytest tests/ -v --tb=short
```

If any existing tests fail, investigate and fix (they may fail due to new imports or model changes).
  </action>
  <verify>
Run: `cd /home/dab/Projects/MediaParser && .venv/bin/python -m pytest tests/ -v --tb=short` (all tests including existing ones)
  </verify>
  <done>All tagging tests pass (filename syntax, folder extraction, edge cases). Full regression suite passes with no failures from existing Phase 1-6 tests.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_export.py -v` — all export tests pass
2. `pytest tests/test_tagging.py -v` — all tagging tests pass
3. `pytest tests/ -v` — full suite passes (no regressions)
4. Export filename generation correct for all timestamp scenarios
5. Collision handling produces correct _001, _002, etc. suffixes
6. Tag extraction handles all documented syntax variations
7. Folder tag extraction filters generic directory names
</verification>

<success_criteria>
- All new tests pass
- All existing tests pass (no regressions)
- Export pipeline produces correct output structure
- Tag parsing handles all edge cases
- Test coverage validates Phase 7 requirements
</success_criteria>

<output>
After completion, create `.planning/phases/07-output-generation-tagging/07-05-SUMMARY.md`
</output>
