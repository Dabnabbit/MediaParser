---
phase: 07-output-generation-tagging
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02", "07-03"]
files_modified:
  - app/tasks.py
  - app/routes/jobs.py
  - app/static/js/progress.js
  - app/templates/index.html
  - app/static/css/main.css
autonomous: false

must_haves:
  truths:
    - "User can trigger export from the UI after review is complete"
    - "Export progress is displayed with file count, current file, and ETA"
    - "Export summary shows output path, files written, and errors"
    - "User can choose to delete source files after successful export"
    - "User can filter the thumbnail grid by tag"
    - "Auto-tags are generated before file copy during export"
  artifacts:
    - path: "app/static/js/progress.js"
      provides: "Export button, progress display, and summary UI"
      contains: "startExport"
    - path: "app/routes/jobs.py"
      provides: "Source cleanup endpoint"
      contains: "cleanup-sources"
    - path: "app/tasks.py"
      provides: "Integrated export with auto-tags and metadata write"
      contains: "write_metadata"
  key_links:
    - from: "app/static/js/progress.js"
      to: "/api/jobs/:id/export"
      via: "fetch POST to trigger export"
      pattern: "api/jobs.*export"
    - from: "app/tasks.py"
      to: "app/lib/tagging.py"
      via: "apply_auto_tags before copy"
      pattern: "apply_auto_tags"
    - from: "app/tasks.py"
      to: "app/lib/metadata.py"
      via: "write_metadata after copy"
      pattern: "write_metadata"
    - from: "app/routes/jobs.py"
      to: "os.unlink"
      via: "Source file cleanup"
      pattern: "cleanup.sources|os\\.unlink"
---

<objective>
Build the export UI (button, progress, summary), integrate auto-tags and metadata write-back into the export pipeline, add source file cleanup, and add tag filtering for the thumbnail grid.

Purpose: This plan wires everything together - the export task from 07-01, metadata writing from 07-02, and auto-tagging from 07-03 - into a complete user-facing workflow with UI controls.

Output: Export button and progress in UI, integrated export pipeline with auto-tags + EXIF write, source cleanup endpoint, tag filter UI
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-output-generation-tagging/07-01-SUMMARY.md — Export task and file copy engine
@.planning/phases/07-output-generation-tagging/07-02-SUMMARY.md — Metadata write-back functions
@.planning/phases/07-output-generation-tagging/07-03-SUMMARY.md — Tag auto-generation functions
@app/tasks.py — process_export_job from 07-01
@app/lib/metadata.py — write_metadata from 07-02
@app/lib/tagging.py — apply_auto_tags from 07-03
@app/routes/upload.py — get_import_root from 07-03
@app/static/js/progress.js — Existing progress handler (reuse for export)
@app/static/js/filters.js — FilterHandler for chip-based filtering (add tag filter here)
@app/routes/jobs.py — Existing job routes
@app/routes/review.py — Tag API (GET /api/tags for autocomplete)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate auto-tags and metadata write-back into export pipeline</name>
  <files>app/tasks.py, app/routes/jobs.py</files>
  <action>
**Update `process_export_job()` in `app/tasks.py`:**

Integrate the auto-tagging and metadata write-back steps. The export pipeline becomes:

1. **Pre-export: Auto-generate tags** (before the file copy loop)
   ```python
   from app.lib.tagging import apply_auto_tags
   from app.routes.upload import get_import_root

   import_root = get_import_root(job_id)  # May be None for browser uploads

   # Find the original import job to get its files
   # The export job's files are the same as the import job's files
   tag_result = apply_auto_tags(db, files_to_export, import_root)
   logger.info(f"Auto-tags: {tag_result}")
   db.session.commit()
   ```

2. **Per-file: Copy + write metadata** (in the existing copy loop)
   After `copy_file_to_output()` succeeds:
   ```python
   from app.lib.metadata import write_metadata

   # Get timestamp for metadata write
   timestamp = file_obj.final_timestamp or file_obj.detected_timestamp

   # Get tag names for this file
   tag_names = [tag.name for tag in file_obj.tags]

   # Write corrected metadata to the OUTPUT copy (not source)
   write_metadata(final_output_path, timestamp=timestamp, tag_names=tag_names)
   ```

**Update `POST /api/jobs/<id>/export` in `app/routes/jobs.py`:**

Add validation that prevents export if there are unresolved duplicates:
- Count files with `exact_group_id IS NOT NULL AND discarded = False` where multiple files share the same group
- Count files with `similar_group_id IS NOT NULL AND discarded = False` where multiple files share the same group
- If unresolved groups exist, return 400 with message suggesting to resolve duplicates first
- This is a WARNING, not a hard block - include a `force` parameter to override:
  ```python
  force = data.get('force', False) if request.is_json else False
  ```

**Add source cleanup endpoint to `app/routes/jobs.py`:**

`POST /api/jobs/<int:job_id>/cleanup-sources`:
- Verify export job exists and status is COMPLETED
- Get action from request JSON: `{'action': 'delete'}` or `{'action': 'keep'}`
- If action is 'delete':
  - For each file in the job where `output_path IS NOT NULL`:
    - Delete the source file at `storage_path` or `original_path`
    - Use `os.unlink()` with try/except for each file (log failures, continue)
    - Count successes and failures
  - Return `{'deleted': N, 'failed': M, 'kept': K}`
- If action is 'keep':
  - Return `{'action': 'keep', 'message': 'Source files preserved'}`

**Important:** NEVER delete source files of files that failed export (output_path is None). Only delete sources of successfully exported files.
  </action>
  <verify>
Run: `cd /home/dab/Projects/MediaParser && .venv/bin/python -c "from app.tasks import process_export_job; from app.routes.jobs import jobs_bp; print('Integration OK')"`
  </verify>
  <done>Export pipeline integrates auto-tags (pre-export) and metadata write-back (per-file after copy). Source cleanup endpoint allows deleting source files after successful export. Duplicate resolution warning on export trigger.</done>
</task>

<task type="auto">
  <name>Task 2: Add export UI controls and tag filter to frontend</name>
  <files>app/static/js/progress.js, app/templates/index.html, app/static/css/main.css</files>
  <action>
**In `app/static/js/progress.js`, add export functionality:**

Add to ProgressHandler:

1. **`startExport(jobId)` method:**
   - POST to `/api/jobs/${jobId}/export`
   - On success, start polling the new export job's progress
   - Show export progress section (reuse existing progress bar)
   - On completion, show export summary

2. **`showExportSummary(exportJobId)` method:**
   - Fetch export job details from `/api/progress/${exportJobId}`
   - Display: files exported, errors, output directory path
   - Show "Cleanup Sources" section with two buttons:
     - "Keep Source Files" (POST cleanup-sources with action: 'keep')
     - "Delete Source Files" (POST cleanup-sources with action: 'delete', with confirmation dialog)
   - After cleanup action, show final summary

3. **Export button rendering:**
   - After import job completes and review is done, show "Export Files" button
   - Button appears in the workflow area (below the workflow bar)
   - Check if export already exists for this job (GET progress endpoint with export job)
   - Disable button during export (prevent double-click)

**In `app/templates/index.html`:**

Add the export section HTML (hidden by default, shown after review):
```html
<section id="export-section" class="section" style="display: none;">
  <h2>Export</h2>
  <div id="export-controls">
    <button id="export-btn" class="btn btn-primary">Export Files</button>
    <p class="export-description">Copy reviewed files to output directory with corrected timestamps and tags.</p>
  </div>
  <div id="export-progress" style="display: none;">
    <!-- Reuses progress bar pattern from upload -->
    <div class="progress-bar-container">
      <div class="progress-bar" id="export-progress-bar"></div>
    </div>
    <div class="progress-info">
      <span id="export-progress-text">0%</span>
      <span id="export-current-file"></span>
      <span id="export-eta"></span>
    </div>
  </div>
  <div id="export-summary" style="display: none;">
    <div class="export-summary-content"></div>
  </div>
  <div id="source-cleanup" style="display: none;">
    <h3>Source Files</h3>
    <p>Export complete. What would you like to do with the original source files?</p>
    <div class="cleanup-actions">
      <button id="keep-sources-btn" class="btn btn-secondary">Keep Source Files</button>
      <button id="delete-sources-btn" class="btn btn-danger">Delete Source Files</button>
    </div>
  </div>
</section>
```

**Tag filter for thumbnail grid (TAG-04):**

In `app/static/js/filters.js` (or inline in progress.js if simpler), add tag filtering:
- Add a tag filter dropdown/input in the filter bar area
- When a tag is selected, add `&tag=tagname` to the `/api/jobs/:id/files` request
- Requires backend support: update the files endpoint in `app/routes/jobs.py` to accept `tag` query parameter and filter by `file_tags` association

In `app/routes/jobs.py`, update the `GET /api/jobs/<id>/files` endpoint:
- Accept `tag` query parameter
- If provided, add `.join(File.tags).filter(Tag.name == tag)` to the query
- Import Tag model

**CSS in `app/static/css/main.css`:**
- Style the export section: `.export-description`, `.cleanup-actions` (flex row with gap), `.btn-danger` (red background for delete)
- Export progress reuses existing `.progress-bar-container` and `.progress-bar` styles
- Export summary: simple card-like container with success/error counts
  </action>
  <verify>
Start Flask dev server: `cd /home/dab/Projects/MediaParser && .venv/bin/flask run --debug` and verify:
1. Export section HTML exists in page source
2. Export button visible after job completion
3. No JavaScript console errors on page load
  </verify>
  <done>Export button appears after review, triggers export with progress display, shows summary with file counts, provides source file cleanup options (keep/delete), and tag filter works in thumbnail grid.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete export workflow: button triggers export, progress displays during copy, summary shows results, source cleanup options, tag filter in grid</what-built>
  <how-to-verify>
1. Start Flask: `cd /home/dab/Projects/MediaParser && .venv/bin/flask run --debug`
2. Start Huey: `cd /home/dab/Projects/MediaParser && .venv/bin/huey_consumer huey_config.huey -w 2 -k thread`
3. Import test files (or use existing completed job)
4. Complete review (confirm timestamps, resolve duplicates)
5. Click "Export Files" button
6. Watch export progress bar update
7. Check output directory for exported files with year-based folders
8. Verify exported files have corrected EXIF timestamps (use exiftool to read)
9. Try "Keep Source Files" and "Delete Source Files" cleanup options
10. Try filtering grid by tag (if auto-tags were generated)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Export button visible in UI after job completion
2. Export progress displays with file count, current file, ETA
3. Export summary shows output path, files written, errors
4. Source cleanup options (keep/delete) work correctly
5. Tag filter in thumbnail grid filters files by tag
6. Auto-tags generated before export (visible on files)
7. Metadata written to output files (EXIF timestamps + IPTC/XMP tags)
</verification>

<success_criteria>
- Complete export workflow from button click to summary
- Auto-tags generated from filenames and folder structure
- Corrected timestamps and tags written to output file metadata
- Source file cleanup with user choice
- Tag filtering in thumbnail grid
</success_criteria>

<output>
After completion, create `.planning/phases/07-output-generation-tagging/07-04-SUMMARY.md`
</output>
