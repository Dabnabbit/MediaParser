---
phase: 08-windows-portable-desktop-build
plan: 03
type: execute
wave: 2
depends_on:
  - "08-01"
  - "08-02"
files_modified:
  - scripts/build-windows.py
autonomous: true
requirements:
  - WIN-01
  - WIN-03

must_haves:
  truths:
    - "Build script runs on WSL2 and produces a Windows-ready ZIP"
    - "ZIP contains portable Python, ffmpeg, exiftool, all pip packages, and app code"
    - "Embeddable Python is correctly configured (stdlib extracted, ._pth modified, site-packages wired)"
    - "python-magic-bin replaces python-magic in the build (not both)"
    - "ExifTool windows_exiftool.txt is copied as exiftool.pl"
    - "Build uses .build-cache/ for download caching"
  artifacts:
    - path: "scripts/build-windows.py"
      provides: "Cross-build script for Windows portable package"
      min_lines: 200
  key_links:
    - from: "scripts/build-windows.py"
      to: "requirements.txt"
      via: "reads requirements, substitutes python-magic with python-magic-bin"
      pattern: "requirements\\.txt"
    - from: "scripts/build-windows.py"
      to: "exiftool_files/"
      via: "copies exiftool files to build output"
      pattern: "exiftool_files"
    - from: "scripts/build-windows.py"
      to: "build/MediaParser/"
      via: "assembles portable package directory structure"
      pattern: "build.*MediaParser"
---

<objective>
Create the cross-build script that runs on WSL2 and produces a complete Windows portable
ZIP package.

Purpose: This is the build toolchain that downloads Python embeddable, ffmpeg, all pip
packages as Windows wheels, assembles them with the app code, and produces the final
distributable ZIP. Users download this ZIP, extract, and double-click MediaParser.bat.

Output: scripts/build-windows.py that produces dist/MediaParser-Windows-vX.Y.Z.zip.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-windows-portable-desktop-build/08-RESEARCH.md
@.planning/phases/08-windows-portable-desktop-build/08-01-SUMMARY.md
@.planning/phases/08-windows-portable-desktop-build/08-02-SUMMARY.md
@requirements.txt
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scripts/build-windows.py cross-build script</name>
  <files>scripts/build-windows.py</files>
  <action>
Create `scripts/build-windows.py`. This script runs on WSL2/Linux and produces a Windows
portable package. Make it executable (`chmod +x`). Add shebang `#!/usr/bin/env python3`.

**CLI interface (argparse):**
- `--version VERSION` (required): Version string for the ZIP filename (e.g., 0.1.0)
- `--clean`: Remove build/ directory before building
- `--skip-download`: Skip downloading if .build-cache/ has files (for dev iteration)

**Constants at top of file:**
```python
PYTHON_VERSION = '3.12.10'
PYTHON_URL = f'https://www.python.org/ftp/python/{PYTHON_VERSION}/python-{PYTHON_VERSION}-embed-amd64.zip'
FFMPEG_URL = 'https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip'

BASE_DIR = Path(__file__).resolve().parent.parent  # Project root
CACHE_DIR = BASE_DIR / '.build-cache'
BUILD_DIR = BASE_DIR / 'build'
DIST_DIR = BASE_DIR / 'dist'
```

**Build steps (implement as separate functions, called from main()):**

**Step 1: Clean + create directories**
```python
def clean_build(app_dir):
    if app_dir.exists():
        shutil.rmtree(app_dir)
    app_dir.mkdir(parents=True)
```
Where `app_dir = BUILD_DIR / 'MediaParser'`.

**Step 2: setup_python(app_dir)**
Download Python embeddable ZIP to `.build-cache/`. Extract to `app_dir/tools/python/`.
Then:
- Extract inner `python312.zip` to `python312/` directory (CRITICAL for pickle)
- Delete `python312.zip` after extraction
- Write modified `python312._pth`:
  ```
  python312
  .
  Lib\site-packages
  import site
  ```
- Create `Lib/site-packages/` directory
- Create `Lib/site-packages/mediaparser.pth` containing `../../..`
  (3 levels up from site-packages points to MediaParser/ root -- this adds the
  app root to sys.path so `from app import create_app` works)

**Step 3: download_ffmpeg(app_dir)**
Download ffmpeg essentials ZIP to `.build-cache/`. Extract to temp location. Use
rglob to find `ffmpeg.exe` inside the nested directory structure (it's at
`ffmpeg-X.Y.Z-essentials_build/bin/ffmpeg.exe`). Copy just `ffmpeg.exe` to
`app_dir/tools/ffmpeg/ffmpeg.exe`. Clean up temp extraction.

**Step 4: setup_exiftool(app_dir)**
Copy from `BASE_DIR/exiftool_files/` to `app_dir/tools/exiftool/`:
- Copy ALL files and directories from exiftool_files/ EXCEPT:
  - Skip `windows_exiftool.txt` (will be renamed)
  - Skip `readme_windows.txt` (not needed at runtime)
  - Skip `Licenses_Strawberry_Perl.zip` (not needed at runtime, LICENSE file suffices)
- Copy `windows_exiftool.txt` as `exiftool.pl` (CRITICAL -- perl.exe looks for this name)
- Result: tools/exiftool/ contains perl.exe, perl532.dll, exiftool.pl, lib/, and DLLs

**Step 5: install_packages(app_dir)**
Read `requirements.txt` from project root. Parse package names (strip version specs).
Replace `python-magic` with `python-magic-bin`. Skip `pytest` (test-only dependency).

Download Windows wheels using host pip:
```python
subprocess.run([
    sys.executable, '-m', 'pip', 'download',
    '--only-binary=:all:',
    '--platform', 'win_amd64',
    '--python-version', '312',
    '--implementation', 'cp',
    '--no-deps',
    '--dest', str(wheels_dir),
] + packages, check=True)
```

ALSO download transitive dependencies not in requirements.txt:
```python
transitive = [
    'blinker', 'click', 'itsdangerous', 'jinja2', 'markupsafe',
    'greenlet', 'typing-extensions', 'mako', 'numpy', 'scipy', 'pywavelets',
]
```
Download these with the same pip download command to the same wheels_dir.

Install all wheels into site-packages:
```python
subprocess.run([
    sys.executable, '-m', 'pip', 'install',
    '--no-index',
    '--find-links', str(wheels_dir),
    '--target', str(site_packages),
    '--no-deps',
] + all_packages, check=True)
```

Where `site_packages = app_dir / 'tools' / 'python' / 'Lib' / 'site-packages'`
and `all_packages = packages + transitive` (deduplicated).

**Step 6: copy_app(app_dir)**
Copy application code and config files to app_dir:
- `app/` directory (recursive, exclude __pycache__)
- `alembic/` directory (recursive, exclude __pycache__)
- `alembic.ini`
- `run.py`
- `run_worker.py`
- `config.py`
- `huey_config.py`
- `launcher.py`
- `MediaParser.bat`

Use shutil.copytree with `ignore=shutil.ignore_patterns('__pycache__', '*.pyc')`.
For individual files, use shutil.copy2.

**Step 7: generate_env(app_dir)**
Generate a `.env` file in app_dir with:
```
SECRET_KEY={generated_random_hex_32}
FLASK_ENV=production
TIMEZONE=America/New_York
```
Use `secrets.token_hex(32)` for SECRET_KEY.

**Step 8: create_zip(app_dir, version)**
Create `dist/MediaParser-Windows-v{version}.zip`. The ZIP should contain a top-level
`MediaParser/` directory so extraction creates a single folder.
```python
DIST_DIR.mkdir(parents=True, exist_ok=True)
zip_path = DIST_DIR / f'MediaParser-Windows-v{version}.zip'
with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zf:
    for file_path in app_dir.rglob('*'):
        if file_path.is_file():
            arcname = file_path.relative_to(BUILD_DIR)
            zf.write(file_path, arcname)
```

**main() function:**
Print clear progress for each step:
```
MediaParser Windows Build
=========================
Version: {version}

[1/8] Cleaning build directory...
[2/8] Setting up Python {PYTHON_VERSION} embeddable...
[3/8] Downloading FFmpeg...
[4/8] Setting up ExifTool...
[5/8] Installing Python packages...
[6/8] Copying application code...
[7/8] Generating .env...
[8/8] Creating ZIP archive...

Build complete!
  Output: dist/MediaParser-Windows-v{version}.zip
  Size: {size_mb:.1f} MB
```

**download_with_cache(url, cache_path) utility:**
Check if `cache_path` exists. If so, print `[cache] {name}` and return. Otherwise
download via `urllib.request.urlretrieve(url, cache_path)` with a print.
Create CACHE_DIR if needed.

**Error handling:**
Wrap each step in try/except, print clear error message, exit with code 1 on failure.
Use `subprocess.run(..., check=True)` for pip commands so CalledProcessError propagates.
  </action>
  <verify>
Run: `cd /home/dab/Projects/MediaParser && .venv/bin/python -c "import ast; ast.parse(open('scripts/build-windows.py').read()); print('syntax OK')"`
Run: `.venv/bin/python scripts/build-windows.py --help` to confirm argparse works.
Run: `test -x scripts/build-windows.py && echo "executable" || echo "not executable"` (should be executable).
  </verify>
  <done>
scripts/build-windows.py exists, is executable, and has correct argparse interface
(--version required, --clean and --skip-download optional). Implements all 8 build steps:
clean, setup Python embeddable (with stdlib extraction and ._pth modification and
mediaparser.pth creation), download ffmpeg (with rglob for nested exe), setup exiftool
(with windows_exiftool.txt -> exiftool.pl rename), install packages (python-magic-bin
substitution, transitive deps, --target site-packages), copy app code, generate .env,
create ZIP. Uses .build-cache/ for download caching. Syntax-valid Python.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify build script with dry-run parse and package list validation</name>
  <files>scripts/build-windows.py</files>
  <action>
After creating the build script, perform these validation checks:

1. **Verify requirements.txt parsing:** Run a quick Python snippet that simulates
   the requirements parsing logic from the build script to confirm all packages
   are correctly identified and python-magic is replaced:
   ```python
   # Run inline test
   reqs = []
   with open('requirements.txt') as f:
       for line in f:
           line = line.strip()
           if not line or line.startswith('#'):
               continue
           pkg = line.split('>=')[0].split('==')[0].strip()
           if pkg == 'python-magic':
               reqs.append('python-magic-bin')
           elif pkg == 'pytest':
               continue
           else:
               reqs.append(pkg)
   print(f"Packages ({len(reqs)}):", reqs)
   assert 'python-magic-bin' in reqs, "python-magic-bin missing"
   assert 'python-magic' not in reqs, "python-magic should be replaced"
   assert 'pytest' not in reqs, "pytest should be skipped"
   assert 'flask' in reqs, "flask missing"
   print("All assertions pass")
   ```

2. **Verify transitive deps are complete:** Cross-reference the transitive deps list
   in the build script against what pip would resolve. The research confirmed these
   23 packages total (12 direct + 11 transitive). Verify no gaps.

3. **Verify exiftool_files/ contents match expectations:** Confirm perl.exe,
   perl532.dll, windows_exiftool.txt, lib/ all exist in exiftool_files/.

If any validation fails, fix the build script before completing.
  </action>
  <verify>
Run the inline requirements parsing test (above).
Run: `ls exiftool_files/perl.exe exiftool_files/perl532.dll exiftool_files/windows_exiftool.txt exiftool_files/lib/` all exist.
Run: `wc -l scripts/build-windows.py` should be >200 lines.
  </verify>
  <done>
Build script validated: requirements.txt parsing correctly substitutes python-magic-bin,
skips pytest. Transitive dependency list is complete (11 packages). ExifTool source files
verified present. Script is >200 lines with all 8 build steps implemented.
  </done>
</task>

</tasks>

<verification>
1. `python scripts/build-windows.py --help` shows --version, --clean, --skip-download
2. `python -c "import ast; ast.parse(open('scripts/build-windows.py').read())"` -- syntax valid
3. `grep 'python-magic-bin' scripts/build-windows.py` -- substitution present
4. `grep 'windows_exiftool.txt' scripts/build-windows.py` -- exiftool.pl rename present
5. `grep 'python312.zip' scripts/build-windows.py` -- stdlib extraction present
6. `grep 'mediaparser.pth' scripts/build-windows.py` -- app root path file present
7. `grep '\\._pth' scripts/build-windows.py` -- ._pth modification present
</verification>

<success_criteria>
- scripts/build-windows.py runs without error (--help) on WSL2
- Script downloads Python embeddable, ffmpeg, Windows wheels from PyPI
- Embeddable Python configured: stdlib extracted, ._pth modified, mediaparser.pth in site-packages
- python-magic replaced with python-magic-bin (not both)
- ExifTool copied with windows_exiftool.txt -> exiftool.pl rename
- App code, configs, alembic migrations copied (excluding __pycache__)
- .env generated with random SECRET_KEY
- Final ZIP at dist/MediaParser-Windows-v{version}.zip with correct structure
</success_criteria>

<output>
After completion, create `.planning/phases/08-windows-portable-desktop-build/08-03-SUMMARY.md`
</output>
