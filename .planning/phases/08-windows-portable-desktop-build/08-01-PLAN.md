---
phase: 08-windows-portable-desktop-build
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - run.py
  - app/routes/api.py
  - .gitignore
autonomous: true
requirements:
  - WIN-01
  - WIN-02

must_haves:
  truths:
    - "run.py accepts --host flag and binds to specified address"
    - "Worker health check detects running worker via PID env var on any OS"
    - "build/, dist/, .build-cache/ directories are gitignored"
  artifacts:
    - path: "run.py"
      provides: "--host argparse flag with default 0.0.0.0"
      contains: "--host"
    - path: "app/routes/api.py"
      provides: "PID-based worker health check branch"
      contains: "MEDIAPARSER_WORKER_PID"
    - path: ".gitignore"
      provides: "Build artifact exclusions"
      contains: "build/"
  key_links:
    - from: "launcher.py (Plan 02)"
      to: "run.py"
      via: "--host 127.0.0.1 argument"
      pattern: "--host.*127\\.0\\.0\\.1"
    - from: "launcher.py (Plan 02)"
      to: "app/routes/api.py"
      via: "MEDIAPARSER_WORKER_PID env var"
      pattern: "MEDIAPARSER_WORKER_PID"
---

<objective>
Prepare existing codebase for Windows portable build by adding the --host flag to run.py,
PID-based worker health check to api.py, and build directory gitignore entries.

Purpose: These are prerequisite modifications to existing files that the launcher (Plan 02)
and build script (Plan 03) depend on. Small, focused changes with no new files.

Output: Modified run.py, api.py, and .gitignore ready for launcher integration.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-windows-portable-desktop-build/08-RESEARCH.md
@run.py
@app/routes/api.py
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --host flag to run.py and PID health check to api.py</name>
  <files>run.py, app/routes/api.py</files>
  <action>
**run.py changes:**
Add `--host` argument to the argparse section (near `--port`):
```python
parser.add_argument('--host', default='0.0.0.0',
                    help='Host to bind to (default: 0.0.0.0)')
```
Then update BOTH `app.run()` calls (standalone and normal) to use `args.host` instead of
the hardcoded `'0.0.0.0'`:
```python
app.run(host=args.host, port=args.port, ...)
```
This allows the launcher to pass `--host 127.0.0.1` for localhost-only binding on desktop,
while preserving the existing default `0.0.0.0` for Docker/dev server use.

**app/routes/api.py changes:**
In the `check_worker_health()` function, add a PID-based check BETWEEN the standalone
consumer check and the pgrep block. After the `if consumer is not None:` block ends
(after line 139), and BEFORE the `# Try pgrep first` comment (line 141), insert:

```python
# PID-based check: launcher.py sets MEDIAPARSER_WORKER_PID env var
import os
worker_pid_str = os.environ.get('MEDIAPARSER_WORKER_PID')
if worker_pid_str:
    try:
        pid = int(worker_pid_str)
        os.kill(pid, 0)  # Signal 0 = existence check only (works on Windows too)
        return jsonify({'worker_alive': True, 'mode': 'pid', 'pid': pid})
    except (OSError, ProcessLookupError):
        return jsonify({
            'worker_alive': False,
            'error': f'Worker PID {pid} not found'
        }), 503
    except (ValueError, TypeError):
        pass  # Invalid PID string, fall through to pgrep
```

Move the `import os` to the top of the file if not already there (it is not currently
imported at module level in api.py). The `import subprocess` inside the pgrep block can
stay where it is (it's conditional).

Note: `os.kill(pid, 0)` works on Windows in Python 3 -- it checks process existence
without sending a signal. Raises OSError if process doesn't exist.
  </action>
  <verify>
Run: `cd /home/dab/Projects/MediaParser && .venv/bin/python -c "from app.routes.api import api_bp; print('api imports OK')"`
Run: `.venv/bin/python run.py --help` and confirm --host appears in output.
Run: `.venv/bin/python -c "import ast; ast.parse(open('run.py').read()); print('run.py syntax OK')"`
  </verify>
  <done>
run.py --help shows --host flag with default 0.0.0.0. api.py check_worker_health() has
PID check branch that reads MEDIAPARSER_WORKER_PID, uses os.kill(pid, 0), returns
appropriate JSON. Both files parse without syntax errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add build artifact directories to .gitignore</name>
  <files>.gitignore</files>
  <action>
Append these entries to the end of `.gitignore`:

```
# Build artifacts (Windows portable build)
build/
dist/
.build-cache/
```

Do NOT modify the existing `*.exe` entry. The `exiftool_files/perl.exe` is already
tracked by git (committed before the *.exe rule was added). The build output goes
into `build/` which is now gitignored. No conflict.

Verify that `exiftool_files/perl.exe` is still tracked:
```bash
git ls-files exiftool_files/perl.exe
```
If it returns the path, no action needed. If empty (not tracked), add
`!exiftool_files/perl.exe` exception -- but per research this should already be tracked.
  </action>
  <verify>
Run: `cd /home/dab/Projects/MediaParser && git ls-files exiftool_files/perl.exe` should return path.
Run: `grep -n 'build/' .gitignore` should show the new entry.
Run: `grep -n 'dist/' .gitignore` should show the new entry.
Run: `grep -n '.build-cache/' .gitignore` should show the new entry.
  </verify>
  <done>
.gitignore contains build/, dist/, .build-cache/ entries. exiftool_files/perl.exe
remains tracked by git. Existing *.exe rule unchanged.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/dab/Projects/MediaParser && .venv/bin/python run.py --help` shows --host and --port flags
2. `.venv/bin/python -c "from app.routes.api import api_bp; print('OK')"` imports cleanly
3. `grep 'MEDIAPARSER_WORKER_PID' app/routes/api.py` finds the PID check code
4. `grep 'build/' .gitignore` finds the new entry
5. Existing tests still pass: `.venv/bin/python -m pytest tests/ -x -q`
</verification>

<success_criteria>
- run.py accepts --host flag, defaults to 0.0.0.0, passes to app.run()
- api.py health check has 4-tier fallback: standalone -> PID -> pgrep -> Huey task
- .gitignore excludes build/, dist/, .build-cache/
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/08-windows-portable-desktop-build/08-01-SUMMARY.md`
</output>
