---
phase: 03-web-ui-upload-status
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/routes/api.py
  - app/routes/__init__.py
  - app/tasks.py
autonomous: true

must_haves:
  truths:
    - "Progress endpoint returns current job state"
    - "Thumbnails are generated during file processing"
    - "Thumbnail paths are stored in database"
  artifacts:
    - path: "app/routes/api.py"
      provides: "Progress polling endpoint"
      exports: ["api_bp"]
    - path: "app/tasks.py"
      provides: "Thumbnail generation integrated into processing"
      contains: "generate_thumbnail"
  key_links:
    - from: "app/routes/api.py"
      to: "app/models.py"
      via: "Job model query"
      pattern: "Job.query|db.session.get"
    - from: "app/tasks.py"
      to: "app/lib/thumbnail.py"
      via: "thumbnail generation import"
      pattern: "from app.lib.thumbnail import"
---

<objective>
Create progress polling endpoint and integrate thumbnail generation into the file processing pipeline.

Purpose: The progress endpoint enables the frontend to poll for job status updates (research recommended polling over SSE for v1 deployment simplicity). Thumbnail integration ensures images are ready for display when results load.

Output: Working progress API and thumbnails generated during background processing
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-web-ui-upload-status/03-CONTEXT.md
@.planning/phases/03-web-ui-upload-status/03-RESEARCH.md
@.planning/phases/02-background-workers-core-processing/02-03-SUMMARY.md

# Existing codebase
@app/__init__.py
@app/models.py
@app/tasks.py
@app/lib/thumbnail.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create progress polling endpoint</name>
  <files>
    app/routes/api.py
    app/routes/__init__.py
  </files>
  <action>
Create API blueprint with progress endpoint optimized for polling:

**app/routes/api.py:**
```python
"""API routes for progress tracking and general utilities."""
from flask import Blueprint, jsonify, current_app
from datetime import datetime, timezone

from app import db
from app.models import Job, JobStatus, File, ConfidenceLevel

api_bp = Blueprint('api', __name__, url_prefix='/api')


@api_bp.route('/progress/<int:job_id>', methods=['GET'])
def get_progress(job_id):
    """Get job progress for polling.

    Returns minimal payload optimized for frequent polling (1-2 second intervals).
    """
    job = db.session.get(Job, job_id)
    if not job:
        return jsonify({'error': 'Job not found'}), 404

    # Calculate progress percentage
    progress_percent = 0
    if job.progress_total > 0:
        progress_percent = round(job.progress_current / job.progress_total * 100, 1)

    # Calculate elapsed time and ETA
    elapsed_seconds = None
    eta_seconds = None
    if job.started_at:
        elapsed = datetime.now(timezone.utc) - job.started_at
        elapsed_seconds = int(elapsed.total_seconds())

        # Estimate remaining time based on progress
        if job.progress_current > 0 and job.status == JobStatus.RUNNING:
            seconds_per_file = elapsed_seconds / job.progress_current
            remaining_files = job.progress_total - job.progress_current
            eta_seconds = int(seconds_per_file * remaining_files)

    response = {
        'job_id': job.id,
        'status': job.status.value,
        'progress_current': job.progress_current,
        'progress_total': job.progress_total,
        'progress_percent': progress_percent,
        'current_filename': job.current_filename,
        'error_count': job.error_count,
        'elapsed_seconds': elapsed_seconds,
        'eta_seconds': eta_seconds,
    }

    # Include summary data when job completes
    if job.status in [JobStatus.COMPLETED, JobStatus.FAILED, JobStatus.HALTED, JobStatus.CANCELLED]:
        # Get file counts by confidence
        confidence_counts = {}
        for level in ConfidenceLevel:
            count = File.query.join(File.jobs).filter(
                Job.id == job_id,
                File.confidence == level
            ).count()
            confidence_counts[level.value] = count

        # Get duplicate count
        duplicate_count = db.session.execute(
            db.select(db.func.count(db.distinct(File.file_hash_sha256)))
            .join(File.jobs)
            .where(Job.id == job_id)
            .where(File.file_hash_sha256.isnot(None))
            .group_by(File.file_hash_sha256)
            .having(db.func.count(File.id) > 1)
        ).scalar() or 0

        response['summary'] = {
            'confidence_counts': confidence_counts,
            'duplicate_groups': duplicate_count,
            'success_count': job.progress_current - job.error_count,
            'error_count': job.error_count,
        }

        if job.completed_at and job.started_at:
            duration = job.completed_at - job.started_at
            response['summary']['duration_seconds'] = int(duration.total_seconds())

    return jsonify(response)


@api_bp.route('/current-job', methods=['GET'])
def get_current_job():
    """Get the most recent incomplete job for session resume.

    Returns the most recent job that is not completed/failed/cancelled.
    """
    job = Job.query.filter(
        Job.status.in_([JobStatus.PENDING, JobStatus.RUNNING, JobStatus.PAUSED])
    ).order_by(Job.created_at.desc()).first()

    if not job:
        return jsonify({'job_id': None})

    return jsonify({'job_id': job.id, 'status': job.status.value})
```

**Update app/routes/__init__.py** to export api_bp:
```python
"""Flask routes package."""
from app.routes.upload import upload_bp
from app.routes.jobs import jobs_bp
from app.routes.api import api_bp

__all__ = ['upload_bp', 'jobs_bp', 'api_bp']
```

**Update app/__init__.py** to register api_bp (add after other blueprint registrations).
  </action>
  <verify>
    python -c "from app.routes.api import api_bp; print('API blueprint OK')"
  </verify>
  <done>
    - api_bp has GET /api/progress/:id endpoint
    - api_bp has GET /api/current-job endpoint
    - Progress returns: status, progress_*, current_filename, elapsed, eta
    - Completed jobs include summary with confidence counts
    - api_bp registered in app/__init__.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate thumbnail generation into processing task</name>
  <files>app/tasks.py</files>
  <action>
Modify process_import_job in app/tasks.py to generate thumbnails during file processing.

**Changes to process_import_job:**

1. Import thumbnail library at top of file:
```python
from app.lib.thumbnail import generate_thumbnail
```

2. Get thumbnails directory from app config:
```python
thumbnails_dir = app.config.get('THUMBNAILS_FOLDER')
if not thumbnails_dir:
    thumbnails_dir = Path(app.config['UPLOAD_FOLDER']).parent / 'thumbnails'
    thumbnails_dir.mkdir(parents=True, exist_ok=True)
```

3. After processing each file successfully (after updating File record with hash/timestamp), generate thumbnail:
```python
# Inside the file processing loop, after updating file record with results
if result.get('success'):
    # Generate thumbnail for images
    file_path = Path(file.storage_path or file.original_path)
    if file_path.suffix.lower() in {'.jpg', '.jpeg', '.png', '.gif', '.heic'}:
        thumb_path = generate_thumbnail(
            source_path=file_path,
            thumb_dir=thumbnails_dir,
            size='medium',
            file_id=file.id
        )
        if thumb_path:
            file.thumbnail_path = str(thumb_path.relative_to(thumbnails_dir.parent))
```

4. Note: This requires adding thumbnail_path column to File model. Add to models.py:
```python
thumbnail_path: Mapped[Optional[str]] = mapped_column(String(500))  # Path to thumbnail
```

**Why generate during processing (not on-demand):**
- Research recommends: ~50ms per thumbnail, results display immediately when job completes
- For 10k files: adds ~8 minutes to total job time but eliminates wait when viewing
- On-demand would require async generation and loading states in UI

**Error handling:**
- Thumbnail failure should NOT fail the file processing
- Log warning and continue without thumbnail
- UI will show placeholder for files without thumbnails
  </action>
  <verify>
    python -c "from app.tasks import process_import_job; from app.lib.thumbnail import generate_thumbnail; print('Task imports OK')"
  </verify>
  <done>
    - app/tasks.py imports generate_thumbnail from app/lib/thumbnail
    - Thumbnail generated after successful file processing
    - Only generates for image files (jpg, jpeg, png, gif, heic)
    - thumbnail_path stored in File record
    - Thumbnail failures logged but don't fail processing
  </done>
</task>

<task type="auto">
  <name>Task 3: Add thumbnail_path column to File model</name>
  <files>app/models.py</files>
  <action>
Add thumbnail_path field to File model for storing generated thumbnail paths.

**Add to File model after output_path field:**
```python
# Thumbnail
thumbnail_path: Mapped[Optional[str]] = mapped_column(String(500))  # Relative path to thumbnail
```

This field stores the relative path to the generated thumbnail (relative to static directory for web serving).

**Note on database migration:**
- SQLite allows adding columns without migration for nullable fields
- db.create_all() will add the column on next app start
- For production, would use Alembic migration
  </action>
  <verify>
    python -c "from app.models import File; print('File model OK'); print('Has thumbnail_path:', hasattr(File, 'thumbnail_path'))"
  </verify>
  <done>
    - File model has thumbnail_path field
    - Field is Optional[str] with max length 500
    - Column will be created on next db.create_all()
  </done>
</task>

</tasks>

<verification>
1. API blueprint imports: `python -c "from app.routes.api import api_bp"`
2. App includes api routes: `python -c "from app import create_app; app = create_app(); print([r.rule for r in app.url_map.iter_rules() if 'progress' in r.rule or 'current' in r.rule])"`
3. Task imports thumbnail: `python -c "from app.tasks import process_import_job; print('OK')"`
4. File model has thumbnail_path: `python -c "from app.models import File; print(hasattr(File, 'thumbnail_path'))"`
</verification>

<success_criteria>
- /api/progress/:id returns job progress with elapsed time and ETA
- /api/current-job returns most recent incomplete job for session resume
- Completed jobs include summary data (confidence counts, duplicate count)
- Thumbnails generated during file processing for image files
- thumbnail_path field added to File model
- Thumbnail failures don't fail file processing
</success_criteria>

<output>
After completion, create `.planning/phases/03-web-ui-upload-status/03-03-SUMMARY.md`
</output>
