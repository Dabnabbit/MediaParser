---
phase: 03-web-ui-upload-status
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/templates/base.html
  - app/templates/index.html
  - app/static/css/main.css
  - app/lib/thumbnail.py
autonomous: true

must_haves:
  truths:
    - "HTML templates render without errors"
    - "CSS provides single-pane vertical layout"
    - "Thumbnail library generates correctly oriented thumbnails"
  artifacts:
    - path: "app/templates/base.html"
      provides: "Base HTML template with header, main content area"
      min_lines: 20
    - path: "app/templates/index.html"
      provides: "Single-pane layout with upload, progress, results sections"
      min_lines: 80
    - path: "app/static/css/main.css"
      provides: "Styles for upload box, progress bar, thumbnail grid, accordion"
      min_lines: 150
    - path: "app/lib/thumbnail.py"
      provides: "generate_thumbnail() function with EXIF orientation"
      exports: ["generate_thumbnail"]
  key_links:
    - from: "app/templates/index.html"
      to: "app/templates/base.html"
      via: "extends block"
      pattern: "extends.*base"
    - from: "app/lib/thumbnail.py"
      to: "PIL/Pillow"
      via: "ImageOps.exif_transpose"
      pattern: "exif_transpose"
---

<objective>
Create HTML templates, CSS styles, and thumbnail generation library for the Web UI foundation.

Purpose: Establishes the visual shell and thumbnail infrastructure that all subsequent plans depend on. Templates define the single-pane layout structure; CSS provides styling for upload, progress, and results sections; thumbnail library enables image preview generation during processing.

Output: base.html, index.html, main.css, and thumbnail.py ready for route and JavaScript integration
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-web-ui-upload-status/03-CONTEXT.md
@.planning/phases/03-web-ui-upload-status/03-RESEARCH.md

# Existing codebase
@app/__init__.py
@app/models.py
@config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HTML templates with single-pane layout</name>
  <files>
    app/templates/base.html
    app/templates/index.html
  </files>
  <action>
Create templates directory and base HTML structure:

**app/templates/base.html:**
- HTML5 doctype with proper meta tags (viewport, charset)
- Link to main.css stylesheet
- Script tags for upload.js, progress.js, results.js (defer loading)
- Header with app title "MediaParser"
- Main content block for child templates
- No external CDN dependencies (vanilla JS approach per research)

**app/templates/index.html:**
- Extends base.html
- Single-pane vertical layout with three main sections:

1. **Upload Section** (always visible at top):
   - Dedicated upload box (not full-page drop zone)
   - Text: "Drop files here or click to browse"
   - Two buttons: "Select Files" and "Select Folder"
   - Server path input field with "Import from path" button
   - Upload progress bar (hidden until upload starts)

2. **Progress Section** (hidden until job starts):
   - Job status badge (PENDING/RUNNING/COMPLETED/etc)
   - Progress bar with percentage
   - Metrics display: files processed/total, current filename, elapsed time, ETA
   - Error count badge (warning color when > 0)
   - Pause and Cancel buttons

3. **Results Section** (hidden until job completes):
   - Summary card: total files, success/error counts, time taken
   - Three expandable buckets (accordion style, only one open at a time):
     - HIGH confidence (green badge)
     - MEDIUM confidence (yellow badge)
     - LOW confidence (red badge)
   - Duplicate groups section
   - Failed files section
   - Thumbnail size toggle (compact/medium/large)

Use semantic HTML (section, article, header, etc). Add data attributes for JS targeting (data-section, data-bucket, etc). Include hidden file inputs for webkitdirectory support.
  </action>
  <verify>
    python -c "from flask import Flask, render_template; app = Flask(__name__, template_folder='app/templates'); app.config['TESTING'] = True;
with app.app_context():
    from flask import render_template_string
    import os
    base_exists = os.path.exists('app/templates/base.html')
    index_exists = os.path.exists('app/templates/index.html')
    print(f'base.html exists: {base_exists}')
    print(f'index.html exists: {index_exists}')"
  </verify>
  <done>
    - base.html has HTML5 structure, CSS link, JS script tags, content block
    - index.html has upload section, progress section, results section
    - Templates use extends/block pattern correctly
    - All sections have proper data attributes for JS targeting
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSS styles for all UI components</name>
  <files>app/static/css/main.css</files>
  <action>
Create static directory structure and comprehensive stylesheet:

**Layout:**
- Single-pane vertical flow, max-width container (1200px), centered
- Sections stack vertically with consistent spacing
- Mobile-responsive (media queries for smaller screens)

**Upload Box:**
- Dashed border box with rounded corners
- Hover/drag-over state (highlight border, slight background change)
- Drop zone visual feedback
- Button styling for file/folder selection

**Progress Display:**
- Progress bar with animated fill
- Metrics in grid layout (2x2 on desktop, 1 column on mobile)
- Status badges with color coding (RUNNING=blue, COMPLETED=green, FAILED=red, etc)
- Error count badge with warning styling

**Thumbnail Grid:**
- CSS Grid layout for responsive thumbnail display
- Three size classes: .thumb-compact (100px), .thumb-medium (150px), .thumb-large (200px)
- Thumbnail tiles with subtle border, hover effect
- Checkbox overlay for multi-select
- Selected state styling

**Accordion Buckets:**
- Collapsible sections using CSS (grid-template-rows transition)
- Bucket headers with confidence badge
- Only one bucket expanded at a time (controlled by JS toggling classes)
- Expanded bucket scrollable with max-height

**Duplicate Groups:**
- Side-by-side row layout for duplicate sets
- Card styling for each duplicate group
- "Recommended" badge styling

**Color Palette:**
- Use CSS variables for theming
- Confidence colors: HIGH=#22c55e (green), MEDIUM=#eab308 (yellow), LOW=#ef4444 (red)
- Status colors: RUNNING=#3b82f6, COMPLETED=#22c55e, FAILED=#ef4444, PAUSED=#f59e0b

**Buttons:**
- Primary (blue), Secondary (gray), Danger (red) button classes
- Disabled state styling
- Hover/active states
  </action>
  <verify>
    ls -la app/static/css/main.css && wc -l app/static/css/main.css
  </verify>
  <done>
    - main.css exists with 150+ lines
    - CSS variables defined for colors
    - All component styles present (upload, progress, grid, accordion)
    - Responsive breakpoints included
  </done>
</task>

<task type="auto">
  <name>Task 3: Create thumbnail generation library</name>
  <files>app/lib/thumbnail.py</files>
  <action>
Create thumbnail library following research patterns:

```python
"""Thumbnail generation utility for MediaParser.

Generates thumbnails with EXIF orientation correction using Pillow.
"""
from pathlib import Path
from typing import Optional, Tuple
import logging

from PIL import Image, ImageOps

logger = logging.getLogger(__name__)

# Default thumbnail sizes
SIZES = {
    'compact': (100, 100),
    'medium': (150, 150),
    'large': (200, 200),
}


def generate_thumbnail(
    source_path: Path | str,
    thumb_dir: Path | str,
    size: str | Tuple[int, int] = 'medium',
    file_id: Optional[int] = None
) -> Optional[Path]:
    """Generate thumbnail with EXIF orientation correction.

    Args:
        source_path: Path to source image file
        thumb_dir: Directory to save thumbnails
        size: Size preset ('compact', 'medium', 'large') or (width, height) tuple
        file_id: Optional file ID to use in thumbnail filename

    Returns:
        Path to generated thumbnail, or None on error
    """
    source_path = Path(source_path)
    thumb_dir = Path(thumb_dir)

    # Resolve size
    if isinstance(size, str):
        dimensions = SIZES.get(size, SIZES['medium'])
    else:
        dimensions = size

    try:
        # Ensure thumbnail directory exists
        thumb_dir.mkdir(parents=True, exist_ok=True)

        # Generate thumbnail filename
        if file_id:
            thumb_filename = f"{file_id}_thumb.jpg"
        else:
            thumb_filename = f"{source_path.stem}_thumb.jpg"
        thumb_path = thumb_dir / thumb_filename

        with Image.open(source_path) as img:
            # CRITICAL: Apply EXIF orientation before any processing
            img = ImageOps.exif_transpose(img)

            # Convert to RGB if needed (handles RGBA, P mode images)
            if img.mode in ('RGBA', 'P'):
                img = img.convert('RGB')

            # Create thumbnail (maintains aspect ratio)
            img.thumbnail(dimensions, Image.Resampling.LANCZOS)

            # Save with optimization
            img.save(thumb_path, 'JPEG', quality=85, optimize=True)

        return thumb_path

    except Exception as e:
        logger.error(f"Thumbnail generation failed for {source_path}: {e}")
        return None


def get_thumbnail_path(thumb_dir: Path | str, file_id: int) -> Optional[Path]:
    """Get path to existing thumbnail for a file.

    Args:
        thumb_dir: Thumbnail directory
        file_id: File database ID

    Returns:
        Path if thumbnail exists, None otherwise
    """
    thumb_path = Path(thumb_dir) / f"{file_id}_thumb.jpg"
    return thumb_path if thumb_path.exists() else None
```

Key implementation details:
- ALWAYS call ImageOps.exif_transpose() first (prevents rotated thumbnails)
- Convert RGBA/P mode to RGB (JPEG doesn't support transparency)
- Use LANCZOS resampling for quality
- Use file_id in filename for easy lookup
- Return None on error (don't raise, worker handles errors)
  </action>
  <verify>
    python -c "from app.lib.thumbnail import generate_thumbnail, get_thumbnail_path, SIZES; print('Imports OK'); print(f'Sizes: {SIZES}')"
  </verify>
  <done>
    - thumbnail.py exports generate_thumbnail, get_thumbnail_path, SIZES
    - Uses ImageOps.exif_transpose() for orientation correction
    - Supports size presets and custom dimensions
    - Handles RGB conversion for compatibility
    - Returns Path on success, None on error
  </done>
</task>

</tasks>

<verification>
1. Templates directory exists: `ls app/templates/`
2. Static directory exists: `ls app/static/css/`
3. Templates have correct structure: Check for extends, block, section elements
4. CSS has responsive breakpoints: grep for @media
5. Thumbnail library imports cleanly: python -c "from app.lib.thumbnail import generate_thumbnail"
</verification>

<success_criteria>
- app/templates/base.html exists with HTML5 structure and asset links
- app/templates/index.html has upload, progress, results sections
- app/static/css/main.css has 150+ lines with all component styles
- app/lib/thumbnail.py exports generate_thumbnail() that handles EXIF orientation
- All files are syntactically correct (no template or Python errors)
</success_criteria>

<output>
After completion, create `.planning/phases/03-web-ui-upload-status/03-01-SUMMARY.md`
</output>
