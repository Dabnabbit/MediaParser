---
phase: 06-duplicate-detection---perceptual
plan: 05
type: verify
wave: 4
depends_on: ["06-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Perceptual duplicate detection runs after file import and correctly groups near-identical images"
    - "Similar groups are displayed in the UI with correct type labels and navigation"
    - "Workflow enforcement prevents skipping duplicate/similar resolution"
    - "All resolution actions (keep, discard, keep-all, not-similar) work correctly"
    - "Existing exact duplicate detection still functions after schema migration"
    - "No regressions in upload, progress, review, or settings functionality"
  artifacts: []
  key_links: []
---

<objective>
Human verification of the complete Phase 6 implementation: perceptual duplicate detection, similar mode UI, workflow enforcement, and resolution actions. Test with real images to verify grouping accuracy and threshold calibration.

Purpose: Ensure the two-tier duplicate detection system works end-to-end with real media files, UI is intuitive, and no regressions exist in the existing workflow.

Output: Verified Phase 6 implementation. Issues documented if found.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/designs/duplicate-detection-system.md
@.planning/phases/06-duplicate-detection---perceptual/06-01-SUMMARY.md
@.planning/phases/06-duplicate-detection---perceptual/06-02-SUMMARY.md
@.planning/phases/06-duplicate-detection---perceptual/06-03-SUMMARY.md
@.planning/phases/06-duplicate-detection---perceptual/06-04-SUMMARY.md
</context>

<tasks>

<task type="human">
  <name>Task 1: Verify Schema Migration and Detection Pipeline</name>
  <action>
    Start Flask and Huey worker:
    ```bash
    cd /home/dab/Projects/MediaParser
    .venv/bin/flask run --debug
    # In another terminal:
    .venv/bin/huey_consumer huey_config.huey -w 2 -k thread
    ```

    **Test 1: Verify database schema**
    ```bash
    .venv/bin/python -c "
    import sqlite3
    conn = sqlite3.connect('instance/mediaparser.db')
    cols = [col[1] for col in conn.execute('PRAGMA table_info(files)').fetchall()]
    assert 'exact_group_id' in cols, 'Missing exact_group_id'
    assert 'similar_group_id' in cols, 'Missing similar_group_id'
    assert 'similar_group_type' in cols, 'Missing similar_group_type'
    assert 'duplicate_group_id' not in cols, 'Old field still exists'
    print('Schema OK:', [c for c in cols if 'group' in c or 'similar' in c])
    "
    ```

    **Test 2: Import test images**
    Prepare a test set with:
    - 2-3 identical files (different filenames) → should become exact SHA256 group
    - 2-3 copies of same image in different formats (JPG, PNG) → should become perceptual exact group
    - A burst sequence (4-5 similar photos taken rapidly) → should become similar group type='burst'
    - A few unrelated images → should not be grouped

    Import via the web UI and verify:
    - Processing completes without errors
    - Check Huey worker logs for "Detected X exact perceptual groups, Y similar groups across Z clusters"

    **Test 3: Verify detection results in database**
    ```bash
    .venv/bin/python -c "
    from app import create_app, db
    from app.models import File
    app = create_app()
    with app.app_context():
        files = File.query.all()
        for f in files:
            print(f'{f.original_filename}: exact={f.exact_group_id}, similar={f.similar_group_id} ({f.similar_group_type})')
    "
    ```
  </action>
  <verify>
    - SHA256 identical files grouped with same exact_group_id
    - Format conversions (JPG/PNG of same image) grouped with same exact_group_id (perceptual match)
    - Burst sequence grouped with same similar_group_id, type='burst'
    - Unrelated images have NULL group IDs
    - No processing errors in Huey logs
  </verify>
  <done>Detection pipeline correctly identifies exact duplicates, perceptual duplicates, and similar groups.</done>
</task>

<task type="human">
  <name>Task 2: Verify UI Modes and Workflow</name>
  <action>
    With test images imported and processed:

    **Test 1: Mode chip display**
    - Verify "Similar" chip appears between "Duplicates" and "Unreviewed"
    - Verify Similar chip shows correct count
    - Verify Duplicates chip shows correct count (SHA256 + perceptual exact groups)

    **Test 2: Workflow enforcement**
    - With duplicates present, try clicking "Similar" chip → should show warning
    - With duplicates present, try clicking "Unreviewed" chip → should show warning
    - Resolve all duplicate groups → Similar chip should auto-select
    - Resolve all similar groups → Unreviewed chip should auto-select

    **Test 3: Duplicates mode (existing functionality)**
    - Click into a duplicate group → viewport opens
    - "Keep This, Discard Others" works
    - "Not a Duplicate" works
    - Navigation through group members works
    - Grid updates after resolution

    **Test 4: Similar mode (new functionality)**
    - Switch to Similar mode
    - Click into a similar group → viewport opens
    - Group type badge (burst/panorama/similar) displays correctly
    - "Keep This, Discard Others" works
    - "Keep All" works (clears group without discarding)
    - "Not Similar" works (removes current file from group)
    - Navigation through similar group members works
    - Grid updates after resolution
  </action>
  <verify>
    - All modes display correct counts
    - Workflow enforcement warns on skip-ahead
    - Duplicate resolution works (no regression)
    - Similar resolution works (all three actions)
    - Grid refreshes correctly after each action
    - No JavaScript errors in browser console
  </verify>
  <done>UI modes and workflow enforcement work correctly. Similar mode provides intuitive resolution actions.</done>
</task>

<task type="human">
  <name>Task 3: Verify Summary API and Edge Cases</name>
  <action>
    **Test 1: Summary API**
    Open browser devtools, check network tab when page loads:
    - GET /api/jobs/:id/summary should return `similar_groups` count
    - GET /api/jobs/:id/similar-groups should return group details with type

    **Test 2: Edge cases**
    - File with no perceptual hash (e.g., video or corrupt image) → should be skipped in detection
    - File with no timestamp → should be skipped in clustering
    - Single file in group after others discarded → group should dissolve
    - Discard a file from similar group → similar_group_id cleared
    - Undiscard a file → similar_group_id stays NULL (documented limitation)

    **Test 3: Regression check**
    - Upload new files → processing works
    - Progress bar updates correctly
    - Settings page works
    - Theme switching works
    - Session resume works (refresh page, job resumes)
  </action>
  <verify>
    - Summary API returns correct counts
    - Edge cases handled gracefully (no crashes)
    - No regressions in existing functionality
  </verify>
  <done>Phase 6 implementation verified. Two-tier duplicate detection working end-to-end.</done>
</task>

</tasks>

<verification>
1. Schema migration applied correctly (no duplicate_group_id, has exact_group_id + similar fields)
2. Detection pipeline runs and groups files correctly
3. Similar mode chip visible with correct count
4. Workflow enforcement works (Duplicates → Similar → Unreviewed)
5. All resolution actions work in both modes
6. Summary API returns both group counts
7. No regressions in existing functionality
</verification>

<success_criteria>
- Detection algorithm correctly identifies near-duplicates and similar sequences
- UI provides intuitive workflow for resolving both group types
- No regressions in upload, progress, review, settings, or theme functionality
- Edge cases handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/06-duplicate-detection---perceptual/06-05-SUMMARY.md`
</output>
