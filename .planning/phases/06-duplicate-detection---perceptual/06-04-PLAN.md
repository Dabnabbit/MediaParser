---
phase: 06-duplicate-detection---perceptual
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - app/templates/index.html
  - app/static/js/filters.js
  - app/static/js/examination.js
  - app/static/js/viewport-details.js
  - app/static/js/viewport-controller.js
  - app/static/css/main.css
autonomous: true

must_haves:
  truths:
    - "Similar mode chip appears between Duplicates and Unreviewed in the mode selector"
    - "Similar mode chip shows count of files in similar groups"
    - "Duplicates mode must be resolved (count=0) before Similar mode is accessible"
    - "Similar mode must be resolved (count=0) before Unreviewed mode is accessible"
    - "Similar mode viewport shows checkbox-style actions (keep multiple) not radio-style"
    - "Similar group type (burst/panorama/similar) displayed in viewport details"
    - "Viewport navigation works for similar groups (prev/next through group members)"
  artifacts:
    - path: "app/templates/index.html"
      provides: "Similar mode chip in mode selector"
      contains: "data-mode=\"similar\""
    - path: "app/static/js/filters.js"
      provides: "Mode availability enforcement and similar mode support"
      contains: "similar"
    - path: "app/static/js/viewport-details.js"
      provides: "Similar mode action buttons (keep selected, keep all, not similar)"
      contains: "similar"
    - path: "app/static/js/examination.js"
      provides: "Similar group loading and navigation"
      contains: "similar_groups"
  key_links:
    - from: "app/static/js/filters.js"
      to: "app/static/js/results.js"
      via: "filterChange event triggers grid reload with mode='similar'"
      pattern: "filterChange"
    - from: "app/static/js/viewport-details.js"
      to: "app/routes/review.py"
      via: "POST /api/similar-groups/:id/resolve for multi-keep resolution"
      pattern: "similar-groups"
---

<objective>
Add the Similar mode to the UI: mode chip, workflow enforcement (Duplicates ‚Üí Similar ‚Üí Unreviewed), similar group viewport with checkbox-style selection, group type indicators, and similar group navigation. This is the main user-facing feature of Phase 6.

Purpose: Users need to review perceptually similar images (burst shots, panoramas, format conversions) and decide which to keep. Unlike exact duplicates (keep one), similar groups allow keeping multiple files.

Output: Complete Similar mode UI integrated with existing viewport system. Workflow enforces sequential resolution. Users can navigate, compare, and resolve similar groups.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/designs/duplicate-detection-system.md
@.planning/phases/06-duplicate-detection---perceptual/06-RESEARCH.md
@.planning/phases/06-duplicate-detection---perceptual/06-01-SUMMARY.md
@.planning/phases/06-duplicate-detection---perceptual/06-02-SUMMARY.md
@.planning/phases/06-duplicate-detection---perceptual/06-03-SUMMARY.md
@app/templates/index.html
@app/static/js/filters.js
@app/static/js/examination.js
@app/static/js/viewport-details.js
@app/static/js/viewport-controller.js
@app/static/css/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Similar Mode Chip + Workflow Enforcement</name>
  <files>
    app/templates/index.html
    app/static/js/filters.js
  </files>
  <action>
    **Part A: Add Similar mode chip to index.html**

    In the mode-selector div, add a new button BETWEEN the Duplicates and Unreviewed chips:

    ```html
    <button class="mode-chip" data-mode="similar">
        <span class="chip-icon">&#x2248;</span>
        <span class="chip-label">Similar</span>
        <span class="chip-count" data-count="similar">0</span>
    </button>
    ```

    The ‚âà symbol (&#x2248;) visually indicates "approximately equal" which maps well to perceptual similarity.

    **Part B: Update FilterHandler for workflow enforcement**

    In `app/static/js/filters.js`:

    1. Add 'similar' to the known modes and mode_totals handling

    2. Update `autoSelectMode()` to enforce sequential resolution:
    ```javascript
    autoSelectMode() {
        // Enforce: Duplicates ‚Üí Similar ‚Üí Unreviewed
        if (this.counts.duplicates > 0) {
            this.setMode('duplicates');
            return 'duplicates';
        }
        if (this.counts.similar > 0) {
            this.setMode('similar');
            return 'similar';
        }
        if (this.counts.unreviewed > 0) {
            this.setMode('unreviewed');
            return 'unreviewed';
        }
        this.setMode('reviewed');
        return 'reviewed';
    }
    ```

    3. Add mode availability enforcement in `setMode()`:
    ```javascript
    setMode(mode) {
        // Warn if trying to skip ahead
        if (mode === 'similar' && this.counts.duplicates > 0) {
            // Show toast: "Resolve duplicate groups first"
            // Still allow switching (don't block) but show warning
            this._showModeWarning('Resolve duplicate groups first for best results');
        }
        if (mode === 'unreviewed' && (this.counts.duplicates > 0 || this.counts.similar > 0)) {
            this._showModeWarning('Resolve duplicate and similar groups first for best results');
        }
        // ... existing setMode logic
    }
    ```

    4. Add `_showModeWarning(message)` helper that shows a brief toast notification (reuse existing toast pattern if available, or add a simple one).

    5. Update `updateCounts()` to handle the new 'similar' count from summary response.

    6. Add visual indicator for locked/available modes:
       - Modes with 0 count: dim but still clickable
       - Modes blocked by workflow: add a small lock icon or different opacity
       - Use CSS class `mode-chip--blocked` when prior modes have unresolved counts
  </action>
  <verify>
    - `grep "similar" /home/dab/Projects/MediaParser/app/templates/index.html` shows new mode chip
    - `grep "similar" /home/dab/Projects/MediaParser/app/static/js/filters.js` shows mode handling
    - `grep "autoSelectMode" /home/dab/Projects/MediaParser/app/static/js/filters.js` shows sequential enforcement
  </verify>
  <done>Similar mode chip visible in UI. Workflow enforces Duplicates ‚Üí Similar ‚Üí Unreviewed resolution order. Warning shown if user skips ahead.</done>
</task>

<task type="auto">
  <name>Task 2: Similar Group Loading + Viewport Navigation</name>
  <files>
    app/static/js/examination.js
    app/static/js/viewport-controller.js
  </files>
  <action>
    **Part A: Add similar group fetching to ExaminationDataService**

    In `app/static/js/examination.js`, add alongside the existing `fetchDuplicateGroups()`:

    ```javascript
    async fetchSimilarGroups(jobId) {
        const response = await fetch(`/api/jobs/${jobId}/similar-groups`);
        if (!response.ok) return [];
        const data = await response.json();
        this.similarGroups = data.similar_groups || [];
        return this.similarGroups;
    }

    findSimilarGroupForFile(fileId) {
        // Search cached similar groups
        for (const group of this.similarGroups) {
            if (group.files.some(f => f.id === fileId)) {
                return group;
            }
        }
        return null;
    }

    loadSimilarGroupForFile(fileId) {
        const group = this.findSimilarGroupForFile(fileId);
        if (!group) return null;
        return {
            files: group.files,
            group_id: group.group_id,
            group_type: group.group_type,
            confidence: group.confidence,
            recommended_id: group.recommended_id
        };
    }
    ```

    Add `this.similarGroups = []` to the constructor.

    **Part B: Update examination flow for similar mode**

    When a file is clicked in similar mode, the viewport should show the similar group members (similar to how duplicates mode shows the duplicate group members).

    In the examination handler or wherever `loadDuplicateGroup` is called for duplicates mode, add a parallel path:
    - If current mode is 'similar': call `loadSimilarGroupForFile(fileId)`
    - Use the returned files array as the navigable set for the viewport

    **Part C: Prefetch similar groups on mode switch**

    When the user switches to 'similar' mode (or it auto-selects):
    - Call `fetchSimilarGroups(jobId)` to cache similar group data
    - Similar to how duplicate groups are fetched when entering duplicates mode
    - This happens via the `filterChange` event handler

    **Part D: Viewport controller similar mode awareness**

    In `viewport-controller.js`, the `enter()` method receives a set of navigable IDs. For similar mode:
    - The navigable set should be the files within the similar group (not all files in the grid)
    - This follows the same pattern as duplicate mode navigation
    - Store the current similar group context (group_id, group_type) for action button rendering
  </action>
  <verify>
    - `grep "similarGroups" /home/dab/Projects/MediaParser/app/static/js/examination.js` shows similar group support
    - `grep "similar-groups" /home/dab/Projects/MediaParser/app/static/js/examination.js` shows API endpoint call
    - `grep "similar" /home/dab/Projects/MediaParser/app/static/js/viewport-controller.js` shows mode awareness
  </verify>
  <done>Similar groups fetched and cached. Viewport navigates through similar group members. Group context (type, confidence) available for action buttons.</done>
</task>

<task type="auto">
  <name>Task 3: Similar Mode Action Buttons + Resolution</name>
  <files>
    app/static/js/viewport-details.js
    app/static/css/main.css
  </files>
  <action>
    **Part A: Add similar mode actions to viewport-details.js**

    In `renderActionButtons()`, add a new branch for similar mode:

    ```javascript
    if (mode === 'similar' && isSimilar) {
        if (!isDiscarded) {
            html += `
                <div class="vp-similar-info">
                    <span class="similar-type-badge">${groupType}</span>
                    <span class="similar-confidence">${confidence} confidence</span>
                </div>
                <button id="vp-keep-similar" class="btn btn-primary">
                    Keep This, Discard Others
                </button>
                <button id="vp-keep-all-similar" class="btn btn-secondary">
                    Keep All
                </button>
                <button id="vp-not-similar" class="btn btn-secondary">
                    Not Similar
                </button>
                <button id="vp-discard" class="btn btn-danger">
                    Discard
                </button>
            `;
        } else {
            html += `
                <button id="vp-undiscard" class="btn btn-secondary">
                    Restore
                </button>
            `;
        }
    }
    ```

    Note: "Keep This, Discard Others" for similar mode works the same as duplicates mode (discard all others in group, keep current). But the future enhancement would allow multi-select within the viewport. For v1, per-file actions are sufficient since the user can navigate through each file and keep/discard individually.

    **Part B: Implement similar resolution actions**

    Add event handlers for the similar mode buttons:

    ```javascript
    async keepSimilar() {
        // Keep current file, discard all others in similar group
        const groupId = this.currentSimilarGroupId;
        const currentFileId = this.currentFileId;

        const response = await fetch(`/api/similar-groups/${groupId}/resolve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keep_file_ids: [currentFileId] })
        });

        if (response.ok) {
            this.showToast('Kept this file, discarded others');
            // Exit viewport and refresh grid
            this.exitAndRefresh();
        }
    }

    async keepAllSimilar() {
        // Mark all files as not similar (keep all, clear group)
        const groupId = this.currentSimilarGroupId;

        const response = await fetch(`/api/similar-groups/${groupId}/keep-all`, {
            method: 'POST'
        });

        if (response.ok) {
            this.showToast('All files kept');
            this.exitAndRefresh();
        }
    }

    async markNotSimilar() {
        // Remove current file from similar group
        const fileId = this.currentFileId;

        const response = await fetch('/api/files/bulk/not-similar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file_ids: [fileId] })
        });

        if (response.ok) {
            this.showToast('Removed from similar group');
            // Navigate to next file in group or exit if last
            this.navigateOrExit();
        }
    }
    ```

    **Part C: Display similar group type in viewport details**

    When showing file details in similar mode:
    - Show the group type badge (burst üî•, panorama üèîÔ∏è, similar ‚âà)
    - Show confidence level
    - Show position within group (e.g., "2 of 5 similar files")
    - Show timestamp gap between current and adjacent files (useful for burst/panorama identification)

    Use the file's `similar_group_type` field from the API response.

    **Part D: Wire up event listeners**

    In the action button setup (where keepDuplicate and markNotDuplicate are wired):
    - Add click handlers for `#vp-keep-similar`, `#vp-keep-all-similar`, `#vp-not-similar`
    - Route to the new methods above

    **Part E: Add CSS for similar mode UI elements**

    In `app/static/css/main.css`, add:

    ```css
    .similar-type-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: capitalize;
    }

    .similar-type-badge[data-type="burst"] {
        background: var(--accent-color);
        color: white;
    }

    .similar-type-badge[data-type="panorama"] {
        background: var(--confidence-medium);
        color: white;
    }

    .similar-type-badge[data-type="similar"] {
        background: var(--bg-hover);
        color: var(--text-secondary);
    }

    .mode-chip--warned {
        opacity: 0.7;
    }
    ```
  </action>
  <verify>
    - `grep "vp-keep-similar" /home/dab/Projects/MediaParser/app/static/js/viewport-details.js` shows similar mode buttons
    - `grep "similar-groups" /home/dab/Projects/MediaParser/app/static/js/viewport-details.js` shows API calls for resolution
    - `grep "similar-type-badge" /home/dab/Projects/MediaParser/app/static/css/main.css` shows styling
    - `cd /home/dab/Projects/MediaParser && .venv/bin/python -c "from app import create_app; app = create_app(); print('App OK')"` succeeds
  </verify>
  <done>Similar mode has full action buttons (keep/keep-all/not-similar/discard). Resolution calls new API endpoints. Group type badges display in viewport. CSS styles for similar mode elements.</done>
</task>

</tasks>

<verification>
1. Similar mode chip appears in mode selector between Duplicates and Unreviewed
2. Auto-select mode enforces: Duplicates ‚Üí Similar ‚Üí Unreviewed
3. Warning toast shown when skipping ahead
4. Similar groups loaded when entering similar mode
5. Viewport navigates through similar group members
6. Action buttons show correct options for similar mode (keep/keep-all/not-similar/discard)
7. Resolution actions call correct API endpoints
8. Group type (burst/panorama/similar) displayed in viewport
9. Flask app starts without errors
</verification>

<success_criteria>
- Similar mode fully integrated into mode selector
- Workflow enforcement prevents skipping ahead without warning
- Similar group viewport shows group type and confidence
- Per-file resolution actions work (keep, keep-all, not-similar, discard)
- Navigation through similar group members works
</success_criteria>

<output>
After completion, create `.planning/phases/06-duplicate-detection---perceptual/06-04-SUMMARY.md`
</output>
