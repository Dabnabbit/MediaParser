---
phase: 06-duplicate-detection---perceptual
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - alembic.ini
  - alembic/env.py
  - alembic/versions/001_phase6_perceptual_fields.py
  - app/models.py
  - app/routes/jobs.py
  - app/routes/review.py
  - app/tasks.py
  - app/static/js/viewport-details.js
  - app/static/js/selection.js
  - app/static/js/tile.js
  - app/static/js/results.js
  - app/static/js/examination.js
  - app/static/js/filters.js
  - app/templates/index.html
autonomous: true

must_haves:
  truths:
    - "Database schema has exact_group_id field (renamed from duplicate_group_id)"
    - "Database schema has exact_group_confidence, similar_group_id, similar_group_confidence, similar_group_type fields"
    - "All Python and JavaScript references use exact_group_id instead of duplicate_group_id"
    - "Existing duplicate detection still works after rename"
    - "Alembic migration infrastructure is set up for future schema changes"
  artifacts:
    - path: "app/models.py"
      provides: "Updated File model with exact_group_id and similar_group fields"
      contains: "exact_group_id"
    - path: "alembic.ini"
      provides: "Alembic configuration"
      contains: "sqlalchemy.url"
    - path: "alembic/env.py"
      provides: "Alembic environment for Flask-SQLAlchemy"
      contains: "target_metadata"
    - path: "alembic/versions/001_phase6_perceptual_fields.py"
      provides: "Migration script for field rename and new fields"
      contains: "batch_alter_table"
  key_links:
    - from: "app/models.py"
      to: "app/routes/jobs.py"
      via: "File.exact_group_id queries"
      pattern: "exact_group_id"
    - from: "app/models.py"
      to: "app/routes/review.py"
      via: "File.exact_group_id and similar_group_id updates"
      pattern: "exact_group_id"
---

<objective>
Set up Alembic database migration infrastructure, migrate the File model to rename duplicate_group_id to exact_group_id and add perceptual duplicate fields (exact_group_confidence, similar_group_id, similar_group_confidence, similar_group_type), then update ALL references throughout the codebase.

Purpose: Foundation for Phase 6 two-tier duplicate detection. The field rename separates exact (SHA256) duplicates from perceptual (similar) duplicates. The new fields store perceptual detection results.

Output: Working database with new schema, Alembic infrastructure for future migrations, all code updated to use new field names.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/designs/duplicate-detection-system.md
@.planning/phases/06-duplicate-detection---perceptual/06-RESEARCH.md
@app/models.py
@app/routes/jobs.py
@app/routes/review.py
@app/tasks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Alembic Setup + Database Migration</name>
  <files>
    requirements.txt
    alembic.ini
    alembic/env.py
    alembic/script.py.mako
    alembic/versions/001_phase6_perceptual_fields.py
  </files>
  <action>
    1. Add `alembic>=1.18.0` to requirements.txt and install: `.venv/bin/pip install alembic`

    2. Initialize Alembic: `.venv/bin/alembic init alembic`

    3. Configure `alembic.ini`:
       - Set `sqlalchemy.url = sqlite:///instance/mediaparser.db`

    4. Configure `alembic/env.py`:
       - Import the Flask app and models to get target_metadata
       - Use `from app import create_app, db` pattern
       - Set `target_metadata = db.metadata`
       - In `run_migrations_online()`, configure with `render_as_batch=True` for SQLite compatibility

    5. Create migration file `alembic/versions/001_phase6_perceptual_fields.py`:
       - Use `batch_alter_table('files')` context manager (CRITICAL for SQLite)
       - Rename `duplicate_group_id` -> `exact_group_id` (existing_type=sa.String(64))
       - Add `exact_group_confidence` column (sa.String(10), nullable=True) - store as string not Enum for SQLite simplicity
       - Add `similar_group_id` column (sa.String(64), nullable=True)
       - Add `similar_group_confidence` column (sa.String(10), nullable=True)
       - Add `similar_group_type` column (sa.String(20), nullable=True)
       - Create index `ix_files_similar_group_id` on `similar_group_id`
       - Include proper downgrade() that reverses all changes

    6. Run migration: `.venv/bin/alembic upgrade head`

    NOTE: Use String type for confidence columns (not SQLEnum) to avoid SQLite Enum complications. Store 'high', 'medium', 'low' as plain strings. The model can still use the ConfidenceLevel enum with proper conversion.
  </action>
  <verify>
    - `.venv/bin/alembic current` shows migration applied
    - `.venv/bin/python -c "import sqlite3; conn = sqlite3.connect('instance/mediaparser.db'); print([col[1] for col in conn.execute('PRAGMA table_info(files)').fetchall()])"` shows exact_group_id, exact_group_confidence, similar_group_id, similar_group_confidence, similar_group_type columns and NO duplicate_group_id column
  </verify>
  <done>Database has new schema with renamed and new columns. Alembic tracks migration state.</done>
</task>

<task type="auto">
  <name>Task 2: Update File Model + Rename All References</name>
  <files>
    app/models.py
    app/routes/jobs.py
    app/routes/review.py
    app/tasks.py
    app/static/js/viewport-details.js
    app/static/js/selection.js
    app/static/js/tile.js
    app/static/js/results.js
    app/static/js/examination.js
    app/static/js/filters.js
    app/templates/index.html
  </files>
  <action>
    **Part A: Update models.py**

    Replace the `duplicate_group_id` field with:
    ```python
    # Exact duplicate grouping (SHA256 match)
    exact_group_id: Mapped[Optional[str]] = mapped_column(String(64), index=True)
    exact_group_confidence: Mapped[Optional[str]] = mapped_column(String(10))  # 'high', 'medium', 'low'

    # Similar/sequence grouping (perceptual match)
    similar_group_id: Mapped[Optional[str]] = mapped_column(String(64), index=True)
    similar_group_confidence: Mapped[Optional[str]] = mapped_column(String(10))  # 'high', 'medium', 'low'
    similar_group_type: Mapped[Optional[str]] = mapped_column(String(20))  # 'burst', 'panorama', 'similar'
    ```

    **Part B: Rename all Python references (find-and-replace)**

    In `app/routes/jobs.py`:
    - Replace ALL `duplicate_group_id` with `exact_group_id` (approximately 10 occurrences)
    - Update `_serialize_file_extended()`: change `'is_duplicate': f.duplicate_group_id is not None` to `'is_duplicate': f.exact_group_id is not None`
    - Update mode filtering: 'duplicates' mode should filter on `exact_group_id` (not similar_group_id yet - that's a separate mode added later)
    - Update summary endpoint: 'duplicates' count should use `exact_group_id`

    In `app/routes/review.py`:
    - Replace ALL `duplicate_group_id` with `exact_group_id` (approximately 25 occurrences)
    - In `get_file_detail()`: also return `similar_group_id`, `similar_group_confidence`, `similar_group_type` in response
    - In `discard_file()`: also clear `similar_group_id` when discarding
    - In `undiscard_file()`: also re-evaluate similar_group_id (for now, just restore to None since re-detection happens at pipeline level)
    - In `bulk_discard()`: also clear `similar_group_id`
    - In `bulk_undiscard()`: similar_group_id stays None for now (re-detect would need pipeline re-run)
    - In `bulk_not_duplicate()`: also clear `similar_group_id` if present

    In `app/tasks.py`:
    - In `_mark_duplicate_groups()`: rename `duplicate_group_id` to `exact_group_id`
    - Also set `exact_group_confidence = 'high'` for all SHA256 matches (they are always high confidence)

    **Part C: Rename all JavaScript references**

    In `app/static/js/viewport-details.js`:
    - Replace `duplicate_group_id` with `exact_group_id` in all references
    - Also check for `similar_group_id` where appropriate for displaying group type

    In `app/static/js/selection.js`:
    - `is_duplicate` references can stay (serialized from backend as before)
    - If `duplicate_group` text appears, update it

    In `app/static/js/tile.js`:
    - `is_duplicate` references stay (serialized field)

    In `app/static/js/results.js`:
    - `is_duplicate` references stay

    In `app/static/js/examination.js`:
    - `duplicate_groups` references in loadDuplicateGroup can stay (endpoint returns this key)

    In `app/static/js/filters.js`:
    - No changes needed (uses mode names, not field names)

    **Part D: Verify the app still works**

    After all renames, verify:
    - Flask app starts without import errors
    - The existing SHA256 duplicate detection flow still functions
  </action>
  <verify>
    - `cd /home/dab/Projects/MediaParser && .venv/bin/python -c "from app import create_app; app = create_app(); print('App created OK')"` succeeds
    - `grep -r "duplicate_group_id" app/ --include="*.py" --include="*.js" --include="*.html" | grep -v ".pyc" | wc -l` returns 0 (no remaining old references)
    - `grep -r "exact_group_id" app/models.py` shows the new field
  </verify>
  <done>All Python and JS files use exact_group_id. New similar_group fields are in the model. Flask app starts without errors. No stale references to duplicate_group_id remain.</done>
</task>

</tasks>

<verification>
1. Database has correct schema: `exact_group_id`, `exact_group_confidence`, `similar_group_id`, `similar_group_confidence`, `similar_group_type`
2. No references to `duplicate_group_id` remain in Python, JS, or HTML files
3. Flask app starts and serves pages
4. Alembic can track future migrations
</verification>

<success_criteria>
- Alembic infrastructure set up and first migration applied
- File model has 5 new/renamed fields for two-tier duplicate detection
- All ~45 codebase references updated from duplicate_group_id to exact_group_id
- Application starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-duplicate-detection---perceptual/06-01-SUMMARY.md`
</output>
