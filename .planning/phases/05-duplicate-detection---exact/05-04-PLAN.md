---
phase: 05-duplicate-detection---exact
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - app/static/js/duplicates.js
  - app/static/js/filters.js
  - app/routes/review.py
autonomous: true

must_haves:
  truths:
    - "Duplicates mode shows duplicate comparison view instead of grid"
    - "Bulk confirm shows summary modal with keep/discard counts"
    - "User must confirm before any files are discarded"
    - "Filter counts update after duplicate resolution"
    - "Keep All endpoint clears duplicate_group_id from files"
  artifacts:
    - path: "app/routes/review.py"
      provides: "Keep All endpoint for duplicate groups"
      contains: "keep-all"
    - path: "app/static/js/duplicates.js"
      provides: "Bulk confirmation flow"
      contains: "confirmAllGroups"
    - path: "app/static/js/filters.js"
      provides: "Mode switching integration"
      contains: "duplicatesHandler"
  key_links:
    - from: "app/static/js/filters.js"
      to: "app/static/js/duplicates.js"
      via: "mode change handler"
      pattern: "duplicatesHandler.loadGroups"
    - from: "app/static/js/duplicates.js"
      to: "#duplicate-confirm-modal"
      via: "showModal call"
      pattern: "showModal"
---

<objective>
Wire the DuplicatesHandler to the mode filter system, add the bulk confirmation flow with summary modal, and create the backend endpoint for "Keep All" functionality.

Purpose: Complete the duplicate resolution workflow with proper integration and safety confirmations
Output: Fully integrated duplicate detection phase with multi-stage confirmation
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-duplicate-detection---exact/05-RESEARCH.md
@.planning/phases/05-duplicate-detection---exact/05-03-SUMMARY.md

@app/static/js/filters.js
@app/static/js/duplicates.js
@app/routes/review.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Keep All endpoint to review routes</name>
  <files>app/routes/review.py</files>
  <action>
Add a new endpoint to app/routes/review.py for marking all files in a duplicate group as "not duplicates":

```python
@review_bp.route('/api/duplicates/groups/<string:group_hash>/keep-all', methods=['POST'])
def keep_all_duplicates(group_hash):
    """
    Mark all files in a duplicate group as "keep all" (not duplicates).
    Clears duplicate_group_id from all files, effectively removing the group.

    Args:
        group_hash: The SHA256 hash identifying the duplicate group

    Returns:
        JSON with count of affected files
    """
```

Implementation:
1. Query all Files where duplicate_group_id == group_hash AND discarded == False
2. For each file, set duplicate_group_id = None
3. Create UserDecision records for each file:
   - decision_type: 'keep_all_duplicates'
   - decision_value: JSON with group_hash
4. Commit changes
5. Return JSON: { 'success': True, 'affected_count': N, 'group_hash': group_hash }

Handle errors:
- Return 404 if no files found with group_hash
- Log the action with file count
  </action>
  <verify>
grep -c "keep-all" /home/dab/Projects/MediaParser/app/routes/review.py && grep -c "keep_all_duplicates" /home/dab/Projects/MediaParser/app/routes/review.py
  </verify>
  <done>
POST /api/duplicates/groups/:hash/keep-all endpoint clears duplicate_group_id and records decisions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bulk confirmation flow to DuplicatesHandler</name>
  <files>app/static/js/duplicates.js</files>
  <action>
Add bulk confirmation methods to DuplicatesHandler:

1. `confirmAllGroups()`:
- Check for unresolved groups, show alert if any
- Calculate summary via getResolutionSummary()
- Populate confirmation modal:
  - #confirm-group-count: number of groups
  - #confirm-keep-count: number of files to keep
  - #confirm-discard-count: number of files to discard
- Show modal: document.getElementById('duplicate-confirm-modal').showModal()
- Store pending decision for executeDuplicateResolution()

2. `executeDuplicateResolution()`:
- Get pending decision (keepFileIds, discardFileIds)
- Call POST /api/files/bulk/discard with:
  - file_ids: discardFileIds
  - reason: 'duplicate_resolution'
- On success:
  - Close modal
  - Show success toast/alert
  - Reload groups (or clear resolved groups from UI)
  - Dispatch filterCountsUpdated event for mode totals refresh

3. `cancelConfirmation()`:
- Close modal
- Clear pending decision

4. Event listeners for confirmation modal:
```javascript
document.getElementById('confirm-execute')?.addEventListener('click', () => {
    this.executeDuplicateResolution();
});

document.getElementById('confirm-cancel')?.addEventListener('click', () => {
    this.cancelConfirmation();
});

// Also close on backdrop click
document.getElementById('duplicate-confirm-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'duplicate-confirm-modal') {
        this.cancelConfirmation();
    }
});
```

5. Wire Resolve All button:
```javascript
this.resolveAllBtn?.addEventListener('click', () => {
    this.confirmAllGroups();
});
```
  </action>
  <verify>
grep -c "confirmAllGroups" /home/dab/Projects/MediaParser/app/static/js/duplicates.js && grep -c "executeDuplicateResolution" /home/dab/Projects/MediaParser/app/static/js/duplicates.js
  </verify>
  <done>
Bulk confirmation flow shows summary modal, requires explicit confirm, executes discard API call
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate with mode filter system</name>
  <files>app/static/js/filters.js</files>
  <action>
Modify app/static/js/filters.js to integrate with DuplicatesHandler:

1. In setMode() method, add logic for 'duplicates' mode:
```javascript
setMode(mode) {
    // ... existing mode setting logic ...

    // Handle duplicates mode specially
    if (mode === 'duplicates') {
        // Hide unified grid, show duplicate groups container
        document.getElementById('unified-grid')?.style.display = 'none';
        document.getElementById('grid-controls')?.style.display = 'none';

        // Show and load duplicate groups
        if (window.duplicatesHandler) {
            window.duplicatesHandler.show();
            window.duplicatesHandler.loadGroups(window.resultsHandler?.jobId);
        }
    } else {
        // Show unified grid, hide duplicate groups
        document.getElementById('unified-grid')?.style.display = '';
        document.getElementById('grid-controls')?.style.display = '';

        if (window.duplicatesHandler) {
            window.duplicatesHandler.hide();
        }
    }

    // ... rest of existing logic ...
}
```

2. When mode changes FROM duplicates to another mode:
- Reload mode counts to reflect any resolutions made
- Dispatch filterChange event for grid reload

3. Add duplicatesHandler visibility check in loadSummary():
- If duplicates mode active and count becomes 0, auto-switch to unreviewed mode

4. Listen for custom events from duplicatesHandler:
```javascript
window.addEventListener('duplicateGroupResolved', (e) => {
    // Refresh mode counts
    this.loadSummary(window.resultsHandler?.jobId);
});
```
  </action>
  <verify>
grep -c "duplicatesHandler" /home/dab/Projects/MediaParser/app/static/js/filters.js
  </verify>
  <done>
Duplicates mode toggles between grid view and duplicate comparison view, mode counts refresh after resolution
  </done>
</task>

</tasks>

<verification>
1. Clicking "Duplicates" mode chip shows duplicate comparison cards
2. Clicking other mode chips returns to grid view
3. "Keep All" button removes group and clears duplicate_group_id
4. "Confirm All Selections" button shows modal with accurate counts
5. Modal confirmation executes bulk discard
6. Mode counts update after resolution
7. Auto-switch to Unreviewed mode when no duplicates remain
</verification>

<success_criteria>
- Complete duplicate resolution workflow from comparison to confirmation
- No files discarded without explicit user confirmation
- UserDecision records created for audit trail
- Mode filter system properly integrates duplicate view
- Filter counts accurate after resolutions
- Dark mode works throughout flow
</success_criteria>

<output>
After completion, create `.planning/phases/05-duplicate-detection---exact/05-04-SUMMARY.md`
</output>
