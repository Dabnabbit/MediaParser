---
phase: 05-duplicate-detection---exact
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - app/static/js/duplicates.js
autonomous: true

must_haves:
  truths:
    - "JavaScript handler renders duplicate groups from API"
    - "Radio button selections tracked per group"
    - "KEEP/DISCARD badges update on selection"
    - "Unresolved groups count displayed"
    - "Recommended file pre-selected by default"
  artifacts:
    - path: "app/static/js/duplicates.js"
      provides: "DuplicatesHandler class for group management"
      exports: ["DuplicatesHandler", "window.duplicatesHandler"]
      min_lines: 200
  key_links:
    - from: "app/static/js/duplicates.js"
      to: "/api/jobs/:id/duplicates"
      via: "fetch call"
      pattern: "fetch.*duplicates"
    - from: "app/static/js/duplicates.js"
      to: "app/templates/index.html"
      via: "DOM manipulation"
      pattern: "getElementById.*duplicate"
---

<objective>
Create the DuplicatesHandler JavaScript class to fetch duplicate groups from API, render comparison cards, track radio button selections, and manage resolution state.

Purpose: Enable interactive duplicate comparison and selection workflow
Output: Functional JavaScript handler for duplicate group management
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-duplicate-detection---exact/05-RESEARCH.md
@.planning/phases/05-duplicate-detection---exact/05-01-SUMMARY.md
@.planning/phases/05-duplicate-detection---exact/05-02-SUMMARY.md

@app/static/js/examination.js
@app/static/js/selection.js
@app/static/js/results.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DuplicatesHandler class core</name>
  <files>app/static/js/duplicates.js</files>
  <action>
Create app/static/js/duplicates.js with DuplicatesHandler class:

1. Class structure:
```javascript
class DuplicatesHandler {
    constructor() {
        this.jobId = null;
        this.groups = [];              // Array of duplicate groups from API
        this.groupSelections = new Map(); // hash -> selected file_id

        // Cache DOM elements
        this.container = document.getElementById('duplicate-groups-container');
        this.groupsList = document.getElementById('duplicate-groups-list');
        this.groupCountEl = document.getElementById('duplicates-group-count');
        this.fileCountEl = document.getElementById('duplicates-file-count');
        this.resolvedCountEl = document.getElementById('duplicates-resolved-count');
        this.resolveAllBtn = document.getElementById('btn-resolve-all');

        // Initialize lazy loader for thumbnails (same pattern as results.js)
        this.initLazyLoader();
        this.initEventListeners();
    }
}
```

2. Lazy loading implementation (reuse pattern from results.js):
```javascript
initLazyLoader() {
    this.lazyLoader = new IntersectionObserver(
        (entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        img.addEventListener('load', () => img.classList.add('loaded'));
                        img.addEventListener('error', () => {
                            img.src = '/static/img/placeholder.svg';
                        });
                    }
                    this.lazyLoader.unobserve(img);
                }
            });
        },
        { rootMargin: '100px' }
    );
}
```

3. Core methods:

`async loadGroups(jobId)`:
- Fetch from /api/jobs/{jobId}/duplicates
- Store groups array
- Initialize groupSelections with recommended_id for each group
- Call renderGroups()
- Call updateSummary()

`renderGroups()`:
- Clear groupsList innerHTML
- For each group, call renderGroup(group) and append result
- If no groups, show empty state message

`renderGroup(group)`:
- Create card element with class "duplicate-group-card"
- Add data-group-hash attribute
- Build header with file count and recommended badge
- Build files-comparison grid
- For each file, call renderFileOption(file, group)
- Add group actions (Confirm Selection, Keep All buttons)
- Return the card element

`renderFileOption(file, group)`:
- Create file-option div with data-file-id
- Add .recommended class if file.id === group.recommended_id
- Add thumbnail img with lazy loading using data-src attribute (NOT src)
- After creating img element, observe it with this.lazyLoader.observe(img)
- Add quality-metrics section:
  - Resolution: {width}x{height} ({resolution_mp}MP) or "Unknown"
  - File size: format as KB/MB
  - Format: uppercase mime type
  - Timestamp: formatted date or "Unknown"
- Add radio button: name="keep-{group.hash}" value="{file.id}"
- Pre-check radio if file.id === groupSelections.get(group.hash)
- Add status badge (KEEP/DISCARD based on selection)
- Return the element

`formatFileSize(bytes)`:
- Return human-readable size (KB, MB, GB)

`formatDate(isoString)`:
- Return formatted date or "Unknown"

4. initEventListeners():
- Delegate radio change events on groupsList
- Delegate click on .btn-confirm-group buttons
- Delegate click on .btn-keep-all buttons
- Listen for mode changes to show/hide container
  </action>
  <verify>
test -f /home/dab/Projects/MediaParser/app/static/js/duplicates.js && grep -c "class DuplicatesHandler" /home/dab/Projects/MediaParser/app/static/js/duplicates.js
  </verify>
  <done>
DuplicatesHandler class exists with loadGroups, renderGroups, renderGroup, renderFileOption methods and IntersectionObserver for lazy loading
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement selection state management</name>
  <files>app/static/js/duplicates.js</files>
  <action>
Add selection management methods to DuplicatesHandler:

1. `handleRadioChange(event)`:
- Extract group hash from radio name (name="keep-{hash}")
- Extract file_id from radio value
- Update groupSelections Map
- Call updateGroupPreview(groupHash)
- Call updateSummary()

2. `updateGroupPreview(groupHash)`:
- Find group card by data-group-hash
- Get selected file_id from groupSelections
- Update all file-option status badges:
  - Selected file: "KEEP" badge (green)
  - Other files: "DISCARD" badge (red)
- Add/remove .selected class on file-options
- Enable the group's confirm button if selection made

3. `updateSummary()`:
- Count total groups
- Count total files across all groups
- Count resolved groups (those with selection in groupSelections)
- Update DOM elements (groupCountEl, fileCountEl, resolvedCountEl)
- Enable/disable resolveAllBtn based on all groups resolved

4. `getUnresolvedGroups()`:
- Return array of group hashes without selection
- Used for validation before bulk confirm

5. `getResolutionSummary()`:
- Return object with:
  - keepFileIds: array of selected file IDs
  - discardFileIds: array of non-selected file IDs
  - groupCount: number of resolved groups

6. Event delegation setup in initEventListeners():
```javascript
this.groupsList?.addEventListener('change', (e) => {
    if (e.target.type === 'radio' && e.target.name.startsWith('keep-')) {
        this.handleRadioChange(e);
    }
});
```

7. Add window.duplicatesHandler = new DuplicatesHandler() at file end
  </action>
  <verify>
grep -c "handleRadioChange" /home/dab/Projects/MediaParser/app/static/js/duplicates.js && grep -c "groupSelections" /home/dab/Projects/MediaParser/app/static/js/duplicates.js
  </verify>
  <done>
Selection state management implemented with radio change handling, preview updates, and summary tracking
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Keep All and single group confirm</name>
  <files>app/static/js/duplicates.js</files>
  <action>
Add group action handlers to DuplicatesHandler:

1. `handleKeepAll(groupHash)`:
- Find the group by hash
- Mark all files as "keep" (remove from duplicate resolution)
- Call API to clear duplicate_group_id for all files in group:
  POST /api/duplicates/groups/{hash}/keep-all
- Remove the group card from DOM
- Remove from this.groups array
- Update summary

2. `handleConfirmGroup(groupHash)`:
- Validate selection exists for this group
- Get selected file_id
- Get discard file_ids (all others in group)
- Call API to discard non-selected files:
  POST /api/files/bulk/discard with file_ids and reason='duplicate_resolution'
- Update group card to show "Resolved" state
- Mark group as completed (add .resolved class)
- Dispatch custom event for filter count updates

3. Add event delegation in initEventListeners():
```javascript
this.groupsList?.addEventListener('click', (e) => {
    const keepAllBtn = e.target.closest('.btn-keep-all');
    if (keepAllBtn) {
        const groupHash = keepAllBtn.closest('.duplicate-group-card').dataset.groupHash;
        this.handleKeepAll(groupHash);
        return;
    }

    const confirmBtn = e.target.closest('.btn-confirm-group');
    if (confirmBtn) {
        const groupHash = confirmBtn.closest('.duplicate-group-card').dataset.groupHash;
        this.handleConfirmGroup(groupHash);
        return;
    }
});
```

4. Add show/hide methods:
`show()`: Set container display to block
`hide()`: Set container display to none
`isVisible()`: Return container display state
  </action>
  <verify>
grep -c "handleKeepAll" /home/dab/Projects/MediaParser/app/static/js/duplicates.js && grep -c "handleConfirmGroup" /home/dab/Projects/MediaParser/app/static/js/duplicates.js
  </verify>
  <done>
Keep All removes group from duplicate detection, Confirm Group discards non-selected files
  </done>
</task>

</tasks>

<verification>
1. JavaScript loads without syntax errors in browser console
2. DuplicatesHandler class instantiated as window.duplicatesHandler
3. loadGroups(jobId) fetches and renders duplicate groups
4. Radio button changes update selection state and UI
5. KEEP/DISCARD badges toggle correctly
6. Summary counts update as selections are made
7. Keep All and Confirm Group buttons functional
8. Thumbnails lazy load via IntersectionObserver (not loaded until scrolled into view)
</verification>

<success_criteria>
- Duplicate groups render with all quality metrics displayed
- Recommended file pre-selected and highlighted
- Radio selections properly scoped per group (no cross-group interference)
- Visual feedback immediate on selection change
- Group can be resolved individually or via "Keep All"
- Handler follows same patterns as examination.js and selection.js
- Lazy loading prevents loading all thumbnails at once (performance)
</success_criteria>

<output>
After completion, create `.planning/phases/05-duplicate-detection---exact/05-03-SUMMARY.md`
</output>
